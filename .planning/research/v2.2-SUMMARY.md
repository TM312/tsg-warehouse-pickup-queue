# v2.2 Polish & Bug Fixes Research Summary

**Project:** Warehouse Pickup Queue System
**Domain:** UI polish milestone (shadcn-vue, drag-and-drop, realtime sync)
**Researched:** 2026-02-03
**Confidence:** HIGH

## Executive Summary

This is a polish milestone addressing 6 targeted issues: Gates view "Open" button with external link icon, sidebar avatar/email layout improvements, tab badge visibility, unified table component with drag-and-drop, Now Processing idle state simplification, and refresh button removal. The research confirms all changes can be implemented using the existing stack with **no new dependencies required**.

The most substantial work is the unified table component (Issue #4). The project already has working drag-and-drop infrastructure via `@vueuse/integrations/useSortable` in `GateQueueList.vue`. The recommended approach creates a mode-based `QueueTable.vue` component that uses TanStack Table for structure while adding drag capability via useSortable on the tbody element. This consolidates the current `RequestsTable.vue` (sorting) and `GateQueueList.vue` (dragging) into a single component with a `mode` prop.

The key risk is the interaction between drag operations and Supabase Realtime updates. Three critical pitfalls require attention: (1) SortableJS DOM manipulation conflicting with Vue reactivity, (2) realtime updates arriving mid-drag causing broken state, and (3) optimistic updates creating echo conflicts. All have documented prevention patterns from existing codebase patterns and research.

## Key Findings

### Recommended Stack

No new dependencies needed. All 6 issues can be resolved with the existing installed packages.

**Core technologies (already installed):**
- `sortablejs` (^1.15.6): Drag-and-drop engine - proven in GateQueueList.vue
- `@vueuse/integrations` (^14.1.0): useSortable composable - provides Vue 3 integration
- `@tanstack/vue-table`: Table structure - used by RequestsTable.vue
- `lucide-vue-next`: Icons - ExternalLink, ChevronsUpDown, CircleDashed already available
- `shadcn-vue` components: Badge, Button (link variant), Sidebar, Table primitives

**Why no new libraries:**
- useSortable already handles table tbody elements (SortableJS native support)
- Adding vue-draggable-plus or similar would create inconsistency and bundle bloat
- Existing optimistic update pattern in GateQueueList.vue is production-proven

### Expected Features by Issue

**Issue #1 - Gates view "Open" button:**
- Replace button with anchor styled as link
- Add ExternalLink icon (3x3 for inline text)
- Use `target="_blank"` with `rel="noopener noreferrer"`

**Issue #2 - Sidebar avatar/email:**
- Use `SidebarMenuButton size="lg"` for two-line layout
- Grid container: display name (bold) + email (text-xs, muted)
- Switch ChevronUp to ChevronsUpDown
- Dropdown: `side="right"` desktop, `side="bottom"` mobile via `useSidebar().isMobile`

**Issue #3 - Tab badge visibility:**
- Replace `bg-muted` with `Badge variant="secondary"`
- Or use `bg-primary/10 text-primary` for brand-colored subtle badge
- Add `font-mono tabular-nums` to prevent layout shift on count changes

**Issue #4 - Unified table component:**
- Create `QueueTable.vue` with `mode: 'sort' | 'drag'` prop
- Sort mode: TanStack Table with sortable headers (All Requests tab)
- Drag mode: useSortable on tbody with drag handle column (Gate tabs)
- Keep modes mutually exclusive (no sort+drag combination)

**Issue #5 - Now Processing idle state:**
- Use `colspan` on TableCell for spanning columns
- Style: `text-muted-foreground italic text-center`
- Optional: CircleDashed icon as visual indicator

**Issue #6 - Remove refresh button:**
- Delete button from template
- Trust realtime subscriptions (already working)
- No code changes needed beyond removal

### Architecture Approach

The unified table follows a **mode-based component pattern** where a single `QueueTable.vue` component handles both sorting (All Requests) and drag-and-drop (Gate tabs) via a mode prop. This maintains TanStack Table as the structural foundation while layering useSortable for drag operations.

**Major components:**
1. `QueueTable.vue` - Unified table with mode='sort' or mode='drag'
2. `queueTableColumns.ts` - Separate column factory functions per mode
3. `DragHandleCell.vue` - Drag handle with data-drag-handle attribute
4. Modified `useRealtimeQueue.ts` - Drag-aware update handling

**Data flow:**
- Sort mode: Data flows directly from props to TanStack Table
- Drag mode: Local shallowRef copy for optimistic updates, emits reorder event
- Parent handles server sync via existing `useQueueActions().reorderQueue()`

### Critical Pitfalls

1. **Dual Source of Truth (SortableJS vs Vue)** - SortableJS manipulates DOM directly while Vue expects to control DOM via reactivity. **Prevention:** Use manual array splice with nextTick, never let SortableJS mutate reactive arrays directly.

2. **Realtime Update During Active Drag** - Supabase Realtime can deliver updates mid-drag, invalidating DOM references. **Prevention:** Track `isDragging` state, queue incoming payloads, process after drag completes.

3. **Optimistic Update Echo Conflict** - User reorder triggers optimistic update, then same change echoes back via realtime causing double-update flicker. **Prevention:** Track pending operations with expected state, skip payloads that match pending operations.

4. **Missing Keyboard Alternative** - Drag-only reordering violates WCAG 2.5.7. **Prevention:** Add arrow key handlers on drag handle (up/down to move items).

5. **Touch/Scroll Conflict on Mobile** - Touch drag can conflict with page scroll. **Prevention:** Use dedicated drag handle with 44x44px touch target, configure `delay: 150` and `delayOnTouchOnly: true`.

## Implications for Roadmap

Based on research, suggested phase structure:

### Phase 1: Quick Wins (Issues #1, #3, #6)
**Rationale:** Zero-risk changes, no architecture impact, immediate visual improvement
**Delivers:** External link styling, visible tab badges, cleaner UI (no refresh button)
**Addresses:** Issues that are single-file changes with no dependencies
**Avoids:** No pitfalls apply - these are straightforward styling changes

**Files to modify:**
- Gates view component (Issue #1)
- `staff/app/pages/index.vue` TabsTrigger badges (Issue #3)
- Dashboard template - remove refresh button (Issue #6)

### Phase 2: Sidebar NavUser Polish (Issue #2)
**Rationale:** Self-contained component change, follows documented shadcn-vue patterns
**Delivers:** Proper two-line avatar/email layout with responsive dropdown positioning
**Uses:** Existing shadcn-vue Sidebar components, useSidebar() composable
**Implements:** dashboard-01 block pattern from shadcn-vue docs

**Files to modify:**
- `staff/app/components/NavUser.vue`

### Phase 3: Now Processing Idle State (Issue #5)
**Rationale:** Simple conditional rendering, prepares for unified table
**Delivers:** Cleaner idle gate display in ProcessingGatesTable
**Avoids:** No pitfalls - straightforward template conditional

**Files to modify:**
- `staff/app/components/dashboard/ProcessingGatesTable.vue`

### Phase 4: Unified Table Component (Issue #4)
**Rationale:** Most complex change, requires careful integration of TanStack Table + useSortable
**Delivers:** Single QueueTable.vue component replacing RequestsTable + GateQueueList
**Uses:** TanStack Table, useSortable, existing optimistic update patterns
**Implements:** Mode-based architecture from ARCHITECTURE.md

**Avoids:**
- Pitfall #1 (Dual source of truth) - use manual splice + nextTick
- Pitfall #2 (Realtime during drag) - add drag-aware handling to useRealtimeQueue
- Pitfall #3 (Echo conflict) - track pending operations
- Pitfall #4 (Keyboard) - add arrow key handlers
- Pitfall #5 (Touch) - configure drag handle with delay

**Files to create:**
- `staff/app/components/dashboard/QueueTable.vue`
- `staff/app/components/dashboard/queueTableColumns.ts`
- `staff/app/components/dashboard/cells/DragHandleCell.vue`

**Files to modify:**
- `staff/app/pages/index.vue` - swap RequestsTable/GateQueueList for QueueTable
- `staff/app/composables/useRealtimeQueue.ts` - add drag-aware handling

**Files to deprecate (after migration):**
- `staff/app/components/dashboard/RequestsTable.vue`
- `staff/app/components/dashboard/GateQueueList.vue`

### Phase Ordering Rationale

- **Phases 1-3 before Phase 4:** Quick wins build confidence and reduce scope uncertainty before tackling the complex unified table
- **Phase 4 last:** Has the most dependencies and pitfalls, benefits from stable codebase
- **Issue #4 not split:** The unified table should be completed in one phase to avoid maintaining three table implementations temporarily

### Research Flags

Phases with standard patterns (skip research-phase):
- **Phase 1 (Quick Wins):** Well-documented, single-line changes
- **Phase 2 (NavUser):** Direct copy from shadcn-vue dashboard-01 pattern
- **Phase 3 (Idle State):** Simple conditional rendering

Phases potentially needing deeper research during planning:
- **Phase 4 (Unified Table):** Research is comprehensive but implementation may surface edge cases around TanStack Table + useSortable interaction. Consider a spike to validate tbody ref access on shadcn-vue TableBody component.

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | No new deps, all patterns verified in existing codebase |
| Features | HIGH | All 6 issues have clear implementation paths |
| Architecture | HIGH | Mode-based pattern follows existing GateQueueList patterns |
| Pitfalls | HIGH | Cross-referenced VueUse issues, WCAG docs, Pinia docs |

**Overall confidence:** HIGH

### Gaps to Address

- **TableBody ref access:** Need to verify `useTemplateRef` on shadcn-vue `TableBody` returns correct element for useSortable. May need `tbodyRef.value?.$el` or switch to native `<tbody>`.
- **Mobile touch testing:** Research documents patterns but actual iOS/Android testing needed during implementation.
- **Accessibility validation:** Keyboard reordering pattern documented but should be validated with screen reader.

## Sources

### Primary (HIGH confidence)
- [VueUse useSortable](https://vueuse.org/integrations/usesortable/) - Official documentation
- [TanStack Table Vue](https://tanstack.com/table/v8/docs/framework/vue/vue-table) - Official Vue adapter
- [shadcn-vue Sidebar](https://www.shadcn-vue.com/docs/components/sidebar) - NavUser patterns
- [shadcn-vue Badge](https://www.shadcn-vue.com/docs/components/badge) - Badge variants
- [WCAG 2.2 Understanding 2.5.7](https://www.w3.org/WAI/WCAG22/Understanding/dragging-movements.html) - Drag accessibility
- Existing codebase: `GateQueueList.vue`, `RequestsTable.vue`, `useQueueActions.ts`

### Secondary (MEDIUM confidence)
- [VueUse Issue #3727](https://github.com/vueuse/vueuse/issues/3727) - Reactivity/SortableJS conflict
- [SortableJS Features](https://github.com/SortableJS/Sortable#features) - tbody support confirmed
- [Pinia State Documentation](https://pinia.vuejs.org/core-concepts/state.html) - Store mutation patterns

### Tertiary (LOW confidence)
- [Supabase Discussion #1753](https://github.com/orgs/supabase/discussions/1753) - Optimistic update patterns (community discussion)

---
*Research completed: 2026-02-03*
*Ready for roadmap: yes*
