# Milestone v2.0: Architecture Overhaul

**Status:** SHIPPED 2026-02-03
**Phases:** 14-18
**Total Plans:** 19

## Overview

The v2.0 Architecture Overhaul transformed the staff application from an organically-grown codebase into a well-structured architecture. Starting with foundational type definitions, we built Pinia stores for centralized state management, implemented sidebar navigation for improved UX, created a dashboard with visualization, and completed with gate operator enhancements and bug fixes.

## Phases

### Phase 14: Type Foundation

**Goal**: All status values and data types are centrally defined with TypeScript constants
**Depends on**: Nothing (foundational phase)
**Plans**: 4 plans

Plans:
- [x] 14-01: Create centralized type definitions (staff + customer shared types)
- [x] 14-02: Migrate staff dashboard components
- [x] 14-03: Migrate staff pages and composables
- [x] 14-04: Migrate customer app files

**Details:**
- Created PICKUP_STATUS constant with `as const` pattern
- PickupStatus type derived from constant (single source of truth)
- ACTIVE_STATUSES and TERMINAL_STATUSES arrays for filtering
- Gate and GateWithCount interfaces
- Nuxt 4 auto-import via shared/types/ directory

### Phase 15: Pinia Infrastructure

**Goal**: Shared state is managed through Pinia stores with proper composable boundaries
**Depends on**: Phase 14 (types needed for store definitions)
**Plans**: 4 plans

Plans:
- [x] 15-01: Install @pinia/nuxt and configure Pinia
- [x] 15-02: Create queue and gates stores
- [x] 15-03: Refactor composables to use stores (hybrid pattern)
- [x] 15-04: Migrate pages to read from stores

**Details:**
- useQueueStore with requests state and computed getters (processingItems, inQueueItems, pendingItems)
- useGatesStore with gates state and computed getters (activeGates, sortedGates, sortedActiveGates)
- Hybrid pattern: stores own state, composables handle realtime/RPC side effects
- Setup store pattern with composition API

### Phase 16: Sidebar Layout

**Goal**: Staff app has consistent navigation via collapsible sidebar
**Depends on**: Phase 14 (can work in parallel with Phase 15)
**Plans**: 4 plans

Plans:
- [x] 16-01: Install shadcn-vue sidebar, avatar, dropdown-menu, tooltip components
- [x] 16-02: Create fullscreen layout and update gate page to use it
- [x] 16-03: Create AppSidebar and NavUser components
- [x] 16-04: Update default layout with sidebar structure

**Details:**
- SidebarProvider wrapper with collapsible sidebar
- AppSidebar with Dashboard, Gates, Schedule navigation
- NavUser with avatar and logout dropdown
- Fullscreen layout for gate operator (no sidebar)
- Mobile overlay drawer on small screens

### Phase 17: Dashboard & Visualization

**Goal**: Supervisors can see queue status at a glance via dashboard overview
**Depends on**: Phase 15 (stores), Phase 16 (layout)
**Plans**: 4 plans

Plans:
- [x] 17-01: Install chart dependencies and SSR plugin
- [x] 17-02: Create KPI composable and utilities
- [x] 17-03: Create dashboard UI components
- [x] 17-04: Integrate dashboard page

**Details:**
- @unovis/vue for chart visualization (shadcn-vue charts dependency)
- useDashboardKpis composable with 30s auto-refresh
- 4 KPI cards: Completed Today, Avg Wait Time, Avg Processing Time, Currently Waiting
- Bar chart showing queue length per gate
- SSR width plugin for hydration-safe responsive rendering

### Phase 18: Gate Operator & Bug Fixes

**Goal**: Gate operators can navigate between gates and filter bug is resolved
**Depends on**: Phase 16 (layout ensures gate routes remain fullscreen)
**Plans**: 3 plans

Plans:
- [x] 18-01: Create gate navigation composable and button component
- [x] 18-02: Fix filter toggle and mobile viewport bugs
- [x] 18-03: Integrate navigation into gate page and verify

**Details:**
- useGateNavigation composable with sortedActiveGates ordering
- GateNavButtons component with prev/next and keyboard shortcuts (arrow keys)
- Crossfade page transitions between gates (150ms)
- Fixed ShowCompletedToggle with defineModel pattern
- Fixed mobile viewport with svh unit

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Hybrid Pinia + composables | Stores for state, composables for side effects | Good |
| No sidebar on gate routes | Gate operators need simplified mobile view | Good |
| Gate navigation alphabetical | Consistent ordering for prev/next buttons | Good |
| Crossfade transitions | Simpler than slide, user preferred | Good |
| Index-based x-axis for charts | Unovis requires numeric x values for categories | Good |
| Solid hex colors for Unovis | CSS variables don't work in SVG fills | Good |

**Issues Resolved:**

- Filter toggle not updating queue display (v-model binding issue)
- Mobile viewport scrolling when content fits (svh unit fix)
- Chart bars not visible (multiple Unovis API fixes)
- Chart flickering on load (stable skeleton heights)

**Issues Deferred:**

- /gates list page not created (sidebar links to 404, gates accessible via dashboard tabs)
- Pinia module resolution errors in IDE (cosmetic, build works)
- native-select component TypeScript errors (pre-existing, cosmetic)

**Technical Debt Incurred:**

- None significant - all core requirements delivered

---

*For current project status, see .planning/ROADMAP.md (next milestone)*
*Archived: 2026-02-03*
