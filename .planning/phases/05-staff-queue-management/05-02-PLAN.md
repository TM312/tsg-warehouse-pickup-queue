---
phase: 05-staff-queue-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - staff/app/composables/useQueueActions.ts
  - staff/app/components/dashboard/GateSelect.vue
  - staff/app/components/dashboard/ActionButtons.vue
autonomous: true

must_haves:
  truths:
    - "useQueueActions provides assignGate, cancelRequest, completeRequest functions"
    - "GateSelect shows available gates with queue counts"
    - "ActionButtons shows Complete and Cancel with confirmation dialogs"
    - "Actions show loading spinner while processing"
  artifacts:
    - path: "staff/app/composables/useQueueActions.ts"
      provides: "Queue action mutations with toast feedback"
      exports: ["useQueueActions"]
    - path: "staff/app/components/dashboard/GateSelect.vue"
      provides: "Gate dropdown with queue counts"
      contains: "SelectTrigger"
    - path: "staff/app/components/dashboard/ActionButtons.vue"
      provides: "Complete and Cancel buttons with confirmations"
      contains: "AlertDialog"
  key_links:
    - from: "staff/app/composables/useQueueActions.ts"
      to: "supabase.rpc('assign_to_queue')"
      via: "Supabase RPC call"
      pattern: "rpc.*assign_to_queue"
    - from: "staff/app/components/dashboard/ActionButtons.vue"
      to: "@/components/ui/alert-dialog"
      via: "import AlertDialog"
      pattern: "import.*AlertDialog"
---

<objective>
Create the queue action composable and action UI components (GateSelect dropdown, ActionButtons with confirmations).

Purpose: Encapsulate all queue mutation logic with proper loading states and toast feedback. Provide reusable components for gate selection and action buttons.
Output: useQueueActions composable, GateSelect component, ActionButtons component.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-staff-queue-management/05-RESEARCH.md

# Reference existing patterns
@staff/app/components/dashboard/columns.ts
@staff/app/components/dashboard/StatusBadge.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useQueueActions composable</name>
  <files>staff/app/composables/useQueueActions.ts</files>
  <action>
Create staff/app/composables/useQueueActions.ts that exports useQueueActions function:

1. Import ref, readonly from vue
2. Import toast from vue-sonner

3. Create composable that uses useSupabaseClient() internally

4. Track loading state per request ID using ref<Record<string, boolean>>({})

5. Implement assignGate(requestId: string, gateId: string):
   - Set pending[requestId] = true
   - Call the database function via RPC:
     ```typescript
     const { data, error } = await client.rpc('assign_to_queue', {
       p_request_id: requestId,
       p_gate_id: gateId
     })
     if (error) throw error
     ```
   - On success: toast.success('Request added to queue')
   - On error: toast.error('Failed to assign gate'), rethrow
   - Finally: pending[requestId] = false
   - Return data (the queue position) from RPC result

6. Implement cancelRequest(requestId: string):
   - Set pending[requestId] = true
   - Update pickup_requests: status='cancelled', assigned_gate_id=null, queue_position=null
   - On success: toast.success('Request cancelled')
   - On error: toast.error('Failed to cancel request'), rethrow
   - Finally: pending[requestId] = false

7. Implement completeRequest(requestId: string):
   - Set pending[requestId] = true
   - Update pickup_requests: status='completed', completed_at=new Date().toISOString()
   - Keep assigned_gate_id and queue_position for history reference
   - On success: toast.success('Pickup marked complete')
   - On error: toast.error('Failed to complete pickup'), rethrow
   - Finally: pending[requestId] = false

8. Return { pending: readonly(pending), assignGate, cancelRequest, completeRequest }
  </action>
  <verify>
- File exists at staff/app/composables/useQueueActions.ts
- Contains export function useQueueActions
- Contains assignGate, cancelRequest, completeRequest functions
- Uses toast.success/error for feedback
- Tracks pending state per request ID
  </verify>
  <done>useQueueActions composable created with all queue mutations</done>
</task>

<task type="auto">
  <name>Task 2: Create GateSelect component</name>
  <files>staff/app/components/dashboard/GateSelect.vue</files>
  <action>
Create staff/app/components/dashboard/GateSelect.vue:

1. Script setup with TypeScript:
   - Import Select components from @/components/ui/select
   - Import Loader2 from lucide-vue-next

2. Define Gate interface:
   interface Gate {
     id: string
     gate_number: number
     queue_count: number
   }

3. Props:
   - gates: Gate[]
   - currentGateId: string | null (current assignment, can be null)
   - disabled?: boolean
   - loading?: boolean

4. Emits:
   - select: [gateId: string]

5. Template:
   - Select with model-value bound to currentGateId (use undefined if null)
   - Disabled when disabled or loading prop is true
   - On update:model-value, emit 'select' event
   - SelectTrigger with class="w-[160px]"
   - SelectValue with placeholder="Assign gate"
   - SelectContent with SelectItem for each gate:
     - value=gate.id
     - Display: "Gate {gate_number} ({queue_count})"
   - Show Loader2 spinner in trigger if loading

Use @click.stop on the SelectTrigger to prevent row click events from bubbling.
  </action>
  <verify>
- File exists at staff/app/components/dashboard/GateSelect.vue
- Uses shadcn-vue Select components
- Shows gate number and queue count
- Emits select event with gate ID
- Has @click.stop to prevent event bubbling
  </verify>
  <done>GateSelect component created with gate dropdown showing queue counts</done>
</task>

<task type="auto">
  <name>Task 3: Create ActionButtons component</name>
  <files>staff/app/components/dashboard/ActionButtons.vue</files>
  <action>
Create staff/app/components/dashboard/ActionButtons.vue:

1. Script setup with TypeScript:
   - Import AlertDialog components from @/components/ui/alert-dialog
   - Import Button from @/components/ui/button
   - Import Check, X, Loader2 from lucide-vue-next

2. Props:
   - status: 'pending' | 'approved' | 'in_queue' | 'completed' | 'cancelled'
   - loading?: boolean

3. Emits:
   - complete: []
   - cancel: []

4. Computed visibility:
   - showComplete: status === 'in_queue'
   - showCancel: status is 'pending', 'approved', or 'in_queue'

5. Complete button (wrapped in AlertDialog):
   - AlertDialogTrigger wraps Button with variant="outline" size="sm"
   - Button shows Loader2 spinning if loading, else Check icon
   - Button text: "Complete"
   - @click.stop on button to prevent row click
   - AlertDialogContent with title "Mark pickup as complete?"
   - Description: "This will complete the pickup and remove it from the active queue."
   - AlertDialogCancel: "Cancel"
   - AlertDialogAction @click="$emit('complete')": "Mark Complete"

6. Cancel button (wrapped in AlertDialog):
   - Similar pattern with X icon
   - variant="ghost" for less emphasis
   - AlertDialog title: "Cancel this pickup request?"
   - Description: "This will remove the customer from the queue. This action cannot be undone."
   - AlertDialogCancel: "No, keep it"
   - AlertDialogAction @click="$emit('cancel')" with variant="destructive": "Yes, cancel"

7. Template:
   - Wrap both buttons in a div with class="flex gap-2"
   - Use v-if for conditional rendering based on showComplete/showCancel
   - Both buttons disabled when loading
  </action>
  <verify>
- File exists at staff/app/components/dashboard/ActionButtons.vue
- Contains Complete button with AlertDialog confirmation
- Contains Cancel button with AlertDialog confirmation
- Uses @click.stop on buttons
- Shows loading spinner when loading prop is true
- Conditionally shows buttons based on status
  </verify>
  <done>ActionButtons component created with confirmation dialogs</done>
</task>

</tasks>

<verification>
1. useQueueActions composable exists and exports all three functions
2. GateSelect shows dropdown with gate options
3. ActionButtons shows contextual buttons with confirmations
4. All components use @click.stop to prevent row click bubbling
5. Loading states work correctly
</verification>

<success_criteria>
- Composable provides mutation functions with toast feedback
- GateSelect allows gate selection with queue count display
- ActionButtons shows appropriate buttons per status with confirmations
- No TypeScript errors in new files
</success_criteria>

<output>
After completion, create `.planning/phases/05-staff-queue-management/05-02-SUMMARY.md`
</output>
