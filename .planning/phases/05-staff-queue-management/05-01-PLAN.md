---
phase: 05-staff-queue-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260129000000_add_queue_functions.sql
  - staff/app/app.vue
  - staff/app/components/ui/select/*
  - staff/app/components/ui/alert-dialog/*
  - staff/app/components/ui/tabs/*
  - staff/app/components/ui/sheet/*
  - staff/app/components/ui/sonner/*
  - staff/package.json
autonomous: true

must_haves:
  truths:
    - "Database function assign_to_queue exists and returns queue position"
    - "Toast notifications appear when triggered via toast()"
    - "shadcn-vue Select, AlertDialog, Tabs, Sheet components are available"
  artifacts:
    - path: "supabase/migrations/20260129000000_add_queue_functions.sql"
      provides: "Atomic queue position assignment function"
      contains: "CREATE OR REPLACE FUNCTION assign_to_queue"
    - path: "staff/app/app.vue"
      provides: "Toaster component for toast notifications"
      contains: "Toaster"
    - path: "staff/app/components/ui/select/index.ts"
      provides: "Select component exports"
    - path: "staff/app/components/ui/alert-dialog/index.ts"
      provides: "AlertDialog component exports"
    - path: "staff/app/components/ui/tabs/index.ts"
      provides: "Tabs component exports"
    - path: "staff/app/components/ui/sheet/index.ts"
      provides: "Sheet component exports"
  key_links:
    - from: "staff/app/app.vue"
      to: "@/components/ui/sonner"
      via: "import Toaster"
      pattern: "import.*Toaster.*from.*sonner"
---

<objective>
Install foundation for Phase 5 queue management: database function for atomic queue assignment and all required UI components (vue-sonner, Select, AlertDialog, Tabs, Sheet, Sonner).

Purpose: Provide the building blocks for queue actions - atomic database operations prevent race conditions, UI components enable confirmations, dropdowns, and feedback.
Output: Database migration file, installed npm packages, shadcn-vue components, Toaster wired in app.vue.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-staff-queue-management/05-RESEARCH.md

# Phase 4 established the DataTable pattern
@staff/app/app.vue
@supabase/migrations/20260128000002_create_pickup_requests_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create atomic queue assignment database function</name>
  <files>supabase/migrations/20260129000000_add_queue_functions.sql</files>
  <action>
Create a new migration file that adds a Postgres function `assign_to_queue(p_request_id uuid, p_gate_id uuid)` that:
1. Updates the pickup_request in a single statement to prevent race conditions
2. Sets assigned_gate_id to the provided gate
3. Sets status to 'in_queue'
4. Calculates queue_position as MAX(queue_position) + 1 for that gate's in_queue requests
5. Only allows transition if current status is 'pending' or 'approved'
6. Returns the new queue_position integer

Use COALESCE for the MAX to handle empty queues (returns 0, so first position is 1).

Grant execute to authenticated role.
  </action>
  <verify>
Review the SQL file exists and contains:
- CREATE OR REPLACE FUNCTION assign_to_queue
- Single UPDATE statement with subquery for position
- WHERE status IN ('pending', 'approved')
- RETURNING clause
- GRANT EXECUTE to authenticated
  </verify>
  <done>Migration file exists with atomic queue assignment function</done>
</task>

<task type="auto">
  <name>Task 2: Install vue-sonner and add shadcn-vue components</name>
  <files>staff/package.json, staff/app/components/ui/select/*, staff/app/components/ui/alert-dialog/*, staff/app/components/ui/tabs/*, staff/app/components/ui/sheet/*, staff/app/components/ui/sonner/*</files>
  <action>
From the staff/ directory:

1. Install vue-sonner:
   pnpm add vue-sonner

2. Add shadcn-vue components (these will create files in components/ui/):
   pnpm dlx shadcn-vue@latest add select alert-dialog tabs sheet sonner

This adds:
- Select (for gate dropdown)
- AlertDialog (for confirmations)
- Tabs (for Active/History)
- Sheet (for detail panel)
- Sonner (toast wrapper component)
  </action>
  <verify>
- pnpm list vue-sonner shows installed
- ls staff/app/components/ui/select/ shows component files
- ls staff/app/components/ui/alert-dialog/ shows component files
- ls staff/app/components/ui/tabs/ shows component files
- ls staff/app/components/ui/sheet/ shows component files
- ls staff/app/components/ui/sonner/ shows component files
  </verify>
  <done>vue-sonner and all shadcn-vue components installed</done>
</task>

<task type="auto">
  <name>Task 3: Wire Toaster in app.vue</name>
  <files>staff/app/app.vue</files>
  <action>
Update app.vue to import and render the Toaster component from shadcn-vue sonner:

1. Add script setup with import:
   import { Toaster } from '@/components/ui/sonner'

2. Add Toaster component after NuxtLayout in template:
   <Toaster position="top-right" />

This enables toast() calls from anywhere in the app to display notifications.
  </action>
  <verify>
- cat staff/app/app.vue shows Toaster import
- cat staff/app/app.vue shows <Toaster position="top-right" />
- pnpm dev runs without errors (quick check)
  </verify>
  <done>Toaster component wired in app.vue, ready for toast notifications</done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260129000000_add_queue_functions.sql
2. Function uses single UPDATE statement with position subquery
3. All UI components installed (select, alert-dialog, tabs, sheet, sonner)
4. Toaster rendered in app.vue
5. Dev server starts without errors
</verification>

<success_criteria>
- Database function for atomic queue assignment is ready
- All required shadcn-vue components available for use
- Toast infrastructure in place
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-staff-queue-management/05-01-SUMMARY.md`
</output>
