---
phase: 05-staff-queue-management
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - staff/app/pages/index.vue
  - staff/app/components/dashboard/columns.ts
  - staff/app/components/dashboard/DataTable.vue
  - staff/app/components/dashboard/RequestDetail.vue
autonomous: true

must_haves:
  truths:
    - "Dashboard shows Active Queue and History tabs"
    - "Staff can assign a gate to a pending request (adds to queue)"
    - "Staff can cancel a request"
    - "Staff can mark an in-queue pickup as complete"
    - "Clicking a row opens detail panel"
    - "Status transitions are reflected immediately in the dashboard"
  artifacts:
    - path: "staff/app/pages/index.vue"
      provides: "Dashboard with tabs, sheet, and queue actions"
      contains: ["Tabs", "Sheet", "useQueueActions"]
    - path: "staff/app/components/dashboard/columns.ts"
      provides: "Column definitions with Gate and Actions columns"
      contains: ["GateSelect", "ActionButtons"]
    - path: "staff/app/components/dashboard/DataTable.vue"
      provides: "DataTable with row click handler"
      contains: "row-click"
    - path: "staff/app/components/dashboard/RequestDetail.vue"
      provides: "Detail panel content for Sheet"
      contains: "SheetHeader"
  key_links:
    - from: "staff/app/pages/index.vue"
      to: "useQueueActions"
      via: "composable import"
      pattern: "useQueueActions"
    - from: "staff/app/components/dashboard/columns.ts"
      to: "GateSelect"
      via: "h() render function"
      pattern: "h\\(GateSelect"
    - from: "staff/app/pages/index.vue"
      to: "@/components/ui/sheet"
      via: "import Sheet"
      pattern: "import.*Sheet"
---

<objective>
Integrate all queue management features into the dashboard: Tabs for Active/History views, Gate and Actions columns in table, row click to open detail Sheet, and wire all queue actions.

Purpose: Enable staff to process pickup requests through the complete workflow - assign gates, cancel requests, and mark pickups complete.
Output: Fully functional queue management dashboard with tabs, actions, and detail panel.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-staff-queue-management/05-RESEARCH.md

# These files will be modified
@staff/app/pages/index.vue
@staff/app/components/dashboard/columns.ts
@staff/app/components/dashboard/DataTable.vue

# Reference existing components
@staff/app/components/dashboard/StatusBadge.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update DataTable with row click handler</name>
  <files>staff/app/components/dashboard/DataTable.vue</files>
  <action>
Update staff/app/components/dashboard/DataTable.vue to emit row-click events:

1. Add emit declaration:
   const emit = defineEmits<{
     'row-click': [row: TData]
   }>()

2. Update TableRow in the template:
   - Add class="cursor-pointer hover:bg-muted/50" for visual feedback
   - Add @click="emit('row-click', row.original)"
   - Keep existing :class binding for highlighting

This allows parent components to handle row clicks (e.g., opening detail panel).
  </action>
  <verify>
- DataTable.vue contains defineEmits with row-click
- TableRow has @click handler
- TableRow has cursor-pointer class
  </verify>
  <done>DataTable emits row-click events when rows are clicked</done>
</task>

<task type="auto">
  <name>Task 2: Update columns.ts with Gate and Actions columns</name>
  <files>staff/app/components/dashboard/columns.ts</files>
  <action>
Update staff/app/components/dashboard/columns.ts:

1. Add imports at top:
   import GateSelect from './GateSelect.vue'
   import ActionButtons from './ActionButtons.vue'

2. Expand PickupRequest interface to include gate relation:
   Add: gate?: { id: string; gate_number: number } | null

3. Create a new function to generate columns that accepts callbacks:

   export interface ColumnCallbacks {
     gates: Array<{ id: string; gate_number: number; queue_count: number }>
     pendingIds: Record<string, boolean>
     onGateSelect: (requestId: string, gateId: string) => void
     onComplete: (requestId: string) => void
     onCancel: (requestId: string) => void
   }

   export function createColumns(callbacks: ColumnCallbacks): ColumnDef<PickupRequest>[]

4. Update the Gate column (id: 'gate'):
   - Replace the simple text display with GateSelect component using h()
   - Pass gates, currentGateId (from row.original.assigned_gate_id), loading (from callbacks.pendingIds[row.original.id])
   - Wire onSelect to call callbacks.onGateSelect(row.original.id, gateId)
   - Only show GateSelect for pending/approved/in_queue status
   - For completed/cancelled, show static "Gate X" or "-"

5. Add new Actions column at the end:
   {
     id: 'actions',
     header: '',
     cell: ({ row }) => {
       return h(ActionButtons, {
         status: row.original.status,
         loading: callbacks.pendingIds[row.original.id] ?? false,
         onComplete: () => callbacks.onComplete(row.original.id),
         onCancel: () => callbacks.onCancel(row.original.id),
       })
     },
   }

6. Keep the original `columns` export for backward compatibility but mark as deprecated with a comment, or remove it since we'll update the consumer.
  </action>
  <verify>
- columns.ts imports GateSelect and ActionButtons
- createColumns function exists and accepts callbacks
- Gate column renders GateSelect for active statuses
- Actions column renders ActionButtons
- PickupRequest interface includes gate relation
  </verify>
  <done>Column definitions updated with Gate dropdown and Action buttons</done>
</task>

<task type="auto">
  <name>Task 3: Create RequestDetail component for Sheet</name>
  <files>staff/app/components/dashboard/RequestDetail.vue</files>
  <action>
Create staff/app/components/dashboard/RequestDetail.vue:

1. Script setup with TypeScript:
   - Import type PickupRequest from './columns'
   - Import StatusBadge from './StatusBadge.vue'
   - Import GateSelect from './GateSelect.vue'
   - Import ActionButtons from './ActionButtons.vue'
   - Import Flag from lucide-vue-next

2. Props:
   - request: PickupRequest
   - gates: Array<{ id: string; gate_number: number; queue_count: number }>
   - loading?: boolean

3. Emits:
   - gate-select: [gateId: string]
   - complete: []
   - cancel: []

4. Template - Display full request details:
   - Order Number (large, prominent)
   - Company Name
   - Customer Email
   - Status (using StatusBadge)
   - Flag indicator if email_flagged (with explanatory text "Email domain mismatch")
   - Current Gate (if assigned)
   - Queue Position (if in queue)
   - Created date/time

5. Add action section at bottom:
   - GateSelect (if status allows)
   - ActionButtons (if status allows)
   - Wire events to emit to parent

6. Style with proper spacing:
   - Use dl/dt/dd or grid layout for label/value pairs
   - Add visual separator before actions section
  </action>
  <verify>
- RequestDetail.vue exists
- Shows all request details (order, company, email, status, flag, gate, position, created)
- Includes GateSelect and ActionButtons
- Emits gate-select, complete, cancel events
  </verify>
  <done>RequestDetail component created for Sheet content</done>
</task>

<task type="auto">
  <name>Task 4: Update index.vue with Tabs, Sheet, and wire actions</name>
  <files>staff/app/pages/index.vue</files>
  <action>
Rewrite staff/app/pages/index.vue to integrate all queue management features:

1. Imports:
   - Tabs, TabsContent, TabsList, TabsTrigger from @/components/ui/tabs
   - Sheet, SheetContent, SheetHeader, SheetTitle from @/components/ui/sheet
   - DataTable, createColumns, type PickupRequest from dashboard components
   - useQueueActions from @/composables/useQueueActions
   - RequestDetail component

2. Fetch requests with gate relation:
   - Update Supabase query to include: assigned_gate_id, gate:gates(id, gate_number)
   - This joins the gates table to get gate info

3. Fetch gates with queue counts:
   const { data: gates } = await useAsyncData('gates-with-counts', async () => {
     const { data, error } = await client
       .from('gates')
       .select('id, gate_number, is_active')
       .eq('is_active', true)
       .order('gate_number')

     if (error) throw error

     // Get queue counts per gate
     const { data: counts } = await client
       .from('pickup_requests')
       .select('assigned_gate_id')
       .eq('status', 'in_queue')

     const countMap = (counts ?? []).reduce((acc, r) => {
       acc[r.assigned_gate_id] = (acc[r.assigned_gate_id] || 0) + 1
       return acc
     }, {} as Record<string, number>)

     return data.map(g => ({
       ...g,
       queue_count: countMap[g.id] || 0
     }))
   })

4. Set up useQueueActions:
   const { pending, assignGate, cancelRequest, completeRequest } = useQueueActions()

5. Create columns with callbacks:
   const columns = computed(() => createColumns({
     gates: gates.value ?? [],
     pendingIds: pending.value,
     onGateSelect: handleGateSelect,
     onComplete: handleComplete,
     onCancel: handleCancel,
   }))

6. Implement handlers that refresh after action:
   async function handleGateSelect(requestId: string, gateId: string) {
     await assignGate(requestId, gateId)
     await refresh()
     await refreshGates() // if using separate refresh for gates
   }
   // Similar for handleComplete, handleCancel

7. Computed for active vs history:
   const activeRequests = computed(() =>
     (requests.value ?? []).filter(r => !['completed', 'cancelled'].includes(r.status))
   )
   const historyRequests = computed(() =>
     (requests.value ?? []).filter(r => ['completed', 'cancelled'].includes(r.status))
   )

8. Sheet state:
   const selectedRequest = ref<PickupRequest | null>(null)
   const sheetOpen = computed({
     get: () => selectedRequest.value !== null,
     set: (v) => { if (!v) selectedRequest.value = null }
   })

9. Row click handler:
   function handleRowClick(request: PickupRequest) {
     selectedRequest.value = request
   }

10. Template structure:
    - Header with title and Refresh button
    - Tabs with TabsList containing Active Queue and History triggers
    - TabsContent for active: DataTable with activeRequests
    - TabsContent for history: DataTable with historyRequests (no actions)
    - Sheet with RequestDetail, wired to actions

11. Add row-fade-out class for recently completed/cancelled (optional enhancement):
    - Track recently transitioned IDs
    - Apply fade-out animation
    - Remove from active list after animation
  </action>
  <verify>
- index.vue has Tabs with Active Queue and History
- DataTable receives columns from createColumns
- Sheet opens on row click showing RequestDetail
- Gate assignment works and refreshes data
- Cancel/Complete work and refresh data
- Tab counts update correctly
  </verify>
  <done>Dashboard fully integrated with tabs, actions, and detail panel</done>
</task>

</tasks>

<verification>
1. Start dev server: cd staff && pnpm dev
2. Login and view dashboard
3. Verify tabs show Active Queue and History with counts
4. Click a pending request - sheet opens with details
5. Assign a gate - toast shows, request moves to in_queue, gate shows queue count
6. Click row again - complete the pickup - toast shows, moves to History tab
7. Test cancel flow similarly
8. Verify all status transitions work correctly
</verification>

<success_criteria>
- Staff can assign a request to a specific gate (STAFF-04)
- Staff can add a pending request to the queue via gate assignment (STAFF-05)
- Staff can cancel a request (STAFF-05)
- Staff can mark an in-queue pickup as complete (STAFF-06)
- Status transitions are reflected immediately in the dashboard
- Active Queue vs History separation works
- Detail panel shows full request information
</success_criteria>

<output>
After completion, create `.planning/phases/05-staff-queue-management/05-03-SUMMARY.md`
</output>
