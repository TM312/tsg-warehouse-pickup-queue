---
phase: 17-dashboard-visualization
plan: 04
type: execute
wave: 3
depends_on: ["17-02", "17-03"]
files_modified:
  - staff/app/pages/index.vue
autonomous: false

must_haves:
  truths:
    - "Dashboard shows overview of all gates and queues"
    - "Bar chart visualizes queue length per gate"
    - "Total pickups completed today is displayed"
    - "Average waiting time is displayed"
    - "Average processing time is displayed"
  artifacts:
    - path: "staff/app/pages/index.vue"
      provides: "Dashboard page with KPIs and chart"
      contains: "useDashboardKpis"
  key_links:
    - from: "staff/app/pages/index.vue"
      to: "staff/app/composables/useDashboardKpis.ts"
      via: "composable import"
      pattern: "useDashboardKpis"
    - from: "staff/app/pages/index.vue"
      to: "staff/app/components/dashboard/QueueBarChart.vue"
      via: "component usage"
      pattern: "QueueBarChart"
    - from: "staff/app/pages/index.vue"
      to: "staff/app/stores/gates.ts"
      via: "store for queue counts"
      pattern: "useGatesStore"
---

<objective>
Integrate KPI cards and bar chart into the dashboard page, wiring up data from stores and composables.

Purpose: Supervisors can see queue status at a glance with KPIs and visualization above existing queue management.
Output: Complete dashboard with overview metrics and chart.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-dashboard-visualization/17-RESEARCH.md
@.planning/phases/17-dashboard-visualization/17-CONTEXT.md
@staff/app/pages/index.vue
@staff/app/stores/gates.ts
@staff/app/stores/queue.ts
@staff/app/composables/useDashboardKpis.ts
@staff/app/components/dashboard/KpiCard.vue
@staff/app/components/dashboard/QueueBarChart.vue
@staff/app/utils/formatDuration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KPI section to dashboard</name>
  <files>staff/app/pages/index.vue</files>
  <action>
    Update index.vue to add KPI cards row above existing content:

    1. Import and use useDashboardKpis composable
    2. Import formatDuration utility
    3. Add computed for "currently waiting" count (from queueStore.inQueueItems)
    4. Add KPI cards row with 4 cards:
       - Completed Today (completedCount)
       - Average Wait Time (formatDuration(avgWaitTimeMinutes))
       - Average Processing Time (formatDuration(avgProcessingTimeMinutes))
       - Currently Waiting (inQueueItems.length)

    Add to script setup (after existing imports):
    ```typescript
    import { useDashboardKpis } from '@/composables/useDashboardKpis'
    import { formatDuration } from '@/utils/formatDuration'
    import KpiCard from '@/components/dashboard/KpiCard.vue'
    ```

    Add composable usage:
    ```typescript
    // Dashboard KPIs
    const {
      loading: kpiLoading,
      completedCount,
      avgWaitTimeMinutes,
      avgProcessingTimeMinutes
    } = useDashboardKpis()

    // Currently waiting (from queue store)
    const currentlyWaiting = computed(() => inQueueItems.value.length)
    ```

    Note: inQueueItems is already available from queueStore via storeToRefs (add if not present).

    Add to template, before the existing header/content:
    ```vue
    <!-- KPI Cards Row -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <KpiCard
        label="Completed Today"
        :value="completedCount"
        :loading="kpiLoading"
      />
      <KpiCard
        label="Avg Wait Time"
        :value="formatDuration(avgWaitTimeMinutes)"
        :loading="kpiLoading"
      />
      <KpiCard
        label="Avg Processing Time"
        :value="formatDuration(avgProcessingTimeMinutes)"
        :loading="kpiLoading"
      />
      <KpiCard
        label="Currently Waiting"
        :value="currentlyWaiting"
        :loading="requestsLoading"
      />
    </div>
    ```

    Grid is 2 cols on mobile (stacked 2x2), 4 cols on desktop (row).
  </action>
  <verify>
    - `grep "useDashboardKpis" staff/app/pages/index.vue` shows composable imported and used
    - `grep "KpiCard" staff/app/pages/index.vue` shows component usage
    - `grep "grid-cols-2 lg:grid-cols-4" staff/app/pages/index.vue` shows responsive grid
  </verify>
  <done>
    Dashboard shows 4 KPI cards with metrics
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bar chart section to dashboard</name>
  <files>staff/app/pages/index.vue</files>
  <action>
    Add bar chart below KPI cards, showing queue counts per gate:

    1. Import QueueBarChart component
    2. Create computed that transforms sortedActiveGates to chart data format
    3. Add chart section between KPIs and existing tabs

    Add to script setup:
    ```typescript
    import QueueBarChart from '@/components/dashboard/QueueBarChart.vue'
    ```

    Add computed for chart data (uses gatesStore.sortedActiveGates and queue counts):
    ```typescript
    // Chart data: gate queue counts
    const chartData = computed(() => {
      return sortedActiveGates.value.map((gate: GateWithCount) => ({
        gate: `Gate ${gate.gate_number}`,
        count: requests.value.filter(
          (r: PickupRequest) => r.assigned_gate_id === gate.id && r.status === PICKUP_STATUS.IN_QUEUE
        ).length,
        gateId: gate.id
      }))
    })
    ```

    Note: Need to add sortedActiveGates to storeToRefs from gatesStore if not present.

    Add to template, after KPI cards:
    ```vue
    <!-- Queue Bar Chart -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-4">Queue by Gate</h2>
      <QueueBarChart
        :data="chartData"
        :loading="requestsLoading"
      />
    </div>
    ```
  </action>
  <verify>
    - `grep "QueueBarChart" staff/app/pages/index.vue` shows component import and usage
    - `grep "chartData" staff/app/pages/index.vue` shows computed for chart data
    - `cd staff && pnpm nuxi typecheck 2>&1 | grep -v "native-select" | grep -i error | wc -l` returns 0
  </verify>
  <done>
    Dashboard shows bar chart of queue counts per gate
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Dashboard page with:
    - 4 KPI cards (Completed Today, Avg Wait Time, Avg Processing Time, Currently Waiting)
    - Bar chart showing queue length per gate
    - Existing queue management tabs below
  </what-built>
  <how-to-verify>
    1. Run `cd staff && pnpm dev` to start the dev server
    2. Visit http://localhost:3000 (login if needed: staff@example.com / password123)
    3. Verify dashboard layout:
       - 4 KPI cards visible at top (responsive: 2 cols on mobile, 4 on desktop)
       - Bar chart shows below KPIs with "Queue by Gate" heading
       - Existing tabs (All Requests, Gate queues, Manage Gates) still work below
    4. Verify KPI values:
       - If no completed pickups today, values show "--" for averages, "0" for counts
       - Create a test pickup and complete it, verify count updates
    5. Verify bar chart:
       - Shows one bar per active gate
       - Hover shows tooltip with gate name and count
       - Chart updates when queue changes (add/remove from queue)
    6. Verify responsive behavior:
       - On mobile viewport, KPI cards stack 2x2
       - Chart takes full width
    7. Check dark mode (if system/browser supports):
       - Chart colors adapt to dark mode
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Run these checks after all tasks:
1. `grep "useDashboardKpis" staff/app/pages/index.vue` - Composable used
2. `grep "QueueBarChart" staff/app/pages/index.vue` - Chart component used
3. `grep "KpiCard" staff/app/pages/index.vue` - KPI cards used
4. `cd staff && pnpm nuxi typecheck 2>&1 | grep -v "native-select" | grep -i error` - No new type errors
</verification>

<success_criteria>
- Dashboard page shows 4 KPI cards at top
- Bar chart shows queue length per gate
- KPIs refresh periodically (30 seconds)
- Chart updates when queue state changes
- Existing queue management functionality preserved
- Human verification confirms visual appearance and functionality
</success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-visualization/17-04-SUMMARY.md`
</output>
