---
phase: 17-dashboard-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/shared/types/pickup-request.ts
  - staff/app/composables/useDashboardKpis.ts
  - staff/app/utils/formatDuration.ts
autonomous: true

must_haves:
  truths:
    - "KPI data is fetched from Supabase for completed pickups today"
    - "Wait time and processing time averages are calculated correctly"
    - "Data refreshes periodically without manual intervention"
  artifacts:
    - path: "staff/app/composables/useDashboardKpis.ts"
      provides: "Dashboard KPI calculations with periodic refresh"
      exports: ["useDashboardKpis"]
    - path: "staff/app/utils/formatDuration.ts"
      provides: "Duration formatting as Xh Ym"
      exports: ["formatDuration"]
    - path: "staff/shared/types/pickup-request.ts"
      provides: "PickupRequest with completed_at field"
      contains: "completed_at"
  key_links:
    - from: "staff/app/composables/useDashboardKpis.ts"
      to: "pickup_requests table"
      via: "Supabase client query"
      pattern: "from\\('pickup_requests'\\)"
    - from: "staff/app/composables/useDashboardKpis.ts"
      to: "date-fns"
      via: "time calculations"
      pattern: "differenceInMinutes"
---

<objective>
Create KPI data layer with composable for fetching and calculating dashboard metrics.

Purpose: Dashboard needs completed count, avg wait time, and avg processing time calculated from database.
Output: useDashboardKpis composable with periodic refresh, formatDuration utility.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-dashboard-visualization/17-RESEARCH.md
@.planning/phases/17-dashboard-visualization/17-CONTEXT.md
@staff/shared/types/pickup-request.ts
@staff/app/composables/useQueueActions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add completed_at to PickupRequest type</name>
  <files>staff/shared/types/pickup-request.ts</files>
  <action>
    Add completed_at field to PickupRequest interface. The database already has this column (see migrations), but the TypeScript type is missing it.

    Add to the PickupRequest interface:
    ```typescript
    completed_at?: string | null
    ```

    Place it after processing_started_at for logical grouping of timestamps.
  </action>
  <verify>
    `grep -A2 "processing_started_at" staff/shared/types/pickup-request.ts` shows completed_at after it
  </verify>
  <done>
    PickupRequest interface includes completed_at field
  </done>
</task>

<task type="auto">
  <name>Task 2: Create formatDuration utility</name>
  <files>staff/app/utils/formatDuration.ts</files>
  <action>
    Create utility function to format minutes as human-readable duration:

    ```typescript
    // staff/app/utils/formatDuration.ts

    /**
     * Format minutes as human-readable duration (e.g., "1h 12m", "45m")
     * Returns "--" for null/undefined input
     */
    export function formatDuration(minutes: number | null | undefined): string {
      if (minutes === null || minutes === undefined) {
        return '--'
      }

      if (minutes < 60) {
        return `${minutes}m`
      }

      const hours = Math.floor(minutes / 60)
      const mins = minutes % 60

      if (mins === 0) {
        return `${hours}h`
      }

      return `${hours}h ${mins}m`
    }
    ```

    Note: Per CONTEXT.md, show "--" when no data exists.
  </action>
  <verify>
    `cat staff/app/utils/formatDuration.ts` shows function with "--" for null handling
  </verify>
  <done>
    formatDuration utility exists with null handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useDashboardKpis composable</name>
  <files>staff/app/composables/useDashboardKpis.ts</files>
  <action>
    Create composable for fetching and calculating dashboard KPIs:

    ```typescript
    // staff/app/composables/useDashboardKpis.ts
    import { ref, computed } from 'vue'
    import { useIntervalFn } from '@vueuse/core'
    import { startOfDay, differenceInMinutes } from 'date-fns'
    import { PICKUP_STATUS } from '#shared/types/pickup-request'
    import type { PickupRequest } from '#shared/types/pickup-request'

    const REFRESH_INTERVAL = 30_000 // 30 seconds

    export function useDashboardKpis() {
      const client = useSupabaseClient()

      const completedToday = ref<PickupRequest[]>([])
      const loading = ref(true)
      const error = ref<string | null>(null)
      const lastRefreshed = ref<Date | null>(null)

      async function fetchKpis() {
        loading.value = true
        error.value = null

        try {
          const todayStart = startOfDay(new Date()).toISOString()

          const { data, error: fetchError } = await client
            .from('pickup_requests')
            .select('id, created_at, processing_started_at, completed_at')
            .eq('status', PICKUP_STATUS.COMPLETED)
            .gte('completed_at', todayStart)

          if (fetchError) {
            throw fetchError
          }

          completedToday.value = (data ?? []) as PickupRequest[]
          lastRefreshed.value = new Date()
        } catch (e) {
          error.value = e instanceof Error ? e.message : 'Failed to fetch KPIs'
          console.error('Dashboard KPI fetch error:', e)
        } finally {
          loading.value = false
        }
      }

      // Computed: count of completed today
      const completedCount = computed(() => completedToday.value.length)

      // Computed: average wait time (created_at to processing_started_at)
      const avgWaitTimeMinutes = computed((): number | null => {
        const validRequests = completedToday.value.filter(r =>
          r.processing_started_at && r.created_at
        )

        if (validRequests.length === 0) return null

        const totalMinutes = validRequests.reduce((sum, r) => {
          return sum + differenceInMinutes(
            new Date(r.processing_started_at!),
            new Date(r.created_at)
          )
        }, 0)

        return Math.round(totalMinutes / validRequests.length)
      })

      // Computed: average processing time (processing_started_at to completed_at)
      const avgProcessingTimeMinutes = computed((): number | null => {
        const validRequests = completedToday.value.filter(r =>
          r.completed_at && r.processing_started_at
        )

        if (validRequests.length === 0) return null

        const totalMinutes = validRequests.reduce((sum, r) => {
          return sum + differenceInMinutes(
            new Date(r.completed_at!),
            new Date(r.processing_started_at!)
          )
        }, 0)

        return Math.round(totalMinutes / validRequests.length)
      })

      // Periodic refresh
      const { pause, resume, isActive } = useIntervalFn(fetchKpis, REFRESH_INTERVAL, {
        immediate: true,
        immediateCallback: true
      })

      return {
        // State
        loading,
        error,
        lastRefreshed,
        // Computed KPIs
        completedCount,
        avgWaitTimeMinutes,
        avgProcessingTimeMinutes,
        // Actions
        refresh: fetchKpis,
        pause,
        resume,
        isActive
      }
    }
    ```

    Key points:
    - Uses startOfDay from date-fns to get today's start (respects local timezone)
    - Returns null for averages when no valid data (caller formats as "--")
    - 30s refresh interval per CONTEXT.md decision
    - immediate: true starts fetching on mount
  </action>
  <verify>
    - `cat staff/app/composables/useDashboardKpis.ts | grep "useIntervalFn"` shows periodic refresh
    - `cat staff/app/composables/useDashboardKpis.ts | grep "differenceInMinutes"` shows time calculations
    - `cd staff && pnpm nuxi typecheck 2>&1 | grep -v "native-select" | grep -i error | wc -l` returns 0
  </verify>
  <done>
    useDashboardKpis composable with completedCount, avgWaitTimeMinutes, avgProcessingTimeMinutes
  </done>
</task>

</tasks>

<verification>
Run these checks after all tasks:
1. `grep "completed_at" staff/shared/types/pickup-request.ts` - Type includes completed_at
2. `cat staff/app/utils/formatDuration.ts` - Utility exists
3. `cat staff/app/composables/useDashboardKpis.ts` - Composable exists
4. `cd staff && pnpm nuxi typecheck 2>&1 | grep -v "native-select" | grep -i error` - No new type errors
</verification>

<success_criteria>
- PickupRequest includes completed_at field
- formatDuration utility handles null and formats as "Xh Ym"
- useDashboardKpis fetches today's completed pickups
- useDashboardKpis calculates avgWaitTimeMinutes and avgProcessingTimeMinutes
- Periodic refresh at 30 second interval
- Type check passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-visualization/17-02-SUMMARY.md`
</output>
