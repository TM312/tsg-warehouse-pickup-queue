---
phase: 09-realtime-queue-updates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - customer/app/composables/useWaitTimeEstimate.ts
  - customer/app/components/WaitTimeEstimate.vue
  - customer/app/components/TurnTakeover.vue
autonomous: true

must_haves:
  truths:
    - "WaitTimeEstimate component can render a range (e.g., 10-15 min) when given estimate prop"
    - "WaitTimeEstimate component renders nothing when estimate prop is null"
    - "TurnTakeover component displays full-screen overlay when show prop is true"
    - "TurnTakeover component displays gate number and dismisses on button click"
  artifacts:
    - path: "customer/app/composables/useWaitTimeEstimate.ts"
      provides: "Wait time calculation from completed pickups"
      exports: ["useWaitTimeEstimate"]
    - path: "customer/app/components/WaitTimeEstimate.vue"
      provides: "Wait time range display component"
      contains: "v-if=\"estimate\""
    - path: "customer/app/components/TurnTakeover.vue"
      provides: "Full-screen overlay when turn arrives"
      contains: "fixed inset-0"
  key_links:
    - from: "useWaitTimeEstimate"
      to: "pickup_requests"
      via: "Supabase query for completed requests"
      pattern: "from.*pickup_requests.*completed"
---

<objective>
Create wait time estimation, toast notifications for gate changes, and full-screen turn takeover.

Purpose: Customers need wait time estimates to set expectations, gate change notifications to stay informed, and an unmissable alert when it's their turn.

Output: Wait time composable and display component, TurnTakeover overlay component ready for integration.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-realtime-queue-updates/09-CONTEXT.md
@.planning/phases/09-realtime-queue-updates/09-RESEARCH.md
@supabase/migrations/20260128000002_create_pickup_requests_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useWaitTimeEstimate composable</name>
  <files>customer/app/composables/useWaitTimeEstimate.ts</files>
  <action>
Create a composable that calculates wait time based on rolling average of recent completed pickups.

Implementation:
1. Export function `useWaitTimeEstimate()`
2. Get Supabase client via `useSupabaseClient()`
3. Implement `calculateEstimate(position: number): Promise<{ min: number; max: number } | null>`
   - Query last 10 completed pickups ordered by completed_at DESC
   - Filter: status = 'completed', completed_at IS NOT NULL
   - Select: created_at, completed_at
4. Calculate:
   - If fewer than 3 completed requests, return null (not enough data)
   - For each request, calculate time: (completed_at - created_at) in minutes
   - Compute average time
   - Base estimate = avgTime * (position - 1) (position 1 = 0 wait)
   - Return { min: round(estimate * 0.8), max: round(estimate * 1.2) }
   - Ensure min >= 0

Reference 09-RESEARCH.md Pattern 2 for implementation details.
  </action>
  <verify>File exists at customer/app/composables/useWaitTimeEstimate.ts with calculateEstimate function</verify>
  <done>useWaitTimeEstimate composable calculates wait time range from completion history, returns null when insufficient data</done>
</task>

<task type="auto">
  <name>Task 2: Create WaitTimeEstimate display component</name>
  <files>customer/app/components/WaitTimeEstimate.vue</files>
  <action>
Create a simple component that displays wait time as a range.

Implementation:
1. Accept `estimate` prop: `{ min: number; max: number } | null`
2. Only render when estimate is not null (use v-if)
3. Display format:
   - If min === max: "~X min"
   - Otherwise: "X-Y min"
4. Include label: "Estimated wait:"
5. Style with Tailwind: text-muted-foreground, font-medium for label

Reference 09-RESEARCH.md WaitTimeEstimate code example.
  </action>
  <verify>File exists at customer/app/components/WaitTimeEstimate.vue</verify>
  <done>WaitTimeEstimate component displays wait range, hides when no estimate available</done>
</task>

<task type="auto">
  <name>Task 3: Create TurnTakeover full-screen overlay</name>
  <files>customer/app/components/TurnTakeover.vue</files>
  <action>
Create a full-screen overlay component that appears when it's the customer's turn.

Implementation:
1. Accept props:
   - `show: boolean` - controls visibility
   - `gateNumber: number` - gate to proceed to
2. Use Vue `<Transition>` for enter/leave animation (fade)
3. Full-screen styling:
   - fixed inset-0 z-50
   - bg-primary (or high-contrast color)
   - flex items-center justify-center
4. Content (centered):
   - Large check icon (CheckCircle2 from lucide-vue-next) with animate-bounce
   - "It's Your Turn!" heading (text-4xl font-bold)
   - "Proceed to" label
   - Gate number (text-6xl font-black)
   - "Got it" button to dismiss (emits 'dismiss' event)
5. Transition CSS: opacity 0.3s ease for enter/leave

Accessibility: Button is focusable, screen reader announces content.

Reference 09-RESEARCH.md Pattern 4 for TurnTakeover code.
  </action>
  <verify>File exists at customer/app/components/TurnTakeover.vue with Transition wrapper</verify>
  <done>TurnTakeover displays full-screen gate instruction with dismiss button, animates in/out smoothly</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Build check: `cd customer && pnpm build`
2. Manual component testing will occur after Plan 01 integrates these components into the status page
3. For now, verify files compile without TypeScript errors
</verification>

<success_criteria>
1. useWaitTimeEstimate queries completed requests and returns { min, max } range
2. useWaitTimeEstimate returns null when fewer than 3 completed requests exist
3. WaitTimeEstimate displays "X-Y min" or "~X min" format
4. WaitTimeEstimate hides entirely when estimate is null
5. TurnTakeover displays full-screen with gate number and dismiss button
6. TurnTakeover has smooth fade transition
</success_criteria>

<output>
After completion, create `.planning/phases/09-realtime-queue-updates/09-02-SUMMARY.md`
</output>
