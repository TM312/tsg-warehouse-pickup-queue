---
phase: 09-realtime-queue-updates
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - customer/app/pages/status/[id].vue
  - staff/app/pages/index.vue
  - staff/app/components/dashboard/ShowCompletedToggle.vue
autonomous: true

must_haves:
  truths:
    - "Staff dashboard updates in real-time without refresh"
    - "Toast notification appears when customer's gate is assigned/changed"
    - "Full-screen takeover appears when customer status becomes in_queue and has position 1"
    - "Staff can toggle visibility of completed/cancelled requests"
  artifacts:
    - path: "staff/app/pages/index.vue"
      provides: "Dashboard with realtime integration"
      contains: "useRealtimeQueue"
    - path: "staff/app/components/dashboard/ShowCompletedToggle.vue"
      provides: "Toggle for showing completed/cancelled"
      contains: "Switch"
  key_links:
    - from: "staff/app/pages/index.vue"
      to: "useRealtimeQueue"
      via: "subscribe callback triggers refresh"
      pattern: "subscribe.*refresh"
    - from: "customer/app/pages/status/[id].vue"
      to: "TurnTakeover"
      via: "show when status in_queue and position 1"
      pattern: "TurnTakeover.*show"
---

<objective>
Integrate realtime updates into staff dashboard and complete customer status page with all notification types.

Purpose: Staff need to see queue changes without manual refresh. Customers need toast notifications for gate changes and full-screen takeover when their turn arrives.

Output: Staff dashboard with live updates and show/hide toggle. Customer status page fully wired with wait time, gate notifications, and turn takeover.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-realtime-queue-updates/09-CONTEXT.md
@.planning/phases/09-realtime-queue-updates/09-RESEARCH.md
@.planning/phases/09-realtime-queue-updates/09-01-SUMMARY.md
@.planning/phases/09-realtime-queue-updates/09-02-SUMMARY.md
@staff/app/pages/index.vue
@staff/app/composables/useRealtimeQueue.ts
@customer/app/pages/status/[id].vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate realtime updates into staff dashboard</name>
  <files>staff/app/pages/index.vue, staff/app/components/dashboard/ShowCompletedToggle.vue</files>
  <action>
Add realtime subscription to staff dashboard and create toggle for completed/cancelled visibility.

Changes to staff/app/pages/index.vue:
1. Import and use `useRealtimeQueue` composable
2. Import existing `ConnectionStatus` component from @/components/ConnectionStatus.vue
3. In onMounted, call `subscribe(() => refresh())` to trigger data refresh on any change
4. In onUnmounted (or use composable's auto-cleanup), ensure cleanup
5. Add ConnectionStatus component to template (position: header area near Refresh button)
6. Add `showCompleted` ref (default: false)
7. Modify `activeRequests` computed to filter out completed/cancelled when showCompleted is false
8. Replace separate "History" tab with inline toggle in "All Requests" tab header
9. When showCompleted is true, show all requests; when false, only active

Create staff/app/components/dashboard/ShowCompletedToggle.vue:
1. Accept `showCompleted: boolean` prop
2. Emit `update:showCompleted` event for v-model
3. Display: Switch component + "Show completed/cancelled" label
4. Style: flex items-center gap-2, text-sm text-muted-foreground

Integration in index.vue:
- Place ShowCompletedToggle in tab content header for "All Requests"
- Use v-model pattern: `<ShowCompletedToggle v-model:showCompleted="showCompleted" />`
  </action>
  <verify>cd staff && pnpm build (no errors)</verify>
  <done>Staff dashboard subscribes to realtime updates, refresh triggered on changes, toggle controls completed visibility</done>
</task>

<task type="auto">
  <name>Task 2: Wire customer status page with wait time and notifications</name>
  <files>customer/app/pages/status/[id].vue</files>
  <action>
Enhance the status page from Plan 01 with wait time display, gate change toasts, and turn takeover.

Implementation:
1. Import and use `useWaitTimeEstimate` composable
2. Import `WaitTimeEstimate` and `TurnTakeover` components
3. Import `toast` from vue-sonner

Wait time integration:
- Create `waitEstimate` ref
- When status is 'in_queue' and position exists, call `calculateEstimate(position)` and update waitEstimate
- Recalculate when position changes (use watch)
- Display WaitTimeEstimate component below PositionDisplay when in_queue

Gate change notifications:
- Track `previousGateId` ref (initialized to null)
- In realtime subscription callback, after updating request state:
  - Compare new assigned_gate_id with previousGateId
  - If different AND not initial load (previousGateId !== null), show toast:
    `toast.info(\`You've been assigned to Gate \${gateNumber}\`, { duration: 5000 })`
  - Update previousGateId

Turn takeover:
- Create `showTakeover` ref (default: false)
- Create `takenoverGateNumber` ref
- Condition to show takeover: status === 'in_queue' AND queue_position === 1 AND has gate assigned
- Actually, per CONTEXT.md: "Turn arrival (status change to being served): Full-screen takeover"
  - This means we show takeover when the customer transitions TO being served (could be position 1 with gate)
  - Simplify: Show takeover when status is 'in_queue', position is 1, and gate is assigned
  - Store gate number in takenoverGateNumber
  - On dismiss, set showTakeover to false (but page still shows position #1)
- Also dismiss if status changes away from in_queue

Template changes:
- Add WaitTimeEstimate below PositionDisplay (inside in_queue section)
- Add TurnTakeover component with :show and :gateNumber props
- Wire @dismiss to set showTakeover = false
  </action>
  <verify>cd customer && pnpm build (no errors)</verify>
  <done>Status page shows wait time estimate, toasts on gate change, shows full-screen takeover at position 1</done>
</task>

<task type="auto">
  <name>Task 3: Add Sonner Toaster to customer app layout</name>
  <files>customer/app/app.vue</files>
  <action>
Ensure vue-sonner's Toaster component is mounted in the customer app for toast notifications to display.

Check if app.vue exists, if not check layouts/default.vue. Add Toaster component.

Implementation:
1. Import `Toaster` from 'vue-sonner'
2. Add `<Toaster />` to template (typically at root level)
3. Position config: position="top-center" or "bottom-center" for mobile-friendly display

If customer app uses app.vue:
```vue
<template>
  <NuxtPage />
  <Toaster position="top-center" />
</template>
```

If using layouts, add to the layout file.
  </action>
  <verify>cd customer && pnpm build (no errors) and Toaster is in template</verify>
  <done>Toaster component mounted in customer app, toast notifications will display</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Start local Supabase: `supabase start`
2. Start both apps: staff (port 3000), customer
3. Staff dashboard test:
   - Open dashboard, verify ConnectionStatus shows "connected"
   - Submit a request from customer app
   - Verify request appears in staff dashboard without manual refresh
   - Toggle show/hide completed and verify filtering works
4. Customer status test:
   - Submit request, navigate to status page
   - Have staff assign to a gate - verify toast appears on customer
   - Have staff add to queue - verify position displays
   - Set position to 1 - verify takeover appears
   - Dismiss takeover - verify page still shows position info
   - Verify wait time displays (if completion history exists)
</verification>

<success_criteria>
1. Staff dashboard refreshes automatically when requests change
2. Staff can toggle visibility of completed/cancelled requests
3. ConnectionStatus visible on staff dashboard
4. Customer receives toast when gate is assigned/changed
5. Customer sees wait time estimate when in queue (if history exists)
6. Customer sees full-screen takeover when position is 1 with gate assigned
7. Takeover can be dismissed with "Got it" button
</success_criteria>

<output>
After completion, create `.planning/phases/09-realtime-queue-updates/09-03-SUMMARY.md`
</output>
