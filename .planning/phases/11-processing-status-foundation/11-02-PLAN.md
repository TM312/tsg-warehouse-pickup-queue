---
phase: 11-processing-status-foundation
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - staff/app/components/dashboard/StatusBadge.vue
  - staff/app/components/dashboard/columns.ts
  - staff/app/composables/useQueueActions.ts
  - staff/app/pages/index.vue
  - staff/app/components/dashboard/NowProcessingSection.vue
  - customer/app/pages/status/[id].vue
autonomous: true

must_haves:
  truths:
    - "StatusBadge displays processing status with amber/yellow styling"
    - "StatusBadge shows live duration when processing (e.g., 'Processing (5m)')"
    - "Staff dashboard shows 'Now Processing' section above the queue list"
    - "Gate operators can start processing via useQueueActions composable"
    - "Gate operators can revert processing via useQueueActions composable"
    - "Reverting processing preserves original queue position (visible in queue after revert)"
    - "Customer status page shows processing state appropriately"
  artifacts:
    - path: "staff/app/components/dashboard/StatusBadge.vue"
      provides: "Processing status display with live duration"
      contains: "processing"
    - path: "staff/app/components/dashboard/NowProcessingSection.vue"
      provides: "Dashboard section showing all gates with processing status"
      contains: "Now Processing"
    - path: "staff/app/composables/useQueueActions.ts"
      provides: "startProcessing and revertToQueue actions"
      exports: ["startProcessing", "revertToQueue"]
  key_links:
    - from: "StatusBadge.vue"
      to: "useIntervalFn"
      via: "VueUse composable for live timer"
      pattern: "useIntervalFn"
    - from: "useQueueActions.ts"
      to: "start_processing RPC"
      via: "Supabase client"
      pattern: "client.rpc.*start_processing"
    - from: "index.vue"
      to: "NowProcessingSection.vue"
      via: "component import"
      pattern: "NowProcessingSection"
---

<objective>
Integrate processing status into the staff dashboard UI and customer status page.

Purpose: Enable visualization of the new processing status throughout the application. Staff see a "Now Processing" section showing which gates have active pickups, with StatusBadge displaying amber styling and live elapsed time. Customers see when their order is being processed.

Output: Updated StatusBadge component with processing styling and live duration display, new NowProcessingSection component for dashboard, updated useQueueActions composable with startProcessing and revertToQueue methods, and customer status page handling for processing state.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-processing-status-foundation/11-CONTEXT.md
@.planning/phases/11-processing-status-foundation/11-RESEARCH.md
@.planning/phases/11-processing-status-foundation/11-01-SUMMARY.md
@staff/app/components/dashboard/StatusBadge.vue
@staff/app/components/dashboard/columns.ts
@staff/app/composables/useQueueActions.ts
@staff/app/pages/index.vue
@customer/app/pages/status/[id].vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update StatusBadge with processing status and live duration</name>
  <files>staff/app/components/dashboard/StatusBadge.vue</files>
  <action>
Update StatusBadge.vue to handle the processing status with live elapsed time display:

1. **Add processing to the status type:**
   ```typescript
   const props = defineProps<{
     status: 'pending' | 'approved' | 'in_queue' | 'processing' | 'completed' | 'cancelled'
     processingStartedAt?: string | null
   }>()
   ```

2. **Import useIntervalFn from VueUse:**
   ```typescript
   import { useIntervalFn } from '@vueuse/core'
   ```

3. **Add elapsed time calculation:**
   - Create a ref for elapsed string
   - Use useIntervalFn with 60000ms interval (1 minute)
   - When status is 'processing' and processingStartedAt is set:
     - Calculate minutes since start
     - Format as "Xm" or "Xh Ym" if over 60 minutes
   - When status is not 'processing', set elapsed to empty string
   - Use { immediate: true, immediateCallback: true } options for immediate first calculation

4. **Add watch to pause/resume timer:**
   ```typescript
   watch(() => props.status, (status) => {
     if (status === 'processing') resume()
     else pause()
   }, { immediate: true })
   ```

5. **Update variantMap and labelMap:**
   - Add 'processing' with variant 'default'
   - Label map: 'processing': 'Processing'

6. **Update customClass computed:**
   - Add amber styling for processing status:
     ```typescript
     if (props.status === 'processing') {
       return 'bg-amber-500 hover:bg-amber-600 text-white'
     }
     ```

7. **Update displayLabel computed:**
   - When processing and elapsed is set, return `Processing (${elapsed.value})`
   - Otherwise return the standard label

8. **Add Loader2 icon for processing:**
   - Import Loader2 from lucide-vue-next
   - Show `<Loader2 v-if="status === 'processing'" class="h-3 w-3 animate-spin mr-1" />` before the label text

Ensure the component handles the case where processingStartedAt is not provided (for backward compatibility).
  </action>
  <verify>
1. Build passes: `cd staff && npm run build`
2. Component renders without errors in browser
3. Test: StatusBadge with status="processing" shows amber background
4. Test: StatusBadge with status="processing" and processingStartedAt shows duration
5. Test: Duration updates after 1 minute (or use browser devtools to test)
  </verify>
  <done>
StatusBadge displays processing status with amber background, spinning loader icon, and live elapsed duration that updates every minute.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PickupRequest type and columns to include processing data</name>
  <files>staff/app/components/dashboard/columns.ts</files>
  <action>
Update the PickupRequest interface and columns definition:

1. **Update PickupRequest interface:**
   ```typescript
   export interface PickupRequest {
     id: string
     sales_order_number: string
     company_name: string | null
     customer_email: string
     status: 'pending' | 'approved' | 'in_queue' | 'processing' | 'completed' | 'cancelled'
     email_flagged: boolean
     assigned_gate_id: string | null
     queue_position: number | null
     is_priority?: boolean
     processing_started_at?: string | null  // Add this
     created_at: string
     gate?: { id: string; gate_number: number } | null
   }
   ```

2. **Update the status column cell renderer:**
   - Pass processingStartedAt to StatusBadge:
     ```typescript
     cell: ({ row }) => {
       const status = row.getValue('status') as PickupRequest['status']
       const processingStartedAt = row.original.processing_started_at
       return h(StatusBadge, { status, processingStartedAt })
     },
     ```

3. **Update the gate column cell to handle processing status:**
   - Add 'processing' to the isActive check:
     ```typescript
     const isActive = ['pending', 'approved', 'in_queue', 'processing'].includes(status)
     ```

4. **Update the deprecated columns array** at the bottom of the file to match (for backward compatibility).
  </action>
  <verify>
1. TypeScript compiles without errors: `cd staff && npm run typecheck`
2. Build passes: `cd staff && npm run build`
  </verify>
  <done>
PickupRequest type includes processing_started_at. Status column passes timestamp to StatusBadge. Gate column handles processing status as active.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add startProcessing and revertToQueue to useQueueActions</name>
  <files>staff/app/composables/useQueueActions.ts</files>
  <action>
Add new methods to the useQueueActions composable:

1. **Add startProcessing method:**
   ```typescript
   async function startProcessing(requestId: string, gateId: string): Promise<string | null> {
     pending.value[requestId] = true
     try {
       const { data, error } = await client.rpc('start_processing', {
         p_request_id: requestId,
         p_gate_id: gateId
       })
       if (error) throw error
       toast.success('Processing started')
       return data as string  // Returns the processing_started_at timestamp
     } catch (e: any) {
       // Handle specific error messages from database function
       if (e.message?.includes('already has a processing request')) {
         toast.error('Gate already has an active pickup')
       } else if (e.message?.includes('not at position 1')) {
         toast.error('Only position 1 can start processing')
       } else {
         toast.error('Failed to start processing')
       }
       return null
     } finally {
       pending.value[requestId] = false
     }
   }
   ```

2. **Add revertToQueue method:**
   ```typescript
   async function revertToQueue(requestId: string): Promise<number | null> {
     pending.value[requestId] = true
     try {
       const { data, error } = await client.rpc('revert_to_queue', {
         p_request_id: requestId
       })
       if (error) throw error
       toast.success('Returned to queue')
       return data as number  // Returns the preserved queue_position
     } catch (e: any) {
       if (e.message?.includes('not in processing status')) {
         toast.error('Request is not being processed')
       } else {
         toast.error('Failed to return to queue')
       }
       return null
     } finally {
       pending.value[requestId] = false
     }
   }
   ```

3. **Export the new methods** in the return statement:
   ```typescript
   return {
     pending: readonly(pending),
     assignGate,
     cancelRequest,
     completeRequest,
     reorderQueue,
     setPriority,
     clearPriority,
     moveToGate,
     startProcessing,    // Add
     revertToQueue       // Add
   }
   ```
  </action>
  <verify>
1. TypeScript compiles: `cd staff && npm run typecheck`
2. Build passes: `cd staff && npm run build`
  </verify>
  <done>
useQueueActions exports startProcessing and revertToQueue methods that call the database functions and show appropriate toast messages.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create NowProcessingSection component and integrate into dashboard</name>
  <files>
staff/app/components/dashboard/NowProcessingSection.vue
staff/app/pages/index.vue
  </files>
  <action>
**Part A: Create NowProcessingSection.vue**

Create a new component at `staff/app/components/dashboard/NowProcessingSection.vue`:

1. **Props:**
   ```typescript
   interface ProcessingItem {
     id: string
     sales_order_number: string
     company_name: string | null
     gate_number: number
     gate_id: string
     processing_started_at: string
   }

   const props = defineProps<{
     items: ProcessingItem[]
     loading: Record<string, boolean>
   }>()

   const emit = defineEmits<{
     complete: [requestId: string]
     revert: [requestId: string]
     rowClick: [requestId: string]
   }>()
   ```

2. **Layout:**
   - Section header: "Now Processing" with count badge
   - If no items: show "No active processing" message in muted text
   - For each item, show a card/row with:
     - Gate number prominently displayed (large text, e.g., "Gate 3")
     - Sales order number
     - Company name (or "N/A")
     - StatusBadge with status="processing" and processingStartedAt
     - "Complete" button (primary, calls emit('complete', id))
     - "Return to Queue" button (outline, calls emit('revert', id))
   - Make the row clickable (calls emit('rowClick', id))
   - Show loading state on buttons when loading[id] is true

3. **Styling:**
   - Use Card component from shadcn-vue
   - Gates displayed vertically beneath each other
   - Mobile-responsive layout (stack vertically on small screens)
   - Use flexbox/grid for button alignment

**Part B: Integrate into dashboard (index.vue)**

1. **Update the data fetch** to include processing_started_at:
   ```typescript
   .select('id, sales_order_number, company_name, customer_email, status, email_flagged, assigned_gate_id, queue_position, is_priority, processing_started_at, created_at, gate:gates(id, gate_number)')
   ```

2. **Import NowProcessingSection component**

3. **Extract processingItems from useQueueActions:**
   ```typescript
   const { pending, ..., startProcessing, revertToQueue } = useQueueActions()
   ```

4. **Add computed for processing items:**
   ```typescript
   const processingItems = computed(() => {
     return (requests.value ?? [])
       .filter(r => r.status === 'processing' && r.gate)
       .map(r => ({
         id: r.id,
         sales_order_number: r.sales_order_number,
         company_name: r.company_name,
         gate_number: r.gate!.gate_number,
         gate_id: r.assigned_gate_id!,
         processing_started_at: r.processing_started_at!
       }))
       .sort((a, b) => a.gate_number - b.gate_number)
   })
   ```

5. **Add handlers:**
   ```typescript
   async function handleComplete(requestId: string) {
     await completeRequest(requestId)
     await refresh()
   }

   async function handleRevert(requestId: string) {
     await revertToQueue(requestId)
     await refresh()
   }
   ```

   Note: `completeRequest` is already exported from `useQueueActions`, so destructure it alongside the other methods.

6. **Place NowProcessingSection above the Tabs:**
   ```vue
   <NowProcessingSection
     v-if="processingItems.length > 0"
     :items="processingItems"
     :loading="pending"
     @complete="handleComplete"
     @revert="handleRevert"
     @row-click="handleQueueRowClick"
     class="mb-6"
   />
   ```

7. **Update gatesWithQueues computed** to include processing items count (for tab badges):
   - Count should include both in_queue and processing items
  </action>
  <verify>
1. Build passes: `cd staff && npm run build`
2. Start dev server: `cd staff && npm run dev`
3. With a processing request in database, NowProcessingSection appears
4. Complete button works
5. Revert button works and returns request to queue
6. Row click opens detail sheet
  </verify>
  <done>
NowProcessingSection component displays all processing requests by gate. Dashboard shows the section above tabs when there are processing items. Complete and Revert actions work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 5: Update customer status page for processing status</name>
  <files>customer/app/pages/status/[id].vue</files>
  <action>
Update the customer status page to handle the processing state:

1. **Update the PickupRequest interface:**
   ```typescript
   interface PickupRequest {
     id: string
     status: string
     queue_position: number | null
     assigned_gate_id: string | null
     sales_order_number: string
     company_name: string | null
     processing_started_at?: string | null  // Add this
   }
   ```

2. **Update the select query** to include processing_started_at:
   ```typescript
   .select(`
     id,
     status,
     queue_position,
     assigned_gate_id,
     sales_order_number,
     company_name,
     processing_started_at,
     gates:assigned_gate_id (
       id,
       gate_number
     )
   `)
   ```

3. **Add processing case to statusDisplay computed:**
   ```typescript
   case 'processing':
     return {
       title: 'Being Processed',
       message: null,
       showPosition: false,
       showProcessing: true,  // New flag
     }
   ```

4. **Add processing display in template:**
   After the queue position display section, add:
   ```vue
   <!-- Processing Status -->
   <div v-else-if="request.status === 'processing'" class="py-4 space-y-4">
     <div class="bg-amber-50 dark:bg-amber-950 rounded-lg p-6">
       <p class="text-amber-600 dark:text-amber-400 text-sm font-medium">Your Order is Being Processed</p>
       <p class="text-3xl font-bold text-amber-600 dark:text-amber-400 mt-2">Gate {{ gateNumber }}</p>
       <p class="text-muted-foreground text-sm mt-2">Please proceed to the gate for pickup</p>
     </div>
   </div>
   ```

5. **Update the gate assignment display** to also show for processing status:
   ```vue
   <div
     v-if="gateNumber && ['in_queue', 'processing'].includes(request.status)"
     ...
   ```

6. **Handle takeover for processing status:**
   - When status changes to 'processing', dismiss any active takeover (user has been served)
   - Add to the watch:
     ```typescript
     // Dismiss takeover when entering processing (user is being served)
     if (newRequest.status === 'processing') {
       showTakeover.value = false
       takeoverDismissed.value = true
     }
     ```
  </action>
  <verify>
1. Build passes: `cd customer && npm run build`
2. Start dev server: `cd customer && npm run dev`
3. Navigate to /status/[id] with a processing request
4. Shows "Being Processed" with gate number prominently
5. Shows amber/yellow styling
  </verify>
  <done>
Customer status page displays processing state with clear messaging about the order being processed at the assigned gate.
  </done>
</task>

</tasks>

<verification>
1. All builds pass (staff and customer apps)
2. Staff dashboard shows StatusBadge with amber processing status and live duration
3. Staff dashboard shows NowProcessingSection when there are processing requests
4. Complete and Revert buttons work in NowProcessingSection
5. Customer status page shows processing state appropriately
6. Realtime updates work for processing status changes
</verification>

<success_criteria>
- StatusBadge shows processing status with amber background and spinning loader
- StatusBadge displays live elapsed time for processing status (updates every minute)
- PickupRequest type includes processing_started_at field
- useQueueActions exports startProcessing and revertToQueue methods
- NowProcessingSection component exists and displays processing requests by gate
- Dashboard shows NowProcessingSection above tabs when processing items exist
- Customer status page shows "Being Processed" state with gate information
- All TypeScript compiles without errors
- Both apps build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-processing-status-foundation/11-02-SUMMARY.md`
</output>
