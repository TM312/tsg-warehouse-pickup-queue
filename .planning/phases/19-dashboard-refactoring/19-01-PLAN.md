---
phase: 19-dashboard-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/composables/useDashboardData.ts
  - staff/app/pages/index.vue
autonomous: true

must_haves:
  truths:
    - "index.vue has no duplicated filter/map logic for requests"
    - "Computed properties that derive from store state live in useDashboardData.ts"
    - "Event handlers in index.vue are grouped by domain with section comments"
    - "Dashboard functionality unchanged - all features still work"
  artifacts:
    - path: "staff/app/composables/useDashboardData.ts"
      provides: "Dashboard-specific computed properties (currentlyWaiting, chartData, processingItems, gatesWithQueues, filteredRequests)"
      exports: ["useDashboardData"]
    - path: "staff/app/pages/index.vue"
      provides: "Refactored dashboard page with clear separation of concerns"
      max_lines: 350
  key_links:
    - from: "staff/app/pages/index.vue"
      to: "staff/app/composables/useDashboardData.ts"
      via: "composable import and destructuring"
      pattern: "useDashboardData\\(\\)"
    - from: "staff/app/composables/useDashboardData.ts"
      to: "staff/app/stores/queue.ts"
      via: "storeToRefs for reactive access"
      pattern: "useQueueStore\\(\\)"
---

<objective>
Refactor index.vue (410 lines) into maintainable code with clear separation of concerns.

Purpose: Reduce cognitive load and prepare codebase for Phase 20 (Gates View) and Phase 21 (Dashboard Polish) changes. No visual or functional changes - purely internal code quality.

Output:
- New `useDashboardData.ts` composable with extracted computed properties
- Refactored `index.vue` with clear section organization and reduced line count
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-dashboard-refactoring/19-RESEARCH.md

# Source files
@staff/app/pages/index.vue
@staff/app/composables/useDashboardKpis.ts
@staff/app/stores/queue.ts
@staff/app/stores/gates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDashboardData composable</name>
  <files>staff/app/composables/useDashboardData.ts</files>
  <action>
Create a new composable that extracts dashboard-specific computed properties from index.vue.

**Must include:**

1. Import stores via `useQueueStore()` and `useGatesStore()`
2. Use `storeToRefs()` for reactive access to `requests`, `activeGates`, `sortedActiveGates`
3. Extract these computed properties:
   - `currentlyWaiting`: Count of requests with IN_QUEUE status
   - `chartData`: Transform sortedActiveGates into bar chart format `{ gate, count, gateId }[]`
   - `processingItems`: Filter/map/sort for NowProcessingSection props
   - `gatesWithQueues`: Per-gate data with queue items and totalActive count
4. Accept `showCompleted` as a parameter (Ref<boolean>) for filteredRequests
5. Include `filteredRequests` computed that respects showCompleted toggle

**Return type:**
```typescript
{
  currentlyWaiting: ComputedRef<number>
  chartData: ComputedRef<{ gate: string; count: number; gateId: string }[]>
  processingItems: ComputedRef<ProcessingItem[]>
  gatesWithQueues: ComputedRef<GateWithQueue[]>
  filteredRequests: ComputedRef<PickupRequest[]>
}
```

**Follow existing pattern from useDashboardKpis.ts:**
- Explicit type annotations on computed refs where helpful
- Comments for non-obvious logic
- Import types from #shared/types/

**Define local types in file:**
```typescript
interface ProcessingItem {
  id: string
  sales_order_number: string
  company_name: string | null
  gate_number: number
  gate_id: string
  processing_started_at: string
}

interface GateQueueItem {
  id: string
  sales_order_number: string
  company_name: string | null
  queue_position: number
  is_priority: boolean
}

interface GateWithQueue extends GateWithCount {
  queue: GateQueueItem[]
  totalActive: number
}
```
  </action>
  <verify>
Run TypeScript check: `cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npx nuxi typecheck`
Verify no type errors in new file.
  </verify>
  <done>
useDashboardData.ts exists with all computed properties exported, types are correct, no duplication of logic from index.vue.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor index.vue to use composable</name>
  <files>staff/app/pages/index.vue</files>
  <action>
Refactor index.vue to use the new useDashboardData composable and organize handlers by domain.

**Step 1: Update imports and setup**
- Import `useDashboardData` from composables
- Remove local computed definitions that moved to composable:
  - `currentlyWaiting` (line ~54)
  - `chartData` (line ~59)
  - `processingItems` (line ~185)
  - `gatesWithQueues` (line ~200)
  - `filteredRequests` (line ~236)

**Step 2: Replace with composable call**
```typescript
// Dashboard-specific derived data
const { currentlyWaiting, chartData, processingItems, gatesWithQueues, filteredRequests } = useDashboardData(showCompleted)
```

**Step 3: Organize script section with clear comments**
Group code into logical sections with `// === Section Name ===` comments:

```
// === Imports ===
// === Page Meta ===
// === Store & Composable Setup ===
// === Local UI State ===
// === Column Configuration ===
// === Queue Action Handlers ===
// === Priority Handlers ===
// === Processing Section Handlers ===
// === Gate Management Handlers ===
// === Manual Order Creation ===
// === UI Interaction Handlers ===
// === Detail Panel Delegates ===
```

**Step 4: Keep unchanged:**
- Template section (no changes needed)
- Sheet state (selectedRequest, sheetOpen)
- Column configuration (computed depends on handlers)
- All handler implementations (keep logic, just group with comments)

**Step 5: Remove redundant alias**
- Line ~76: `const gates = activeGates` is unnecessary
- Replace template usage of `gates` with `activeGates` directly
- Update columns computed to use `activeGates.value`
- Update RequestDetail :gates prop to use `activeGates`

**Target: ~300-350 lines** (down from 410)
  </action>
  <verify>
1. Run TypeScript check: `cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npx nuxi typecheck`
2. Run dev server: `cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npm run dev`
3. Manually verify dashboard loads and all features work:
   - KPI cards display values
   - Bar chart renders
   - All Requests tab shows data
   - Gate tabs show queue lists
   - Row click opens detail sheet
   - Actions (assign, complete, cancel) still work
  </verify>
  <done>
index.vue is refactored with clear section organization, uses useDashboardData composable, line count reduced to ~300-350, all dashboard functionality works unchanged.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npx nuxi typecheck` - no errors
2. `cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npm run dev` - dashboard loads correctly
3. Manual smoke test: Navigate dashboard, verify all tabs and actions work
4. Line count check: `wc -l staff/app/pages/index.vue` should show ~300-350 lines
</verification>

<success_criteria>
- [ ] useDashboardData.ts exists and exports all computed properties
- [ ] index.vue imports and uses useDashboardData
- [ ] index.vue has clear section comments grouping related code
- [ ] index.vue line count reduced from 410 to ~300-350
- [ ] No TypeScript errors
- [ ] Dashboard functionality unchanged (visual and behavioral)
- [ ] ARCH-10 satisfied: DRY principle followed
- [ ] ARCH-11 satisfied: Clear separation of concerns
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-refactoring/19-01-SUMMARY.md`
</output>
