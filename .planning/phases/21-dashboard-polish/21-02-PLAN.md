---
phase: 21-dashboard-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/components/dashboard/ActionButtons.vue
  - staff/app/components/dashboard/columns.ts
autonomous: true

must_haves:
  truths:
    - "Processing orders show Complete as primary visible button"
    - "Processing orders have Return to Queue and Cancel in dropdown menu"
    - "Non-processing orders show existing inline button pattern"
    - "Cancel action appears as secondary (ghost variant) throughout all states"
  artifacts:
    - path: "staff/app/components/dashboard/ActionButtons.vue"
      provides: "Action buttons with conditional dropdown for processing state"
      contains: "DropdownMenu"
    - path: "staff/app/components/dashboard/columns.ts"
      provides: "Column definitions with revert callback"
      contains: "onRevert"
  key_links:
    - from: "staff/app/components/dashboard/ActionButtons.vue"
      to: "DropdownMenu components"
      via: "import from ui/dropdown-menu"
      pattern: "import.*DropdownMenu"
    - from: "staff/app/components/dashboard/columns.ts"
      to: "ActionButtons"
      via: "h() render function"
      pattern: "h\\(ActionButtons"
---

<objective>
Fix DataTable action button states for processing orders

Purpose: Processing orders should show "Complete" as the primary visible button with "Return to Queue" and "Cancel" in a dropdown menu. This keeps the UI clean with one clear primary action while maintaining access to secondary actions.
Output: ActionButtons component with conditional rendering based on order status.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-dashboard-polish/21-CONTEXT.md
@.planning/phases/21-dashboard-polish/21-RESEARCH.md

# Source files to modify
@staff/app/components/dashboard/ActionButtons.vue
@staff/app/components/dashboard/columns.ts

# Reference patterns
@staff/app/components/ui/dropdown-menu/DropdownMenuItem.vue
@staff/app/components/NavUser.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ActionButtons with dropdown for processing state</name>
  <files>staff/app/components/dashboard/ActionButtons.vue</files>
  <action>
Modify ActionButtons.vue to conditionally render dropdown for processing orders:

1. Add new imports for dropdown menu and icons:
   ```typescript
   import {
     DropdownMenu,
     DropdownMenuContent,
     DropdownMenuItem,
     DropdownMenuTrigger,
   } from '@/components/ui/dropdown-menu'
   import { Check, X, Loader2, MoreVertical, RotateCcw } from 'lucide-vue-next'
   ```

2. Add new emit for revert action:
   ```typescript
   const emit = defineEmits<{
     complete: []
     cancel: []
     revert: []
   }>()
   ```

3. Add computed for processing state:
   ```typescript
   const isProcessing = computed(() => props.status === PICKUP_STATUS.PROCESSING)
   ```

4. Update template to conditionally render based on isProcessing:

   For PROCESSING state, render:
   - Complete button as primary visible button (same AlertDialog pattern as current, but with default/primary variant instead of outline)
   - Dropdown menu with MoreVertical icon trigger containing:
     - "Return to Queue" item (with RotateCcw icon) - emits 'revert'
     - "Cancel" item (with X icon, variant="destructive") - opens AlertDialog for confirmation

   For NON-PROCESSING states, keep existing pattern:
   - Complete button (if showComplete) with outline variant
   - Cancel button (if showCancel) with ghost variant

5. Handle AlertDialog within dropdown for Cancel:
   - Use a ref `showCancelDialog` to control AlertDialog open state
   - DropdownMenuItem for Cancel sets showCancelDialog = true
   - AlertDialog is rendered outside dropdown but controlled by ref

Template structure for processing state:
```vue
<template v-if="isProcessing">
  <div class="flex gap-2">
    <!-- Complete Button with Confirmation (PRIMARY) -->
    <AlertDialog>
      <AlertDialogTrigger as-child>
        <Button size="sm" :disabled="loading" @click.stop>
          <Loader2 v-if="loading" class="h-4 w-4 animate-spin" />
          <Check v-else class="h-4 w-4" />
          Complete
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent><!-- same content as before --></AlertDialogContent>
    </AlertDialog>

    <!-- Dropdown for secondary actions -->
    <DropdownMenu>
      <DropdownMenuTrigger as-child>
        <Button variant="ghost" size="sm" :disabled="loading" @click.stop>
          <MoreVertical class="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem @click="emit('revert')">
          <RotateCcw class="h-4 w-4 mr-2" />
          Return to Queue
        </DropdownMenuItem>
        <DropdownMenuItem variant="destructive" @click="showCancelDialog = true">
          <X class="h-4 w-4 mr-2" />
          Cancel
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  </div>

  <!-- Cancel confirmation dialog (controlled by ref) -->
  <AlertDialog :open="showCancelDialog" @update:open="showCancelDialog = $event">
    <AlertDialogContent><!-- same cancel dialog content --></AlertDialogContent>
  </AlertDialog>
</template>
```

6. For non-processing state, keep existing template but ensure Cancel uses ghost variant (it already does).
  </action>
  <verify>
    Run `npx nuxi typecheck` - no new errors
  </verify>
  <done>
    ActionButtons conditionally renders dropdown for processing orders.
    Processing orders show Complete as primary button.
    Processing orders have MoreVertical dropdown with Return to Queue and Cancel.
    Non-processing orders use existing inline button pattern.
    Cancel action uses ghost variant throughout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update columns.ts to pass revert callback</name>
  <files>staff/app/components/dashboard/columns.ts</files>
  <action>
Update columns.ts to support the new revert action:

1. Add onRevert to ColumnCallbacks interface:
   ```typescript
   export interface ColumnCallbacks {
     gates: Array<{ id: string; gate_number: number; queue_count: number }>
     pendingIds: Record<string, boolean>
     onGateSelect: (requestId: string, gateId: string) => void
     onComplete: (requestId: string) => void
     onCancel: (requestId: string) => void
     onRevert: (requestId: string) => void  // Add this
   }
   ```

2. Update the actions column cell to pass onRevert to ActionButtons:
   ```typescript
   {
     id: 'actions',
     header: '',
     cell: ({ row }) => {
       return h(ActionButtons, {
         status: row.original.status,
         loading: callbacks.pendingIds[row.original.id] ?? false,
         onComplete: () => callbacks.onComplete(row.original.id),
         onCancel: () => callbacks.onCancel(row.original.id),
         onRevert: () => callbacks.onRevert(row.original.id),  // Add this
       })
     },
   }
   ```
  </action>
  <verify>
    Run `npx nuxi typecheck` - no new errors
  </verify>
  <done>
    ColumnCallbacks interface includes onRevert.
    ActionButtons receives onRevert prop in columns definition.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up revert handler in index.vue</name>
  <files>staff/app/pages/index.vue</files>
  <action>
Update index.vue to pass the revert handler to columns:

1. Update the columns computed to include onRevert callback:
   ```typescript
   const columns = computed(() => createColumns({
     gates: activeGates.value,
     pendingIds: pending.value,
     onGateSelect: handleGateSelect,
     onComplete: handleComplete,
     onCancel: handleCancel,
     onRevert: handleProcessingRevert,  // Add this - reuse existing handler
   }))
   ```

Note: The handleProcessingRevert handler already exists in index.vue (line 123-126) and calls revertToQueue from useQueueActions. No new handler needed.
  </action>
  <verify>
    Run `npx nuxi typecheck` - no new errors
    Run dev server and verify:
    1. Processing orders in DataTable show Complete button and dropdown icon
    2. Clicking dropdown shows "Return to Queue" and "Cancel" options
    3. Return to Queue reverts order to IN_QUEUE status
    4. Cancel shows confirmation dialog
  </verify>
  <done>
    columns computed passes onRevert: handleProcessingRevert.
    Processing orders in DataTable show dropdown with secondary actions.
    Return to Queue action works correctly.
    Cancel action shows confirmation and works correctly.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Type check passes: `npx nuxi typecheck`
2. Dev server runs without errors: `npm run dev`
3. Visual verification at http://localhost:3000:
   - Processing orders in DataTable show:
     - "Complete" as primary button (not outline variant)
     - Three-dot menu icon (MoreVertical) for dropdown
   - Clicking dropdown shows:
     - "Return to Queue" option with rotate icon
     - "Cancel" option in red/destructive styling
   - Non-processing orders show existing inline buttons
   - Cancel button uses ghost variant for all order states
</verification>

<success_criteria>
- Processing orders in DataTable show Complete as primary visible button
- Processing orders have dropdown with Return to Queue and Cancel options
- Return to Queue action correctly reverts order to queue
- Cancel action shows confirmation dialog before canceling
- Non-processing orders maintain existing inline button pattern
- Cancel action uses ghost variant throughout all states
- Type checking passes with no new errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-dashboard-polish/21-02-SUMMARY.md`
</output>
