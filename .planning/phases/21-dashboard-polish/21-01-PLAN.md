---
phase: 21-dashboard-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/pages/index.vue
  - staff/app/components/dashboard/NowProcessingSection.vue
  - staff/app/composables/useDashboardData.ts
  - staff/app/components/dashboard/ShowUnassignedToggle.vue
autonomous: true

must_haves:
  truths:
    - "Dashboard tabs contain only 'All' and per-gate tabs (no 'Manage Gates')"
    - "User can toggle 'Show only unassigned' to filter orders without gate assignment"
    - "Processing section shows a table with one row per active gate"
    - "Processing table shows order info when gate is busy, 'Idle' when idle"
  artifacts:
    - path: "staff/app/pages/index.vue"
      provides: "Dashboard page with tabs and processing section"
      contains: "TabsTrigger v-for"
    - path: "staff/app/components/dashboard/NowProcessingSection.vue"
      provides: "Table-based processing display with idle states"
      contains: "TableRow v-for"
    - path: "staff/app/composables/useDashboardData.ts"
      provides: "Dashboard computed data including unassigned filter"
      exports: ["useDashboardData"]
    - path: "staff/app/components/dashboard/ShowUnassignedToggle.vue"
      provides: "Toggle for filtering unassigned orders"
      contains: "Switch"
  key_links:
    - from: "staff/app/pages/index.vue"
      to: "useDashboardData"
      via: "composable import"
      pattern: "useDashboardData\\(showCompleted, showOnlyUnassigned\\)"
    - from: "staff/app/components/dashboard/NowProcessingSection.vue"
      to: "Table components"
      via: "shadcn Table"
      pattern: "TableRow.*v-for.*gate"
---

<objective>
Update dashboard tabs and processing section for clean UX

Purpose: Remove outdated "Manage Gates" tab (moved to /gates in Phase 20), add unassigned filter toggle, and convert processing section from cards to table with one row per active gate.
Output: Dashboard with proper tab structure and table-based processing section showing all active gates.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-dashboard-polish/21-CONTEXT.md
@.planning/phases/21-dashboard-polish/21-RESEARCH.md

# Source files to modify
@staff/app/pages/index.vue
@staff/app/components/dashboard/NowProcessingSection.vue
@staff/app/composables/useDashboardData.ts
@staff/app/components/dashboard/ShowCompletedToggle.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShowUnassignedToggle and update useDashboardData</name>
  <files>
    staff/app/components/dashboard/ShowUnassignedToggle.vue
    staff/app/composables/useDashboardData.ts
  </files>
  <action>
1. Create ShowUnassignedToggle.vue (copy pattern from ShowCompletedToggle.vue):
   - Switch component with v-model
   - Label text: "Show only unassigned"
   - Use defineModel pattern: `defineModel<boolean>('showOnlyUnassigned', { default: false })`

2. Update useDashboardData.ts:
   - Add second parameter `showOnlyUnassigned: Ref<boolean>` to function signature
   - Add new computed `activeGatesForProcessing` that returns sortedActiveGates with processing status info:
     ```typescript
     interface ProcessingGateRow {
       id: string
       gate_number: number
       order: ProcessingItem | null  // null means idle
     }
     ```
   - Use computed Map pattern (from GatesTable.vue) for O(1) processing order lookup
   - Modify `filteredRequests` computed to also respect `showOnlyUnassigned`:
     - When true: filter to requests where `assigned_gate_id === null`
     - Apply this filter AFTER the showCompleted filter
  </action>
  <verify>
    Run `npx nuxi typecheck` - should pass with no new errors (pre-existing errors in native-select and gate/[id].vue are expected)
  </verify>
  <done>
    ShowUnassignedToggle.vue exists with Switch component.
    useDashboardData accepts showOnlyUnassigned parameter and exports activeGatesForProcessing.
    filteredRequests respects both showCompleted and showOnlyUnassigned toggles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert NowProcessingSection to table format</name>
  <files>staff/app/components/dashboard/NowProcessingSection.vue</files>
  <action>
Rewrite NowProcessingSection.vue to use table format with one row per active gate:

1. Update imports to include Table components:
   ```typescript
   import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
   ```

2. Update props interface:
   ```typescript
   interface ProcessingGateRow {
     id: string
     gate_number: number
     order: {
       id: string
       sales_order_number: string
       company_name: string | null
       processing_started_at: string
     } | null
   }

   const props = defineProps<{
     gates: ProcessingGateRow[]
     loading: Record<string, boolean>
   }>()
   ```

3. Update emits - keep existing pattern:
   ```typescript
   const emit = defineEmits<{
     complete: [requestId: string, gateId: string]
     revert: [requestId: string]
     rowClick: [requestId: string]
   }>()
   ```

4. Replace card template with table:
   - Table header: Gate, Order, Company, Status, Actions
   - For each gate row:
     - Gate column: "Gate {gate_number}"
     - If gate.order exists:
       - Order column: sales_order_number
       - Company column: company_name || 'N/A'
       - Status column: StatusBadge with PROCESSING status
       - Actions column: Complete button + Return to Queue button (keep current action buttons, Plan 02 handles dropdown)
     - If gate.order is null (idle):
       - Order column: "Idle" with muted italic styling (`class="text-muted-foreground italic"`)
       - Company column: dash or empty
       - Status column: empty or dash
       - Actions column: empty

5. Keep click handler on row for non-idle rows:
   ```vue
   <TableRow
     v-for="gate in gates"
     :key="gate.id"
     :class="{ 'cursor-pointer hover:bg-accent/50': gate.order }"
     @click="gate.order && emit('rowClick', gate.order.id)"
   >
   ```

6. Use @click.stop on action buttons to prevent row click propagation.
  </action>
  <verify>
    Run `npx nuxi typecheck` - no new errors
    Start dev server: `npm run dev` and verify NowProcessingSection renders (may show "No active processing" until wired up in Task 3)
  </verify>
  <done>
    NowProcessingSection uses Table components.
    Shows one row per gate passed in props.
    Idle gates show "Idle" text in muted styling.
    Action buttons have @click.stop to prevent row click propagation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update index.vue tabs and wire up new components</name>
  <files>staff/app/pages/index.vue</files>
  <action>
1. Remove "Manage Gates" tab and its content:
   - Delete: `<TabsTrigger value="manage">Manage Gates</TabsTrigger>`
   - Delete: `<TabsContent value="manage" class="mt-4">..GateManagement..</TabsContent>`
   - Remove GateManagement import (no longer used on dashboard)
   - Remove handleCreateGate and handleToggleGateActive handlers (no longer used)
   - Remove createGate and toggleGateActive from useGateManagement destructuring

2. Add showOnlyUnassigned state:
   ```typescript
   const showOnlyUnassigned = ref(false)
   ```

3. Update useDashboardData call to pass both toggles:
   ```typescript
   const { currentlyWaiting, chartData, processingItems, gatesWithQueues, filteredRequests, activeGatesForProcessing } = useDashboardData(showCompleted, showOnlyUnassigned)
   ```

4. Add ShowUnassignedToggle next to ShowCompletedToggle in "All Requests" tab:
   ```vue
   <TabsContent value="all" class="mt-4">
     <div class="flex justify-end gap-4 mb-4">
       <ShowUnassignedToggle v-model:showOnlyUnassigned="showOnlyUnassigned" />
       <ShowCompletedToggle v-model:showCompleted="showCompleted" />
     </div>
     <DataTable ... />
   </TabsContent>
   ```

5. Update NowProcessingSection usage:
   - Change from `:items="processingItems"` to `:gates="activeGatesForProcessing"`
   - Keep existing event handlers (complete, revert, row-click)
   - Remove the `v-if="processingItems.length > 0"` condition (always show section with active gates)

6. Import ShowUnassignedToggle:
   ```typescript
   import ShowUnassignedToggle from '@/components/dashboard/ShowUnassignedToggle.vue'
   ```
  </action>
  <verify>
    Run `npx nuxi typecheck` - no new errors
    Run dev server and verify:
    1. No "Manage Gates" tab visible
    2. "Show only unassigned" toggle appears above table in All tab
    3. Processing section shows table with all active gates
    4. Idle gates show "Idle" text
    5. Gates with processing orders show order info
  </verify>
  <done>
    "Manage Gates" tab removed from dashboard.
    ShowUnassignedToggle appears above DataTable in All tab.
    Toggling "Show only unassigned" filters to orders without gate assignment.
    NowProcessingSection shows table with one row per active gate.
    Idle gates display "Idle" in muted styling.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Type check passes: `npx nuxi typecheck`
2. Dev server runs without errors: `npm run dev`
3. Visual verification:
   - Dashboard loads at http://localhost:3000
   - No "Manage Gates" tab in tab list
   - "Show only unassigned" toggle visible in All tab
   - Processing section shows table format
   - All active gates appear in processing table (busy and idle)
</verification>

<success_criteria>
- Dashboard tabs contain only "All Requests" and per-gate tabs (Gate 1, Gate 2, etc.)
- "Show only unassigned" toggle filters the All Requests view
- Processing section is table-based with one row per active gate
- Idle gates display "Idle" text in muted/italic styling
- Gates with processing orders display order info (order #, company, status badge)
- Type checking passes with no new errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-dashboard-polish/21-01-SUMMARY.md`
</output>
