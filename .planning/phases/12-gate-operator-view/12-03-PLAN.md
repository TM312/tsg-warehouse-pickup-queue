---
phase: 12-gate-operator-view
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - staff/app/pages/gate/[id].vue
  - staff/app/components/gate/NextUpPreview.vue
autonomous: true

must_haves:
  truths:
    - "Gate operator sees next pickup (position 2) with sales order number preview"
    - "Gate operator sees queue count ('X more in queue') when multiple pickups"
    - "Gate view updates in real-time when queue changes (new assignments, completions)"
    - "Smooth transition animation when current pickup completes and next advances"
  artifacts:
    - path: "staff/app/components/gate/NextUpPreview.vue"
      provides: "Next-up pickup preview component"
      min_lines: 20
    - path: "staff/app/pages/gate/[id].vue"
      provides: "Updated with realtime subscription and transitions"
      contains: "useRealtimeQueue"
  key_links:
    - from: "staff/app/pages/gate/[id].vue"
      to: "useRealtimeQueue"
      via: "composable for realtime subscription"
      pattern: "useRealtimeQueue\\(\\)"
    - from: "staff/app/pages/gate/[id].vue"
      to: "NextUpPreview"
      via: "component import"
      pattern: "NextUpPreview"
---

<objective>
Add next-up preview, queue count, real-time updates, and transition animations.

Purpose: Gate operators need to see what's coming next and receive live updates as the queue changes, with smooth visual transitions when advancing to the next pickup.

Output: NextUpPreview component showing position 2, queue count display, realtime subscription, and Vue Transition for smooth content changes.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/12-gate-operator-view/12-01-SUMMARY.md

# Key source files
@staff/app/composables/useRealtimeQueue.ts
@staff/app/pages/gate/[id].vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NextUpPreview component and add queue count</name>
  <files>
staff/app/components/gate/NextUpPreview.vue
staff/app/pages/gate/[id].vue
  </files>
  <action>
**Create NextUpPreview.vue** at `staff/app/components/gate/NextUpPreview.vue`:

1. Define props:
```typescript
const props = defineProps<{
  salesOrderNumber: string
}>()
```

2. Layout structure:
```vue
<template>
  <Card>
    <CardContent class="p-4">
      <p class="font-mono font-medium text-lg">{{ salesOrderNumber }}</p>
    </CardContent>
  </Card>
</template>
```

3. Import Card, CardContent from @/components/ui/card

**Update gate page** to add next-up preview and queue count:

1. Add `nextUp` computed property (if not already present):
```typescript
const nextUp = computed(() => {
  return pickups.value?.find(p => p.queue_position === 2 && p.status === 'in_queue') ?? null
})
```

2. Add `queueCount` computed property:
```typescript
const queueCount = computed(() => {
  // Count of in_queue items (excludes processing)
  return pickups.value?.filter(p => p.status === 'in_queue').length ?? 0
})
```

3. Add next-up section to template (below action buttons, when nextUp exists):
```vue
<div v-if="nextUp" class="mt-6">
  <h3 class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-2">
    <Users class="h-4 w-4" />
    Next Up
  </h3>
  <NextUpPreview :sales-order-number="nextUp.sales_order_number" />
</div>
```

4. Add queue count below next-up preview (only when more than 1 in queue):
```vue
<p v-if="queueCount > 1" class="text-center text-sm text-muted-foreground mt-4">
  {{ queueCount - 1 }} more in queue
</p>
```

5. Import Users icon from lucide-vue-next
6. Import NextUpPreview component
  </action>
  <verify>
1. Assign 3+ pickups to a gate via dashboard
2. Navigate to /gate/{uuid}
3. Current pickup shows at top
4. "Next Up" section shows with position 2's sales order number
5. Queue count shows "X more in queue"
  </verify>
  <done>NextUpPreview shows position 2 sales order, queue count shows remaining pickups</done>
</task>

<task type="auto">
  <name>Task 2: Add real-time subscription for queue updates</name>
  <files>staff/app/pages/gate/[id].vue</files>
  <action>
Add realtime subscription to the gate page:

1. Import useRealtimeQueue:
```typescript
import { useRealtimeQueue } from '@/composables/useRealtimeQueue'
```

2. Initialize realtime composable:
```typescript
const { status: realtimeStatus, subscribe, unsubscribe } = useRealtimeQueue()
```

3. Set up subscription in onMounted:
```typescript
onMounted(() => {
  subscribe(() => {
    // Refresh pickups when any change occurs
    refreshPickups()
  })
})
```

4. Clean up in onUnmounted:
```typescript
onUnmounted(() => {
  unsubscribe()
})
```

5. Ensure the pickups query has a named refresh function:
```typescript
const { data: pickups, refresh: refreshPickups, pending: pickupsLoading } = await useAsyncData(...)
```

6. Optionally add connection status indicator (small, non-intrusive):
```vue
<!-- In header or footer -->
<div v-if="realtimeStatus !== 'connected'" class="text-xs text-amber-500">
  {{ realtimeStatus === 'connecting' ? 'Connecting...' : 'Reconnecting...' }}
</div>
```

Note: The existing useRealtimeQueue subscribes to ALL pickup_requests changes. This is fine for our expected volume (50-100/day). The local computed properties (currentPickup, nextUp) automatically filter to this gate.
  </action>
  <verify>
1. Open gate view in one browser tab
2. In another tab, use dashboard to:
   - Add a new pickup to this gate
   - Complete a pickup at another gate
   - Reorder the queue
3. Gate view should update automatically without refresh
4. Connection status shows when reconnecting
  </verify>
  <done>Gate view receives real-time updates when queue changes</done>
</task>

<task type="auto">
  <name>Task 3: Add transition animation for smooth pickup advance</name>
  <files>staff/app/pages/gate/[id].vue</files>
  <action>
Add Vue Transition for smooth visual change when current pickup changes:

1. Wrap the CurrentPickup component in a Transition:
```vue
<Transition name="pickup-advance" mode="out-in">
  <CurrentPickup
    v-if="currentPickup"
    :key="currentPickup.id"
    :sales-order-number="currentPickup.sales_order_number"
    :company-name="currentPickup.company_name"
    :status="currentPickup.status"
    :processing-started-at="currentPickup.processing_started_at"
    :item-count="currentPickup.item_count"
    :po-number="currentPickup.po_number"
  />
  <EmptyGateState v-else />
</Transition>
```

Key points:
- `:key="currentPickup.id"` ensures transition triggers when pickup changes
- `mode="out-in"` waits for old content to leave before new enters
- Name "pickup-advance" for our custom transition classes

2. Add transition styles in a `<style>` block:
```vue
<style scoped>
.pickup-advance-enter-active,
.pickup-advance-leave-active {
  transition: all 0.2s ease;
}

.pickup-advance-enter-from {
  opacity: 0;
  transform: translateY(10px);
}

.pickup-advance-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}
</style>
```

This creates a subtle slide-up effect:
- Old pickup slides up and fades out
- New pickup slides up from below and fades in
- 200ms duration feels snappy

3. Also wrap the action buttons in a transition (keyed on currentPickup.id) so they animate together with the pickup change.
  </action>
  <verify>
1. Have 2+ pickups in queue
2. Complete the current pickup
3. Watch for smooth transition:
   - Current pickup fades/slides out
   - Next pickup fades/slides in
   - No jarring jump or flash
4. Animation should be quick (~200ms)
  </verify>
  <done>Smooth transition animation when current pickup completes and next advances</done>
</task>

</tasks>

<verification>
All verification commands run from project root:

1. Next-up preview:
   - Assign 2+ pickups to gate
   - Position 2 shows in "Next Up" section
   - Only sales order number visible (minimal detail)

2. Queue count:
   - Assign 3+ pickups
   - Shows "X more in queue" (count minus current minus next-up)
   - Count accurate

3. Real-time updates:
   - Open gate view and dashboard in separate tabs
   - Add pickup to gate via dashboard
   - Gate view updates automatically
   - Complete pickup in gate view
   - Queue count updates in real-time

4. Transition animation:
   - Complete current pickup
   - Smooth fade/slide transition to next
   - No flash of empty state
   - Animation duration ~200ms

5. Empty state transition:
   - Complete last pickup in queue
   - Smooth transition to empty state
</verification>

<success_criteria>
- NextUpPreview shows position 2's sales order number only
- Queue count shows "X more in queue" when applicable
- Real-time subscription via useRealtimeQueue refreshes on changes
- Transition animation provides smooth visual feedback (200ms fade + slide)
- Connection status indicator shows when reconnecting
- No jarring visual jumps when queue advances
</success_criteria>

<output>
After completion, create `.planning/phases/12-gate-operator-view/12-03-SUMMARY.md`
</output>
