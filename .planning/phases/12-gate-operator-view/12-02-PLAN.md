---
phase: 12-gate-operator-view
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - staff/app/pages/gate/[id].vue
  - staff/app/components/gate/CompleteDialog.vue
  - staff/app/composables/useQueueActions.ts
  - supabase/migrations/20260130210000_compact_queue_positions.sql
autonomous: true

must_haves:
  truths:
    - "Gate operator can tap 'Start Processing' to accept current pickup without confirmation"
    - "Gate operator can tap 'Complete' which opens a confirmation dialog before finalizing"
    - "Gate operator can tap 'Return to Queue' (secondary action) to revert processing pickup"
    - "All action buttons are at least 44px tall for mobile touch targets"
    - "Buttons disable during pending state to prevent double-tap"
    - "Queue positions compact after completion so position 2 becomes position 1 (PROC-05)"
  artifacts:
    - path: "staff/app/components/gate/CompleteDialog.vue"
      provides: "Confirmation dialog for completing pickup"
      min_lines: 30
    - path: "staff/app/pages/gate/[id].vue"
      provides: "Updated with action buttons and handlers"
      contains: "handleStartProcessing"
    - path: "supabase/migrations/20260130210000_compact_queue_positions.sql"
      provides: "Database function for queue position compaction"
      contains: "compact_queue_positions"
  key_links:
    - from: "staff/app/pages/gate/[id].vue"
      to: "useQueueActions"
      via: "composable import and method calls"
      pattern: "useQueueActions\\(\\)"
    - from: "CompleteDialog.vue"
      to: "AlertDialog"
      via: "shadcn-vue component"
      pattern: "AlertDialog"
    - from: "staff/app/composables/useQueueActions.ts"
      to: "compact_queue_positions"
      via: "RPC call after completion"
      pattern: "rpc\\('compact_queue_positions'"
---

<objective>
Add quick action buttons for Start Processing, Complete, and Return to Queue with touch-optimized sizing.

Purpose: Gate operators need single-tap actions to move pickups through the workflow efficiently on mobile devices.

Output: Working action buttons with 44px+ touch targets, Complete confirmation dialog, and proper pending state handling.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/12-gate-operator-view/12-01-SUMMARY.md

# Key source files
@staff/app/composables/useQueueActions.ts
@staff/app/pages/gate/[id].vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add action buttons to gate page</name>
  <files>staff/app/pages/gate/[id].vue</files>
  <action>
Update the gate page to add action buttons:

1. Import useQueueActions composable:
```typescript
const { pending, startProcessing, revertToQueue, completeRequest } = useQueueActions()
```

2. Create actionPending computed:
```typescript
const actionPending = computed(() => {
  return currentPickup.value ? pending.value[currentPickup.value.id] : false
})
```

3. Add ref for dialog state:
```typescript
const showCompleteDialog = ref(false)
```

4. Create action handlers:

```typescript
async function handleStartProcessing() {
  if (!currentPickup.value || !gate.value) return
  await startProcessing(currentPickup.value.id, gate.value.id)
  await refresh()  // refresh pickups data
}

async function handleRevert() {
  if (!currentPickup.value) return
  await revertToQueue(currentPickup.value.id)
  await refresh()
}

async function handleComplete() {
  if (!currentPickup.value) return
  showCompleteDialog.value = false
  await completeRequest(currentPickup.value.id)
  await refresh()
}
```

5. Add action buttons section below CurrentPickup (when currentPickup exists):

```vue
<div v-if="currentPickup" class="space-y-3 mt-6">
  <!-- Start Processing (only when in_queue) -->
  <Button
    v-if="currentPickup.status === 'in_queue'"
    class="h-14 w-full text-lg"
    :disabled="actionPending"
    @click="handleStartProcessing"
  >
    <Play class="h-6 w-6 mr-2" />
    Start Processing
  </Button>

  <!-- Complete (only when processing) -->
  <Button
    v-if="currentPickup.status === 'processing'"
    class="h-14 w-full text-lg"
    :disabled="actionPending"
    @click="showCompleteDialog = true"
  >
    <CheckCircle class="h-6 w-6 mr-2" />
    Complete
  </Button>

  <!-- Revert to Queue (secondary, only when processing) -->
  <Button
    v-if="currentPickup.status === 'processing'"
    variant="outline"
    class="h-11 w-full"
    :disabled="actionPending"
    @click="handleRevert"
  >
    <RotateCcw class="h-5 w-5 mr-2" />
    Return to Queue
  </Button>
</div>
```

6. Import icons from lucide-vue-next:
   - Play (for Start Processing)
   - CheckCircle (for Complete)
   - RotateCcw (for Return to Queue)

7. Import CompleteDialog component (to be created next) and add to template:
```vue
<CompleteDialog
  v-model:open="showCompleteDialog"
  :sales-order-number="currentPickup?.sales_order_number ?? ''"
  :company-name="currentPickup?.company_name ?? null"
  @confirm="handleComplete"
/>
```

Note: h-14 = 56px (> 44px minimum), h-11 = 44px (exactly minimum for secondary action)
  </action>
  <verify>
1. Navigate to /gate/{uuid} with a pickup in in_queue status:
   - "Start Processing" button shows (large, primary color)
   - Tap Start Processing - status changes to processing
   - Toast shows "Processing started"

2. With pickup in processing status:
   - "Complete" button shows (large, primary)
   - "Return to Queue" button shows (smaller, outline)
   - Tap Return to Queue - status reverts to in_queue
   - Toast shows "Returned to queue"
  </verify>
  <done>Action buttons render with correct sizing (h-14, h-11) and trigger appropriate actions</done>
</task>

<task type="auto">
  <name>Task 2: Create CompleteDialog component</name>
  <files>staff/app/components/gate/CompleteDialog.vue</files>
  <action>
Create the confirmation dialog at `staff/app/components/gate/CompleteDialog.vue`:

1. Import AlertDialog components from shadcn-vue:
```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
```

2. Define props and emits:
```typescript
const props = defineProps<{
  open: boolean
  salesOrderNumber: string
  companyName: string | null
}>()

const emit = defineEmits<{
  'update:open': [value: boolean]
  'confirm': []
}>()
```

3. Create open model:
```typescript
const isOpen = computed({
  get: () => props.open,
  set: (value) => emit('update:open', value)
})
```

4. Template structure:
```vue
<AlertDialog v-model:open="isOpen">
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Complete Pickup?</AlertDialogTitle>
      <AlertDialogDescription>
        Order <span class="font-mono font-semibold">{{ salesOrderNumber }}</span>
        for <span class="font-semibold">{{ companyName || 'Customer' }}</span>
        will be marked as complete.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction @click="emit('confirm')">
        Complete
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

5. Make action buttons touch-friendly with h-11 class minimum
  </action>
  <verify>
1. Navigate to /gate/{uuid} with processing pickup
2. Tap "Complete" button
3. Dialog opens showing:
   - "Complete Pickup?" title
   - Order number and company in description
   - Cancel and Complete buttons
4. Tap Cancel - dialog closes, no action taken
5. Tap Complete - pickup marked complete, toast shows
  </verify>
  <done>CompleteDialog shows order details and requires confirmation before completing</done>
</task>

<task type="auto">
  <name>Task 3: Fix completeRequest to clear processing_started_at</name>
  <files>staff/app/composables/useQueueActions.ts</files>
  <action>
Update the completeRequest function to also clear processing_started_at:

Find the completeRequest function and update the update call:

```typescript
async function completeRequest(requestId: string): Promise<void> {
  pending.value[requestId] = true
  try {
    const { error } = await client
      .from('pickup_requests')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString(),
        queue_position: null,
        assigned_gate_id: null,
        processing_started_at: null,  // ADD THIS LINE
      })
      .eq('id', requestId)

    if (error) throw error
    toast.success('Pickup marked complete')
  } catch (e) {
    toast.error('Failed to complete pickup')
    throw e
  } finally {
    pending.value[requestId] = false
  }
}
```

This ensures processing_started_at is cleared when a pickup is completed, keeping data clean.
  </action>
  <verify>
1. Start processing a pickup via dashboard or gate view
2. Complete the pickup
3. Check Supabase Studio or query: processing_started_at should be null for completed pickup
  </verify>
  <done>completeRequest clears processing_started_at when completing a pickup</done>
</task>

<task type="auto">
  <name>Task 4: Create compact_queue_positions database function and call from completeRequest</name>
  <files>
supabase/migrations/20260130210000_compact_queue_positions.sql
staff/app/composables/useQueueActions.ts
  </files>
  <action>
**PROC-05 requirement:** When a pickup completes, remaining pickups at that gate must shift up so position 2 becomes position 1, position 3 becomes position 2, etc. This is required because start_processing enforces "only position 1 can start processing."

**Part 1: Create database function**

Create migration file `supabase/migrations/20260130210000_compact_queue_positions.sql`:

```sql
-- Compact queue positions at a gate after a pickup completes
-- Shifts all positions down by 1 (position 2 -> 1, 3 -> 2, etc.)
-- PROC-05: Auto-advance to next pickup after completing current

CREATE OR REPLACE FUNCTION compact_queue_positions(p_gate_id uuid)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Shift all queue positions down by 1 for pickups at this gate
    -- Only affects in_queue pickups (processing keeps position until complete)
    UPDATE pickup_requests
    SET queue_position = queue_position - 1
    WHERE assigned_gate_id = p_gate_id
      AND status = 'in_queue'
      AND queue_position IS NOT NULL
      AND queue_position > 1;
END;
$$;

-- Grant execute permission to authenticated users (staff)
GRANT EXECUTE ON FUNCTION compact_queue_positions(uuid) TO authenticated;
```

**Part 2: Update completeRequest to call compact_queue_positions**

In `staff/app/composables/useQueueActions.ts`, update completeRequest to:

1. Store the gate_id before completing (need it for compaction)
2. After successful update, call compact_queue_positions RPC

```typescript
async function completeRequest(requestId: string, gateId?: string): Promise<void> {
  pending.value[requestId] = true
  try {
    const { error } = await client
      .from('pickup_requests')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString(),
        queue_position: null,
        assigned_gate_id: null,
        processing_started_at: null,
      })
      .eq('id', requestId)

    if (error) throw error

    // Compact queue positions if gate was provided (PROC-05)
    if (gateId) {
      const { error: compactError } = await client.rpc('compact_queue_positions', {
        p_gate_id: gateId
      })
      if (compactError) {
        console.error('Failed to compact queue positions:', compactError)
        // Don't throw - pickup is already completed, this is cleanup
      }
    }

    toast.success('Pickup marked complete')
  } catch (e) {
    toast.error('Failed to complete pickup')
    throw e
  } finally {
    pending.value[requestId] = false
  }
}
```

**Part 3: Update handleComplete in gate page to pass gateId**

In Task 1's handleComplete function (and any other callers), pass the gate ID:

```typescript
async function handleComplete() {
  if (!currentPickup.value) return
  showCompleteDialog.value = false
  await completeRequest(currentPickup.value.id, gate.value?.id)
  await refresh()
}
```

Note: The gateId parameter is optional in completeRequest to maintain backward compatibility with dashboard callers that may not have gate context. For dashboard completions, the supervisor may complete from a different context, but the gate view always has the gate ID available.
  </action>
  <verify>
1. Assign 3 pickups to a gate (positions 1, 2, 3)
2. Start processing position 1
3. Complete the pickup
4. Query pickup_requests: position 2 should now be position 1, position 3 should be position 2
5. Verify the new position 1 can start processing (the start_processing constraint is satisfied)

```sql
-- Before complete: positions 1, 2, 3 at gate
-- After complete: positions 1, 2 at gate (old 2 and 3)
SELECT id, queue_position, status FROM pickup_requests
WHERE assigned_gate_id = 'your-gate-id'
ORDER BY queue_position;
```
  </verify>
  <done>Queue positions compact when a pickup completes, enabling next pickup to start processing (PROC-05)</done>
</task>

</tasks>

<verification>
All verification commands run from project root:

1. Start Processing flow:
   - Navigate to /gate/{uuid} with in_queue pickup
   - Tap Start Processing (no dialog)
   - Status changes to processing immediately
   - Toast confirms action

2. Complete flow with confirmation:
   - With processing pickup, tap Complete
   - Dialog shows order details
   - Tap Complete in dialog
   - Pickup removed from view
   - Toast confirms completion

3. Return to Queue flow:
   - With processing pickup, tap Return to Queue
   - Status reverts to in_queue
   - Position preserved (still position 1)
   - Toast confirms action

4. Touch target sizing:
   - Primary buttons (Start, Complete) are visibly larger
   - All buttons easily tappable on mobile

5. Pending state:
   - Double-tap any button - only one action fires
   - Buttons disable during action

6. Queue position compaction (PROC-05):
   - Assign 3 pickups to gate (positions 1, 2, 3)
   - Complete position 1
   - Verify position 2 is now position 1, position 3 is now position 2
   - New position 1 can successfully start processing
</verification>

<success_criteria>
- "Start Processing" button (h-14, 56px) triggers immediate action without dialog
- "Complete" button (h-14, 56px) opens confirmation dialog before completing
- "Return to Queue" button (h-11, 44px) is de-emphasized but accessible
- CompleteDialog shows order number and company for verification
- Buttons disable during pending state to prevent double-tap
- completeRequest also clears processing_started_at
- Queue positions compact after completion (position 2 becomes 1) - PROC-05
- Toast notifications confirm each action
</success_criteria>

<output>
After completion, create `.planning/phases/12-gate-operator-view/12-02-SUMMARY.md`
</output>
