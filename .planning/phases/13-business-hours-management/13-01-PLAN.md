---
phase: 13-business-hours-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260130000001_create_business_closures_table.sql
  - supabase/migrations/20260130000002_create_business_settings_table.sql
  - staff/app/composables/useBusinessHoursSettings.ts
  - staff/app/pages/settings/business-hours.vue
  - staff/app/components/business-hours/WeeklyScheduleEditor.vue
  - staff/app/components/business-hours/DayScheduleRow.vue
autonomous: true

must_haves:
  truths:
    - "Supervisor can view current weekly schedule at /settings/business-hours"
    - "Supervisor can edit open/close times for each day using time inputs"
    - "Supervisor can toggle a day closed/open with a switch"
    - "Changes save to database and take effect immediately"
  artifacts:
    - path: "supabase/migrations/20260130000001_create_business_closures_table.sql"
      provides: "business_closures table for holiday scheduling"
      contains: "CREATE TABLE business_closures"
    - path: "supabase/migrations/20260130000002_create_business_settings_table.sql"
      provides: "business_settings table for override and config"
      contains: "CREATE TABLE business_settings"
    - path: "staff/app/composables/useBusinessHoursSettings.ts"
      provides: "CRUD operations for business hours"
      exports: ["useBusinessHoursSettings"]
    - path: "staff/app/pages/settings/business-hours.vue"
      provides: "Settings page for business hours configuration"
      min_lines: 50
    - path: "staff/app/components/business-hours/WeeklyScheduleEditor.vue"
      provides: "7-day schedule editor component"
      min_lines: 40
    - path: "staff/app/components/business-hours/DayScheduleRow.vue"
      provides: "Single day row with toggle and time inputs"
      min_lines: 30
  key_links:
    - from: "staff/app/pages/settings/business-hours.vue"
      to: "useBusinessHoursSettings"
      via: "composable import"
      pattern: "useBusinessHoursSettings"
    - from: "staff/app/composables/useBusinessHoursSettings.ts"
      to: "business_hours"
      via: "Supabase client"
      pattern: "from\\(['\"]business_hours['\"]\\)"
---

<objective>
Create the weekly schedule editor foundation for business hours management.

Purpose: Supervisors need to configure regular weekly business hours. This plan establishes the database schema for closures/settings (needed by Plan 02) and builds the primary settings UI for editing the 7-day weekly schedule.

Output:
- Database migrations for business_closures and business_settings tables
- /settings/business-hours page with weekly schedule editor
- useBusinessHoursSettings composable for CRUD operations
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-business-hours-management/13-CONTEXT.md
@.planning/phases/13-business-hours-management/13-RESEARCH.md
@supabase/migrations/20260128000003_create_business_hours_table.sql
@staff/app/pages/settings.vue
@staff/app/components/ui/switch/Switch.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for closures and settings tables</name>
  <files>
    supabase/migrations/20260130000001_create_business_closures_table.sql
    supabase/migrations/20260130000002_create_business_settings_table.sql
  </files>
  <action>
Create two migration files:

**business_closures table (20260130000001):**
```sql
CREATE TABLE business_closures (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    start_date date NOT NULL,
    end_date date NOT NULL,
    reason text,
    created_at timestamptz NOT NULL DEFAULT now(),
    created_by uuid REFERENCES auth.users(id),
    CONSTRAINT valid_date_range CHECK (start_date <= end_date)
);

-- RLS policies: authenticated users can read, staff can write
ALTER TABLE business_closures ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read closures"
    ON business_closures FOR SELECT
    TO authenticated
    USING (true);

CREATE POLICY "Staff can manage closures"
    ON business_closures FOR ALL
    TO authenticated
    USING (
        EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('supervisor', 'admin'))
    )
    WITH CHECK (
        EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('supervisor', 'admin'))
    );
```

**business_settings table (20260130000002):**
```sql
CREATE TABLE business_settings (
    key text PRIMARY KEY,
    value jsonb NOT NULL,
    updated_at timestamptz NOT NULL DEFAULT now(),
    updated_by uuid REFERENCES auth.users(id)
);

-- Trigger for updated_at
CREATE TRIGGER business_settings_updated_at
    BEFORE UPDATE ON business_settings
    FOR EACH ROW
    EXECUTE FUNCTION extensions.moddatetime(updated_at);

-- Initial override setting
INSERT INTO business_settings (key, value) VALUES
    ('manual_override', '{"active": false, "expiresAt": null}');

-- RLS policies
ALTER TABLE business_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read settings"
    ON business_settings FOR SELECT
    TO authenticated
    USING (true);

CREATE POLICY "Staff can manage settings"
    ON business_settings FOR ALL
    TO authenticated
    USING (
        EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('supervisor', 'admin'))
    )
    WITH CHECK (
        EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('supervisor', 'admin'))
    );
```

Also add RLS policy for business_hours UPDATE if not present (check existing policies first).
  </action>
  <verify>
Run `supabase db reset` to apply migrations. Check tables exist:
```bash
supabase db reset
```
Then verify in Supabase Studio or via SQL that business_closures and business_settings tables exist.
  </verify>
  <done>
business_closures and business_settings tables exist with proper RLS policies. manual_override setting initialized.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useBusinessHoursSettings composable</name>
  <files>staff/app/composables/useBusinessHoursSettings.ts</files>
  <action>
Create composable for business hours CRUD operations:

```typescript
import { ref, readonly } from 'vue'
import { toast } from 'vue-sonner'

interface WeeklySchedule {
  dayOfWeek: number
  isClosed: boolean
  openTime: string  // HH:mm format
  closeTime: string
}

export function useBusinessHoursSettings() {
  const client = useSupabaseClient()
  const pending = ref(false)
  const weeklySchedule = ref<WeeklySchedule[]>([])

  // Initialize with all 7 days
  function initializeSchedule() {
    weeklySchedule.value = Array.from({ length: 7 }, (_, i) => ({
      dayOfWeek: i,
      isClosed: true,
      openTime: '08:00',
      closeTime: '17:00'
    }))
  }

  async function loadWeeklySchedule() {
    pending.value = true
    try {
      const { data, error } = await client
        .from('business_hours')
        .select('*')
        .order('day_of_week')

      if (error) throw error

      if (!data || data.length === 0) {
        initializeSchedule()
        return
      }

      // Map database format to UI format
      weeklySchedule.value = data.map(h => ({
        dayOfWeek: h.day_of_week,
        isClosed: h.is_closed,
        openTime: h.open_time.substring(0, 5),  // Remove seconds
        closeTime: h.close_time.substring(0, 5)
      }))
    } catch (e) {
      console.error('Failed to load business hours:', e)
      toast.error('Failed to load business hours')
      initializeSchedule()
    } finally {
      pending.value = false
    }
  }

  async function saveWeeklySchedule() {
    pending.value = true
    try {
      // Upsert each day
      for (const day of weeklySchedule.value) {
        const { error } = await client
          .from('business_hours')
          .upsert({
            day_of_week: day.dayOfWeek,
            is_closed: day.isClosed,
            open_time: day.openTime + ':00',  // Add seconds for time type
            close_time: day.closeTime + ':00'
          }, { onConflict: 'day_of_week' })

        if (error) throw error
      }
      toast.success('Business hours saved')
    } catch (e) {
      console.error('Failed to save business hours:', e)
      toast.error('Failed to save business hours')
    } finally {
      pending.value = false
    }
  }

  // Copy hours from one day to weekdays (Mon-Fri)
  function applyToWeekdays(sourceDayIndex: number) {
    const source = weeklySchedule.value[sourceDayIndex]
    // Days 1-5 are Mon-Fri
    for (let i = 1; i <= 5; i++) {
      weeklySchedule.value[i] = {
        ...weeklySchedule.value[i],
        isClosed: source.isClosed,
        openTime: source.openTime,
        closeTime: source.closeTime
      }
    }
  }

  // Copy hours from one day to all days
  function copyToAllDays(sourceDayIndex: number) {
    const source = weeklySchedule.value[sourceDayIndex]
    weeklySchedule.value = weeklySchedule.value.map(day => ({
      ...day,
      isClosed: source.isClosed,
      openTime: source.openTime,
      closeTime: source.closeTime
    }))
  }

  return {
    weeklySchedule,
    pending: readonly(pending),
    loadWeeklySchedule,
    saveWeeklySchedule,
    applyToWeekdays,
    copyToAllDays
  }
}
```

Handle time format normalization (browser may return HH:mm or HH:mm:ss). Always normalize to HH:mm before display and add :00 before save.
  </action>
  <verify>
TypeScript compilation passes: `cd staff && pnpm build`
  </verify>
  <done>
useBusinessHoursSettings composable exists with loadWeeklySchedule, saveWeeklySchedule, applyToWeekdays, copyToAllDays methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create settings page and weekly schedule editor components</name>
  <files>
    staff/app/pages/settings/business-hours.vue
    staff/app/components/business-hours/WeeklyScheduleEditor.vue
    staff/app/components/business-hours/DayScheduleRow.vue
  </files>
  <action>
Create the settings page and editor components:

**DayScheduleRow.vue:**
Single row for one day with:
- Day name label (Mon, Tue, etc.)
- Switch toggle for open/closed (checked = open, unchecked = closed)
- Two time inputs (open time, close time) - only visible when open
- Use native `<input type="time">` styled with Input component

**WeeklyScheduleEditor.vue:**
Container for 7 DayScheduleRow components:
- v-model binding to weeklySchedule array
- "Apply to Weekdays" button that copies current Monday hours to Tue-Fri
- Day names: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']

**business-hours.vue page:**
```vue
<script setup lang="ts">
definePageMeta({ middleware: 'auth' })

const { weeklySchedule, pending, loadWeeklySchedule, saveWeeklySchedule } = useBusinessHoursSettings()

// Load on mount
onMounted(() => {
  loadWeeklySchedule()
})
</script>

<template>
  <div class="max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Business Hours</h1>
      <Button @click="saveWeeklySchedule" :disabled="pending">
        {{ pending ? 'Saving...' : 'Save Changes' }}
      </Button>
    </div>

    <!-- Weekly Schedule Card -->
    <Card>
      <CardHeader>
        <CardTitle>Weekly Schedule</CardTitle>
        <CardDescription>Set your regular business hours for each day of the week</CardDescription>
      </CardHeader>
      <CardContent>
        <WeeklyScheduleEditor v-model="weeklySchedule" />
      </CardContent>
    </Card>
  </div>
</template>
```

Per CONTEXT.md decisions:
- 7-row list layout (one row per day)
- Single time range per day (one open time, one close time)
- Toggle switch per day (off = closed)
- "Apply to weekdays" preset for quick Mon-Fri setup
  </action>
  <verify>
1. Start dev server: `cd staff && pnpm dev`
2. Login as staff user
3. Navigate to /settings/business-hours
4. Verify 7-day schedule displays with toggles and time inputs
5. Verify save button calls API (check network tab or toast)
  </verify>
  <done>
/settings/business-hours page displays weekly schedule editor. Each day shows toggle and time inputs. Save button persists changes to database.
  </done>
</task>

</tasks>

<verification>
1. Database: `supabase db reset` succeeds, business_closures and business_settings tables exist
2. TypeScript: `cd staff && pnpm build` passes
3. UI: /settings/business-hours displays 7-day editor with functional save
4. Data persistence: Changes save to database and reload correctly
</verification>

<success_criteria>
- Supervisor can navigate to /settings/business-hours
- Page shows 7-day weekly schedule with toggle and time inputs per day
- Closed days show "Closed" instead of time inputs
- Save button persists changes to business_hours table
- Changes take effect immediately (no deploy required)
</success_criteria>

<output>
After completion, create `.planning/phases/13-business-hours-management/13-01-SUMMARY.md`
</output>
