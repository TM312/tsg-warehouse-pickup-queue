---
phase: 13-business-hours-management
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - staff/app/composables/useBusinessHoursSettings.ts
  - staff/app/pages/settings/business-hours.vue
  - staff/app/components/business-hours/ClosureScheduler.vue
  - staff/app/components/business-hours/ManualOverrideToggle.vue
  - customer/server/api/business-hours.get.ts
  - customer/app/components/BusinessHoursDisplay.vue
  - customer/app/pages/index.vue
autonomous: true

must_haves:
  truths:
    - "Supervisor can schedule holiday/closure dates using a date picker"
    - "Supervisor can toggle manual override to close immediately"
    - "Manual override auto-expires at next scheduled open time"
    - "Customer sees full week hours on registration page"
    - "Customer registration is blocked during closures and overrides"
  artifacts:
    - path: "staff/app/components/business-hours/ClosureScheduler.vue"
      provides: "Holiday/closure scheduling component"
      min_lines: 60
    - path: "staff/app/components/business-hours/ManualOverrideToggle.vue"
      provides: "Manual override toggle component"
      min_lines: 30
    - path: "customer/app/components/BusinessHoursDisplay.vue"
      provides: "Customer-facing hours display"
      min_lines: 40
  key_links:
    - from: "customer/server/api/business-hours.get.ts"
      to: "business_closures"
      via: "Supabase query"
      pattern: "from\\(['\"]business_closures['\"]\\)"
    - from: "customer/server/api/business-hours.get.ts"
      to: "business_settings"
      via: "Supabase query"
      pattern: "from\\(['\"]business_settings['\"]\\)"
    - from: "customer/app/pages/index.vue"
      to: "BusinessHoursDisplay"
      via: "component import"
      pattern: "BusinessHoursDisplay"
---

<objective>
Complete business hours management with holiday scheduling, manual override, and customer-facing hours display.

Purpose: Extend the weekly schedule editor with closure scheduling and override toggle. Update customer app to check closures/overrides and display full week hours on registration page.

Output:
- ClosureScheduler component for holiday/closure date scheduling
- ManualOverrideToggle component with instant activation
- Updated customer API checking closures and overrides
- BusinessHoursDisplay component showing full week hours
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-business-hours-management/13-CONTEXT.md
@.planning/phases/13-business-hours-management/13-RESEARCH.md
@.planning/phases/13-business-hours-management/13-01-SUMMARY.md
@customer/server/api/business-hours.get.ts
@customer/app/composables/useBusinessHours.ts
@customer/app/components/ClosedMessage.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add closure and override management to staff app</name>
  <files>
    staff/app/composables/useBusinessHoursSettings.ts
    staff/app/components/business-hours/ClosureScheduler.vue
    staff/app/components/business-hours/ManualOverrideToggle.vue
    staff/app/pages/settings/business-hours.vue
  </files>
  <action>
**Extend useBusinessHoursSettings.ts** with closure and override management:

```typescript
interface Closure {
  id: string
  startDate: string  // YYYY-MM-DD
  endDate: string
  reason: string | null
}

interface Override {
  active: boolean
  expiresAt: string | null  // ISO timestamp
}

// Add to composable:
const closures = ref<Closure[]>([])
const override = ref<Override>({ active: false, expiresAt: null })

async function loadClosures() {
  const today = new Date().toISOString().split('T')[0]
  const { data } = await client
    .from('business_closures')
    .select('*')
    .gte('end_date', today)
    .order('start_date')

  closures.value = (data ?? []).map(c => ({
    id: c.id,
    startDate: c.start_date,
    endDate: c.end_date,
    reason: c.reason
  }))
}

async function addClosure(startDate: string, endDate: string, reason?: string) {
  const { error } = await client
    .from('business_closures')
    .insert({
      start_date: startDate,
      end_date: endDate,
      reason: reason || null,
      created_by: (await client.auth.getUser()).data.user?.id
    })

  if (error) throw error
  await loadClosures()
  toast.success('Closure scheduled')
}

async function deleteClosure(id: string) {
  const { error } = await client
    .from('business_closures')
    .delete()
    .eq('id', id)

  if (error) throw error
  await loadClosures()
  toast.success('Closure removed')
}

async function loadOverride() {
  const { data } = await client
    .from('business_settings')
    .select('value')
    .eq('key', 'manual_override')
    .single()

  if (data?.value) {
    override.value = data.value as Override
  }
}

async function toggleOverride(active: boolean) {
  // Calculate expiry: next scheduled open time
  let expiresAt: string | null = null
  if (active) {
    expiresAt = calculateNextOpenTime()
  }

  const { error } = await client
    .from('business_settings')
    .upsert({
      key: 'manual_override',
      value: { active, expiresAt },
      updated_by: (await client.auth.getUser()).data.user?.id
    })

  if (error) throw error
  override.value = { active, expiresAt }
  toast.success(active ? 'Override activated - warehouse closed' : 'Override deactivated')
}

// Helper to find next open time from weekly schedule
function calculateNextOpenTime(): string {
  const now = new Date()
  // ... iterate through days to find next open day/time
  // Return ISO string for that datetime
}
```

**Create ClosureScheduler.vue:**
- List of upcoming closures (chronological, upcoming first)
- Each row: date range, reason (if any), delete button
- Add closure form: date range picker (use Popover + RangeCalendar from reka-ui), optional reason input, Add button
- Date format: "Jan 1-2" or "Jan 1" if single day
- Limit scheduling to 12 months ahead (UI validation with warning)

Per RESEARCH.md, install calendar components if not present:
```bash
cd staff && pnpm dlx shadcn-vue@latest add popover calendar
pnpm add @internationalized/date
```

**Create ManualOverrideToggle.vue:**
- Switch toggle with "Closed now" label
- When active, show expiry time ("Resumes at 8:00 AM tomorrow")
- Instant toggle, no confirmation dialog per CONTEXT.md
- Place at top of business-hours.vue page per CONTEXT.md

**Update business-hours.vue:**
Add ManualOverrideToggle at top, ClosureScheduler in new Card below weekly schedule.
  </action>
  <verify>
1. Start staff dev server: `cd staff && pnpm dev`
2. Navigate to /settings/business-hours
3. Verify ManualOverrideToggle appears at top
4. Verify ClosureScheduler appears below weekly schedule
5. Test adding a closure with date range
6. Test toggling override on/off
  </verify>
  <done>
ManualOverrideToggle at top of page. ClosureScheduler shows list with add/delete. Override saves to business_settings. Closures save to business_closures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update customer API to check closures and override</name>
  <files>customer/server/api/business-hours.get.ts</files>
  <action>
Extend the existing business-hours.get.ts endpoint to check:

1. **Manual override first** - if active and not expired, return closed
2. **Scheduled closures second** - if today falls within a closure date range, return closed with reason
3. **Weekly schedule last** - existing logic (unchanged)

Update the response to include full week hours for display:

```typescript
interface BusinessHoursResponse {
  isOpen: boolean
  message: string | null
  openTime?: string
  closeTime?: string
  weeklyHours?: {
    dayOfWeek: number
    dayName: string
    isClosed: boolean
    openTime: string | null
    closeTime: string | null
  }[]
}

export default defineEventHandler(async (event): Promise<BusinessHoursResponse> => {
  const client = await serverSupabaseClient(event)

  // 1. Check manual override
  const { data: overrideSetting } = await client
    .from('business_settings')
    .select('value')
    .eq('key', 'manual_override')
    .single()

  if (overrideSetting?.value?.active) {
    const expiresAt = overrideSetting.value.expiresAt
    if (!expiresAt || new Date(expiresAt) > new Date()) {
      return {
        isOpen: false,
        message: 'The warehouse is temporarily closed.',
        weeklyHours: await getWeeklyHours(client)
      }
    }
  }

  // 2. Check scheduled closures
  const warehouseNow = new TZDate(new Date(), WAREHOUSE_TIMEZONE)
  const today = format(warehouseNow, 'yyyy-MM-dd')

  const { data: closures } = await client
    .from('business_closures')
    .select('reason')
    .lte('start_date', today)
    .gte('end_date', today)
    .limit(1)

  if (closures && closures.length > 0) {
    const reason = closures[0].reason
    return {
      isOpen: false,
      message: reason ? `Closed: ${reason}` : 'The warehouse is closed today.',
      weeklyHours: await getWeeklyHours(client)
    }
  }

  // 3. Existing weekly schedule check (unchanged logic)
  // ...

  // Include weeklyHours in response
  return {
    isOpen,
    message,
    openTime,
    closeTime,
    weeklyHours: await getWeeklyHours(client)
  }
})

// Helper function to get formatted weekly hours
async function getWeeklyHours(client: SupabaseClient) {
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
  const { data: hours } = await client
    .from('business_hours')
    .select('*')
    .order('day_of_week')

  return dayNames.map((name, i) => {
    const day = hours?.find(h => h.day_of_week === i)
    return {
      dayOfWeek: i,
      dayName: name,
      isClosed: !day || day.is_closed,
      openTime: day && !day.is_closed ? format(parse(day.open_time, 'HH:mm:ss', new Date()), 'h:mm a') : null,
      closeTime: day && !day.is_closed ? format(parse(day.close_time, 'HH:mm:ss', new Date()), 'h:mm a') : null
    }
  })
}
```

Maintain backward compatibility - existing isOpen, message, openTime, closeTime fields work as before.
  </action>
  <verify>
Test API directly:
```bash
curl http://localhost:3001/api/business-hours | jq
```
Verify response includes weeklyHours array with 7 entries.
  </verify>
  <done>
API checks override first, then closures, then weekly schedule. Response includes weeklyHours array for customer display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create customer-facing business hours display</name>
  <files>
    customer/app/components/BusinessHoursDisplay.vue
    customer/app/composables/useBusinessHours.ts
    customer/app/pages/index.vue
  </files>
  <action>
**Update useBusinessHours.ts** to expose weeklyHours:

```typescript
const weeklyHours = computed(() => data.value?.weeklyHours ?? [])
// Add to return
return { ..., weeklyHours }
```

**Create BusinessHoursDisplay.vue:**
Compact 7-day format showing all weekly hours. Per CONTEXT.md:
- Full week always visible
- Show below register button on registration page
- When closed: show reason if available + next open time

```vue
<script setup lang="ts">
interface DayHours {
  dayOfWeek: number
  dayName: string
  isClosed: boolean
  openTime: string | null
  closeTime: string | null
}

defineProps<{
  hours: DayHours[]
}>()
</script>

<template>
  <div class="text-sm text-muted-foreground">
    <div class="font-medium mb-2">Business Hours</div>
    <div class="grid grid-cols-7 gap-1 text-center text-xs">
      <div v-for="day in hours" :key="day.dayOfWeek" class="space-y-0.5">
        <div class="font-medium">{{ day.dayName }}</div>
        <template v-if="day.isClosed">
          <div class="text-muted-foreground/60">Closed</div>
        </template>
        <template v-else>
          <div>{{ day.openTime }}</div>
          <div>{{ day.closeTime }}</div>
        </template>
      </div>
    </div>
  </div>
</template>
```

**Update customer/app/pages/index.vue:**
Add BusinessHoursDisplay below the PickupRequestForm:

```vue
<template>
  <!-- Loading State -->
  <Card v-if="isLoading">...</Card>

  <!-- Open: Show Form + Hours -->
  <template v-else-if="isOpen">
    <PickupRequestForm />
    <BusinessHoursDisplay :hours="weeklyHours" class="mt-4" />
  </template>

  <!-- Closed: Show Message + Hours -->
  <template v-else>
    <ClosedMessage :message="closedMessage" />
    <BusinessHoursDisplay :hours="weeklyHours" class="mt-4" />
  </template>
</template>
```

Hours display should appear in both open and closed states so customers can plan their visits.
  </action>
  <verify>
1. Start customer dev server: `cd customer && pnpm dev`
2. Navigate to customer app root
3. Verify business hours display appears below form/closed message
4. Verify 7-day compact format shows all days
5. Test with override/closure active - verify closed message appears
  </verify>
  <done>
Customer sees full week hours display on registration page. Display works in both open and closed states. Closures and override properly block registration.
  </done>
</task>

</tasks>

<verification>
1. Staff app: /settings/business-hours has override toggle at top, closure scheduler below weekly editor
2. Staff app: Can add/delete closures, toggle override on/off
3. Customer API: Returns weeklyHours, checks override and closures
4. Customer app: Shows 7-day hours display on registration page
5. End-to-end: Toggle override in staff app -> customer app shows closed immediately
</verification>

<success_criteria>
- Supervisor can schedule holiday closures with date range picker
- Supervisor can toggle "Closed now" override for immediate effect
- Override auto-expires at next scheduled open time
- Customer sees full week hours on registration page
- Customer blocked from registration during closures/overrides
- All changes take effect immediately without deployment
</success_criteria>

<output>
After completion, create `.planning/phases/13-business-hours-management/13-02-SUMMARY.md`
</output>
