---
phase: 06-staff-advanced-queue-operations
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - staff/package.json
  - staff/app/composables/useQueueActions.ts
  - staff/app/components/dashboard/GateQueueList.vue
  - staff/app/components/dashboard/PriorityButton.vue
autonomous: true

must_haves:
  truths:
    - "Staff can drag-and-drop to reorder queue within a gate"
    - "Drag operations use optimistic updates with rollback on failure"
    - "Staff can mark a request as priority"
    - "Priority requests move to position 2"
  artifacts:
    - path: "staff/app/composables/useQueueActions.ts"
      provides: "reorderQueue, setPriority, moveToGate functions"
      exports: ["useQueueActions"]
    - path: "staff/app/components/dashboard/GateQueueList.vue"
      provides: "Drag-and-drop sortable list for per-gate queue"
      min_lines: 60
  key_links:
    - from: "GateQueueList.vue"
      to: "useSortable"
      via: "@vueuse/integrations import"
      pattern: "useSortable.*from.*@vueuse/integrations"
    - from: "useQueueActions"
      to: "reorder_queue RPC"
      via: "client.rpc call"
      pattern: "rpc\\(['\"]reorder_queue['\"]"
---

<objective>
Add drag-and-drop reordering within gates and priority override capability.

Purpose: Staff need intuitive queue management - dragging to reorder and marking urgent pickups as priority. Optimistic updates provide responsive UI while atomic database functions prevent race conditions.

Output: Extended useQueueActions composable with new functions, sortable list component using useSortable, and priority button component.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-staff-advanced-queue-operations/06-CONTEXT.md
@.planning/phases/06-staff-advanced-queue-operations/06-RESEARCH.md

# Existing code
@staff/app/composables/useQueueActions.ts
@staff/app/pages/index.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sortablejs dependencies</name>
  <files>staff/package.json</files>
  <action>
Install the drag-and-drop dependencies:

```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff
pnpm add sortablejs @vueuse/integrations
```

This adds:
- sortablejs: Core drag-and-drop library
- @vueuse/integrations: Provides useSortable composable for Vue

Note: @vueuse/core is already installed (used by existing components).
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff
pnpm ls sortablejs @vueuse/integrations
```
Both packages should appear in the output.
  </verify>
  <done>
- sortablejs installed
- @vueuse/integrations installed
- package.json updated with new dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend useQueueActions with reorder, priority, and move functions</name>
  <files>staff/app/composables/useQueueActions.ts</files>
  <action>
Add three new functions to the existing useQueueActions composable:

**reorderQueue(gateId: string, requestIds: string[]): Promise<boolean>**
- Calls client.rpc('reorder_queue', { p_gate_id: gateId, p_request_ids: requestIds })
- Shows toast.success('Queue reordered') on success
- Shows toast.error('Failed to reorder queue') on error
- Returns true/false for success/failure
- Note: Optimistic update happens in GateQueueList, this just syncs to server

**setPriority(requestId: string): Promise<boolean>**
- Sets pending[requestId] = true during operation
- Calls client.rpc('set_priority', { p_request_id: requestId })
- Shows toast.success('Marked as priority') on success
- Shows toast.error('Failed to set priority') on error
- Returns true/false

**moveToGate(requestId: string, newGateId: string): Promise<number | null>**
- Sets pending[requestId] = true during operation
- Calls client.rpc('move_to_gate', { p_request_id: requestId, p_new_gate_id: newGateId })
- Shows toast.success('Moved to new gate') on success
- Shows toast.error('Failed to move to gate') on error
- Returns new position number on success, null on failure

Update the return statement to include all new functions.
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && pnpm typecheck
```
  </verify>
  <done>
- reorderQueue function added and exported
- setPriority function added and exported
- moveToGate function added and exported
- All functions use RPC calls to PostgreSQL functions
- Toast feedback for all operations
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GateQueueList sortable component</name>
  <files>staff/app/components/dashboard/GateQueueList.vue</files>
  <action>
Create a per-gate sortable list component using useSortable:

**Props:**
- gateId: string
- items: Array<{ id: string, sales_order_number: string, company_name: string | null, queue_position: number, is_priority: boolean }>

**Emits:**
- reorder: (requestIds: string[]) - new order after drag
- set-priority: (requestId: string) - when priority button clicked

**Implementation:**
1. Use shallowRef for localItems to hold reactive copy of props.items
2. Watch props.items for external updates and sync to localItems
3. Use useTemplateRef to get list container reference
4. Configure useSortable with:
   - animation: 150
   - handle: '.drag-handle' (explicit drag handle for better UX)
   - ghostClass: 'opacity-50'
   - dragClass: 'bg-accent'
   - onStart: capture previousOrder = localItems.map(i => i.id)
   - onUpdate: moveArrayElement, then emit('reorder', newOrder)

**Template structure:**
```html
<div ref="listRef" class="space-y-2">
  <div v-for="item in localItems" :key="item.id"
       class="flex items-center gap-3 p-3 border rounded-lg bg-background">
    <div class="drag-handle cursor-grab active:cursor-grabbing">
      <GripVertical class="h-5 w-5 text-muted-foreground" />
    </div>
    <div class="flex-1 min-w-0">
      <div class="font-medium truncate">{{ item.sales_order_number }}</div>
      <div v-if="item.company_name" class="text-sm text-muted-foreground truncate">
        {{ item.company_name }}
      </div>
    </div>
    <Badge v-if="item.is_priority" variant="destructive" class="shrink-0">
      Priority
    </Badge>
    <PriorityButton
      v-if="!item.is_priority"
      @click="emit('set-priority', item.id)"
    />
  </div>
</div>
```

Handle empty state: show "No customers in queue" message when items is empty.
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && pnpm typecheck
```
  </verify>
  <done>
- GateQueueList uses useSortable for drag-and-drop
- Drag handle restricts dragging to grip icon
- Priority badge shows for is_priority items
- Reorder event emitted after drag ends
- Empty state handled
  </done>
</task>

<task type="auto">
  <name>Task 4: Create PriorityButton component</name>
  <files>staff/app/components/dashboard/PriorityButton.vue</files>
  <action>
Create a simple button component for setting priority:

**Props:**
- disabled: boolean (optional, default false)

**Template:**
- Small button with AlertTriangle or ArrowUp icon from lucide-vue-next
- Tooltip or title attribute: "Mark as priority"
- variant="ghost" size="icon" styling
- Emits click event to parent

Keep it minimal - just a button that triggers the priority action.
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && pnpm typecheck
```
  </verify>
  <done>
- PriorityButton renders icon button
- Click event propagates to parent
- Disabled state supported
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. sortablejs and @vueuse/integrations installed
3. useQueueActions exports reorderQueue, setPriority, moveToGate
4. GateQueueList renders with drag handles
5. Import useSortable from @vueuse/integrations/useSortable works
</verification>

<success_criteria>
- Dependencies installed (sortablejs, @vueuse/integrations)
- useQueueActions extended with three new RPC-calling functions
- GateQueueList component created with useSortable integration
- PriorityButton component created
- Drag handle pattern implemented (not full-row dragging)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-staff-advanced-queue-operations/06-03-SUMMARY.md`
</output>
