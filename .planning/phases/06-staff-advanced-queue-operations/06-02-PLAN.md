---
phase: 06-staff-advanced-queue-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/composables/useGateManagement.ts
  - staff/app/components/gates/CreateGateDialog.vue
  - staff/app/components/gates/EditGateDialog.vue
  - staff/app/components/gates/DeleteGateDialog.vue
  - staff/app/components/gates/GateManagement.vue
autonomous: true

must_haves:
  truths:
    - "Staff can create a new gate with a number"
    - "Staff can rename an existing gate"
    - "Staff can delete an empty gate"
    - "Staff can enable/disable a gate"
    - "Gates with customers in queue cannot be disabled or deleted"
  artifacts:
    - path: "staff/app/composables/useGateManagement.ts"
      provides: "createGate, renameGate, deleteGate, toggleGateActive functions"
      exports: ["useGateManagement"]
    - path: "staff/app/components/gates/GateManagement.vue"
      provides: "Gate management panel with CRUD controls"
      min_lines: 80
  key_links:
    - from: "GateManagement.vue"
      to: "useGateManagement composable"
      via: "composable import and function calls"
      pattern: "useGateManagement\\(\\)"
    - from: "useGateManagement"
      to: "Supabase gates table"
      via: "insert, update, delete operations"
      pattern: "from\\(['\"]gates['\"]\\)"
---

<objective>
Implement gate CRUD operations: create, rename, delete, and enable/disable gates.

Purpose: Staff need to manage the physical pickup gates as the warehouse layout changes. Gates with active customers must be protected from accidental deletion or disabling.

Output: A composable for gate operations and dialog components for create/rename/delete actions.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-staff-advanced-queue-operations/06-CONTEXT.md
@.planning/phases/06-staff-advanced-queue-operations/06-RESEARCH.md

# Existing patterns
@staff/app/composables/useQueueActions.ts
@staff/app/components/ui/dialog/index.ts
@staff/app/components/ui/alert-dialog/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useGateManagement composable</name>
  <files>staff/app/composables/useGateManagement.ts</files>
  <action>
Create a new composable following the pattern from useQueueActions.ts:

```typescript
import { ref, readonly } from 'vue'
import { toast } from 'vue-sonner'
import type { SupabaseClient } from '@supabase/supabase-js'

export function useGateManagement() {
  const client = useSupabaseClient() as SupabaseClient
  const pending = ref(false)

  // createGate(gateNumber: number): Promise<string | null>
  // - Insert into gates table
  // - Handle unique constraint violation (gate number already exists)
  // - Return gate ID on success, null on failure
  // - Show toast on success/error

  // renameGate(gateId: string, newNumber: number): Promise<boolean>
  // - Update gate_number
  // - Handle unique constraint violation
  // - Show toast on success/error

  // deleteGate(gateId: string): Promise<boolean>
  // - First check for in_queue requests assigned to this gate
  // - If count > 0, show error toast and return false
  // - Otherwise delete gate
  // - Show toast on success/error

  // toggleGateActive(gateId: string, isActive: boolean): Promise<boolean>
  // - If disabling (isActive = false), first check for in_queue requests
  // - If count > 0, show error toast and return false
  // - Update is_active field
  // - Show toast on success/error

  return {
    pending: readonly(pending),
    createGate,
    renameGate,
    deleteGate,
    toggleGateActive,
  }
}
```

Use toast.error() for validation failures (e.g., "Cannot delete gate with customers in queue").
Use toast.success() for successful operations.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && pnpm typecheck
```
  </verify>
  <done>
- useGateManagement composable exports all four functions
- Validation prevents delete/disable of gates with customers
- Error handling for unique constraint violations
- Toast notifications for all operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gate CRUD dialog components</name>
  <files>
staff/app/components/gates/CreateGateDialog.vue
staff/app/components/gates/EditGateDialog.vue
staff/app/components/gates/DeleteGateDialog.vue
  </files>
  <action>
Create three dialog components in a new `gates/` directory under components:

**CreateGateDialog.vue:**
- Uses Dialog from @/components/ui/dialog
- Input field for gate number (type="number", min="1")
- Emits `create` event with gate number
- Closes on successful submission

**EditGateDialog.vue:**
- Props: `gate` (object with id, gate_number)
- Input pre-filled with current gate number
- Emits `rename` event with (gateId, newNumber)
- Closes on successful submission

**DeleteGateDialog.vue:**
- Uses AlertDialog for confirmation
- Props: `gate` (object with id, gate_number), `hasCustomers` (boolean)
- If hasCustomers is true, show disabled state with explanation
- Emits `delete` event with gateId
- Destructive action style

Follow the Dialog patterns from 06-RESEARCH.md. Use:
- DialogHeader, DialogTitle, DialogDescription, DialogFooter
- Button with variant="outline" for cancel, default for submit
- AlertDialogAction with variant="destructive" for delete
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && pnpm typecheck
```
  </verify>
  <done>
- CreateGateDialog accepts gate number input and emits create event
- EditGateDialog pre-fills current number and emits rename event
- DeleteGateDialog shows confirmation with hasCustomers validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GateManagement panel component</name>
  <files>staff/app/components/gates/GateManagement.vue</files>
  <action>
Create a panel component that displays all gates with management controls:

**Props:**
- `gates`: Array of { id, gate_number, is_active, queue_count }

**Structure:**
- Header with "Manage Gates" title and CreateGateDialog trigger button
- List/grid of gates, each showing:
  - Gate number
  - Status indicator (active/disabled)
  - Queue count badge (if any)
  - Actions: Edit (pencil icon), Toggle active (switch or button), Delete (trash icon)
- Disabled gates appear with opacity-50 styling

**Events:**
- `create`: (gateNumber: number) => void
- `rename`: (gateId: string, newNumber: number) => void
- `delete`: (gateId: string) => void
- `toggle-active`: (gateId: string, isActive: boolean) => void

**Icons from lucide-vue-next:**
- Plus for create
- Pencil for edit
- Trash2 for delete
- Power or ToggleLeft/ToggleRight for enable/disable

Use a simple card-based layout. Each gate as a card with controls.
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && pnpm typecheck
```
  </verify>
  <done>
- GateManagement shows list of gates with queue counts
- Create, edit, delete dialogs are wired up
- Enable/disable toggle is present
- Disabled gates show visual distinction
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes in staff/ directory
2. All components import and export correctly
3. useGateManagement validates queue_count before delete/disable
4. Dialog components follow shadcn-vue patterns
</verification>

<success_criteria>
- useGateManagement.ts composable created with four functions
- CreateGateDialog, EditGateDialog, DeleteGateDialog components created
- GateManagement panel component created
- All TypeScript compiles without errors
- Validation prevents destructive operations on active gates
</success_criteria>

<output>
After completion, create `.planning/phases/06-staff-advanced-queue-operations/06-02-SUMMARY.md`
</output>
