---
phase: 06-staff-advanced-queue-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260129100000_add_advanced_queue_functions.sql
autonomous: true

must_haves:
  truths:
    - "Queue positions can be reordered atomically without race conditions"
    - "Priority requests move to position 2 and shift others"
    - "Requests can transfer between gates with position compaction"
  artifacts:
    - path: "supabase/migrations/20260129100000_add_advanced_queue_functions.sql"
      provides: "reorder_queue, set_priority, move_to_gate PostgreSQL functions"
      contains: "CREATE OR REPLACE FUNCTION reorder_queue"
  key_links:
    - from: "reorder_queue function"
      to: "pickup_requests table"
      via: "UPDATE with UNNEST array pattern"
      pattern: "UNNEST.*WITH ORDINALITY"
---

<objective>
Create PostgreSQL functions for advanced queue operations: bulk reordering, priority insertion, and cross-gate transfer.

Purpose: These atomic database functions prevent race conditions when multiple staff members manipulate queue positions simultaneously. They form the foundation for all drag-and-drop and priority operations.

Output: A migration file with three SECURITY DEFINER functions callable via Supabase RPC.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-staff-advanced-queue-operations/06-RESEARCH.md

# Existing schema
@supabase/migrations/20260128000001_create_gates_table.sql
@supabase/migrations/20260128000002_create_pickup_requests_table.sql
@supabase/migrations/20260129000000_add_queue_functions.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create advanced queue PostgreSQL functions</name>
  <files>supabase/migrations/20260129100000_add_advanced_queue_functions.sql</files>
  <action>
Create a new migration file with three atomic functions:

**1. reorder_queue(p_gate_id uuid, p_request_ids uuid[]) RETURNS void**
- Uses UNNEST WITH ORDINALITY pattern to assign positions 1, 2, 3... based on array order
- Only updates requests that are in_queue status AND assigned to the specified gate
- SECURITY DEFINER for atomic MAX calculation
- GRANT EXECUTE to authenticated role

**2. set_priority(p_request_id uuid) RETURNS void**
- Gets the request's current gate_id and queue_position
- Raises exception if request is not in_queue status
- Shifts all positions >= 2 AND < current_pos up by 1 (makes room at position 2)
- Moves the target request to position 2 and sets is_priority = true
- SECURITY DEFINER for atomic operation
- GRANT EXECUTE to authenticated role

**3. move_to_gate(p_request_id uuid, p_new_gate_id uuid) RETURNS integer**
- Gets the request's current gate_id and position
- Raises exception if request is not in_queue status
- Calculates new position as MAX(queue_position) + 1 for the new gate
- Updates request with new gate and position
- Compacts old gate's positions (subtract 1 from all positions > old_pos)
- Returns the new position number
- SECURITY DEFINER for atomic operation
- GRANT EXECUTE to authenticated role

Follow the existing pattern from 20260129000000_add_queue_functions.sql for style and comments.
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue
supabase db reset
```
Migration should apply without errors. Check with:
```bash
supabase db diff
```
  </verify>
  <done>
- reorder_queue function exists and accepts gate_id + array of request IDs
- set_priority function exists and moves request to position 2
- move_to_gate function exists and returns new position
- All functions are SECURITY DEFINER with authenticated role GRANT
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify functions work correctly</name>
  <files>supabase/migrations/20260129100000_add_advanced_queue_functions.sql</files>
  <action>
After migration applies, verify the functions exist and have correct signatures by running:

```sql
SELECT proname, pg_get_function_arguments(oid), pg_get_function_result(oid)
FROM pg_proc
WHERE proname IN ('reorder_queue', 'set_priority', 'move_to_gate');
```

This should show:
- reorder_queue(p_gate_id uuid, p_request_ids uuid[]) -> void
- set_priority(p_request_id uuid) -> void
- move_to_gate(p_request_id uuid, p_new_gate_id uuid) -> integer
  </action>
  <verify>
Run via Supabase Studio SQL editor or psql. All three functions should appear with correct argument types.
  </verify>
  <done>
- All three functions visible in pg_proc with correct signatures
- No migration errors during supabase db reset
  </done>
</task>

</tasks>

<verification>
1. `supabase db reset` completes without errors
2. Functions are visible: `\df reorder_queue`, `\df set_priority`, `\df move_to_gate`
3. Functions have correct permissions: authenticated role can execute
</verification>

<success_criteria>
- Migration file exists at specified path
- Three PostgreSQL functions created with atomic behavior
- All functions use SECURITY DEFINER pattern
- All functions granted to authenticated role
- Migration applies cleanly on fresh database
</success_criteria>

<output>
After completion, create `.planning/phases/06-staff-advanced-queue-operations/06-01-SUMMARY.md`
</output>
