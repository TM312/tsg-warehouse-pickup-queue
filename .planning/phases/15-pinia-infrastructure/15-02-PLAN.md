---
phase: 15-pinia-infrastructure
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified:
  - staff/app/stores/queue.ts
  - staff/app/stores/gates.ts
autonomous: true

must_haves:
  truths:
    - "Queue state is accessible via useQueueStore()"
    - "Gate state is accessible via useGatesStore()"
    - "Store state is visible in Vue DevTools"
  artifacts:
    - path: "staff/app/stores/queue.ts"
      provides: "Queue state management"
      exports: ["useQueueStore"]
    - path: "staff/app/stores/gates.ts"
      provides: "Gate state management"
      exports: ["useGatesStore"]
  key_links:
    - from: "staff/app/stores/queue.ts"
      to: "#shared/types/pickup-request"
      via: "import type"
      pattern: "import.*PickupRequest.*#shared"
    - from: "staff/app/stores/gates.ts"
      to: "#shared/types/gate"
      via: "import type"
      pattern: "import.*GateWithCount.*#shared"
---

<objective>
Create Pinia stores for queue and gate state using the setup store pattern.

Purpose: Establish centralized state containers that composables and pages will use.
Output: Two stores (useQueueStore, useGatesStore) with typed state, computed getters, and mutation actions.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pinia-infrastructure/15-RESEARCH.md

# Types to use
@staff/shared/types/pickup-request.ts
@staff/shared/types/gate.ts

# Current pages show what state is needed
@staff/app/pages/index.vue
@staff/app/pages/gate/[id].vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create queue store</name>
  <files>staff/app/stores/queue.ts</files>
  <action>
Create `staff/app/stores/queue.ts` using the setup store pattern:

```typescript
import { defineStore } from 'pinia'
import type { PickupRequest } from '#shared/types/pickup-request'
import { PICKUP_STATUS } from '#shared/types/pickup-request'

export const useQueueStore = defineStore('queue', () => {
  // === State ===
  const requests = ref<PickupRequest[]>([])
  const loading = ref(false)
  const lastUpdated = ref<Date | null>(null)

  // === Getters ===
  const processingItems = computed(() =>
    requests.value.filter(r => r.status === PICKUP_STATUS.PROCESSING)
  )

  const inQueueItems = computed(() =>
    requests.value.filter(r => r.status === PICKUP_STATUS.IN_QUEUE)
  )

  const pendingItems = computed(() =>
    requests.value.filter(r => r.status === PICKUP_STATUS.PENDING)
  )

  // === Actions ===
  function setRequests(data: PickupRequest[]) {
    requests.value = data
    lastUpdated.value = new Date()
  }

  function addRequest(request: PickupRequest) {
    // Add at beginning (newest first)
    requests.value.unshift(request)
    lastUpdated.value = new Date()
  }

  function updateRequest(id: string, updates: Partial<PickupRequest>) {
    const index = requests.value.findIndex(r => r.id === id)
    if (index !== -1) {
      requests.value[index] = { ...requests.value[index], ...updates }
      lastUpdated.value = new Date()
    }
  }

  function removeRequest(id: string) {
    requests.value = requests.value.filter(r => r.id !== id)
    lastUpdated.value = new Date()
  }

  // Helper to get request by ID
  function getRequestById(id: string): PickupRequest | undefined {
    return requests.value.find(r => r.id === id)
  }

  // Return everything for DevTools visibility
  return {
    // State
    requests,
    loading,
    lastUpdated,
    // Getters
    processingItems,
    inQueueItems,
    pendingItems,
    // Actions
    setRequests,
    addRequest,
    updateRequest,
    removeRequest,
    getRequestById,
  }
})
```

Key points:
- Uses setup store syntax (composition API style)
- All state is typed using shared types from Phase 14
- Computed getters filter by PICKUP_STATUS constants
- All state/getters/actions returned for DevTools visibility
- lastUpdated tracks when state was last modified
  </action>
  <verify>
Run `cat staff/app/stores/queue.ts` to verify file content.
Run `npx nuxi typecheck --cwd staff` to verify no type errors.
  </verify>
  <done>useQueueStore exists with requests state, computed getters (processingItems, inQueueItems, pendingItems), and mutation actions.</done>
</task>

<task type="auto">
  <name>Task 2: Create gates store</name>
  <files>staff/app/stores/gates.ts</files>
  <action>
Create `staff/app/stores/gates.ts` using the setup store pattern:

```typescript
import { defineStore } from 'pinia'
import type { GateWithCount } from '#shared/types/gate'

export const useGatesStore = defineStore('gates', () => {
  // === State ===
  const gates = ref<GateWithCount[]>([])
  const loading = ref(false)
  const lastUpdated = ref<Date | null>(null)

  // === Getters ===
  const activeGates = computed(() =>
    gates.value.filter(g => g.is_active)
  )

  // Sorted alphabetically by gate number for consistent ordering
  const sortedGates = computed(() =>
    [...gates.value].sort((a, b) => a.gate_number - b.gate_number)
  )

  const sortedActiveGates = computed(() =>
    activeGates.value.sort((a, b) => a.gate_number - b.gate_number)
  )

  // === Actions ===
  function setGates(data: GateWithCount[]) {
    gates.value = data
    lastUpdated.value = new Date()
  }

  function updateGate(id: string, updates: Partial<GateWithCount>) {
    const index = gates.value.findIndex(g => g.id === id)
    if (index !== -1) {
      gates.value[index] = { ...gates.value[index], ...updates }
      lastUpdated.value = new Date()
    }
  }

  function addGate(gate: GateWithCount) {
    gates.value.push(gate)
    // Re-sort after adding
    gates.value.sort((a, b) => a.gate_number - b.gate_number)
    lastUpdated.value = new Date()
  }

  // Helper to get gate by ID
  function getGateById(id: string): GateWithCount | undefined {
    return gates.value.find(g => g.id === id)
  }

  // Return everything for DevTools visibility
  return {
    // State
    gates,
    loading,
    lastUpdated,
    // Getters
    activeGates,
    sortedGates,
    sortedActiveGates,
    // Actions
    setGates,
    updateGate,
    addGate,
    getGateById,
  }
})
```

Key points:
- Uses GateWithCount which includes queue_count
- Provides sorted getters for consistent gate ordering (GATE-10 prep)
- All state returned for DevTools visibility
  </action>
  <verify>
Run `cat staff/app/stores/gates.ts` to verify file content.
Run `npx nuxi typecheck --cwd staff` to verify no type errors.
  </verify>
  <done>useGatesStore exists with gates state, computed getters (activeGates, sortedGates), and mutation actions.</done>
</task>

</tasks>

<verification>
1. `staff/app/stores/queue.ts` exists and exports useQueueStore
2. `staff/app/stores/gates.ts` exists and exports useGatesStore
3. Both stores use types from #shared/types/
4. Both stores use PICKUP_STATUS constants (no magic strings)
5. `npx nuxi typecheck --cwd staff` passes with no errors
</verification>

<success_criteria>
- useQueueStore() is callable and returns typed state
- useGatesStore() is callable and returns typed state
- Stores use Phase 14 types (PickupRequest, GateWithCount)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-pinia-infrastructure/15-02-SUMMARY.md`
</output>
