---
phase: 03-staff-authentication
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/pages/login.vue
  - app/pages/forgot-password.vue
  - app/pages/password/update.vue
  - app/pages/confirm.vue
  - app/pages/settings.vue
  - app/pages/index.vue
  - app/components/PasswordChangeForm.vue
autonomous: false
user_setup:
  - service: supabase
    why: "Supabase Auth requires project credentials for authentication to work"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard > Project Settings > API > Project URL"
      - name: SUPABASE_KEY
        source: "Supabase Dashboard > Project Settings > API > anon public key"
    dashboard_config:
      - task: "Disable email confirmation for admin-created users"
        location: "Supabase Dashboard > Authentication > Providers > Email > Confirm email toggle OFF"
      - task: "Add redirect URL for password reset"
        location: "Supabase Dashboard > Authentication > URL Configuration > Add http://localhost:3000/password/update"
      - task: "Create test staff account"
        location: "Supabase Dashboard > Authentication > Users > Add user"

must_haves:
  truths:
    - "Staff can log in with email and password"
    - "Staff can log out from any authenticated page"
    - "Unauthenticated users are redirected to login page"
    - "Staff can request password reset via email"
    - "Staff can change their password after login"
    - "Session persists across browser refresh"
  artifacts:
    - path: "app/pages/login.vue"
      provides: "Login form with email/password"
      contains: "signInWithPassword"
      min_lines: 50
    - path: "app/pages/forgot-password.vue"
      provides: "Password reset request form"
      contains: "resetPasswordForEmail"
      min_lines: 30
    - path: "app/pages/password/update.vue"
      provides: "New password form after reset"
      contains: "updateUser"
      min_lines: 30
    - path: "app/pages/confirm.vue"
      provides: "Auth callback handler"
      min_lines: 10
    - path: "app/pages/settings.vue"
      provides: "Settings page with password change"
      min_lines: 20
    - path: "app/pages/index.vue"
      provides: "Protected dashboard placeholder"
      contains: "definePageMeta"
      min_lines: 10
  key_links:
    - from: "app/pages/login.vue"
      to: "supabase.auth.signInWithPassword"
      via: "form submission"
      pattern: "signInWithPassword"
    - from: "app/pages/forgot-password.vue"
      to: "supabase.auth.resetPasswordForEmail"
      via: "form submission"
      pattern: "resetPasswordForEmail"
    - from: "app/pages/index.vue"
      to: "middleware/auth.ts"
      via: "definePageMeta middleware"
      pattern: "middleware.*auth"
---

<objective>
Create all authentication pages and the protected dashboard route for staff login, logout, password reset, and password change.

Purpose: Complete the staff authentication experience so warehouse staff can securely log in, manage their passwords, and access the dashboard. This enables Phase 4 (Staff Dashboard Core) to build on authenticated routes.

Output: Working authentication flow with login, forgot password, password reset, password change, and a protected dashboard page that redirects unauthenticated users.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-staff-authentication/03-RESEARCH.md
@.planning/phases/03-staff-authentication/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login and forgot password pages</name>
  <files>
    app/pages/login.vue
    app/pages/forgot-password.vue
  </files>
  <action>
1. Add shadcn-vue Form component (not added in Plan 01):
```bash
cd app && pnpm dlx shadcn-vue@latest add form
```

2. Create login page at pages/login.vue:
```vue
<script setup lang="ts">
import { toTypedSchema } from '@vee-validate/zod'
import * as z from 'zod'
import { useForm } from 'vee-validate'

definePageMeta({
  layout: 'auth',
  middleware: 'auth'
})

const supabase = useSupabaseClient()
const user = useSupabaseUser()

// Redirect if already logged in (handled by middleware, but also watch for changes)
watch(user, (value) => {
  if (value) navigateTo('/')
}, { immediate: true })

const formSchema = toTypedSchema(z.object({
  email: z.string().email('Please enter a valid email address'),
  password: z.string().min(1, 'Password is required')
}))

const form = useForm({ validationSchema: formSchema })
const isLoading = ref(false)
const errorMessage = ref('')

const onSubmit = form.handleSubmit(async (values) => {
  isLoading.value = true
  errorMessage.value = ''

  const { error } = await supabase.auth.signInWithPassword({
    email: values.email,
    password: values.password
  })

  isLoading.value = false

  if (error) {
    errorMessage.value = 'Invalid email or password'
    return
  }

  await navigateTo('/')
})
</script>

<template>
  <div class="flex min-h-screen items-center justify-center p-4">
    <Card class="w-full max-w-md">
      <CardHeader class="space-y-1">
        <CardTitle class="text-2xl font-bold">Staff Login</CardTitle>
        <CardDescription>Enter your credentials to access the warehouse dashboard</CardDescription>
      </CardHeader>
      <CardContent>
        <form @submit="onSubmit" class="space-y-4">
          <FormField v-slot="{ componentField }" name="email">
            <FormItem>
              <FormLabel>Email</FormLabel>
              <FormControl>
                <Input
                  type="email"
                  placeholder="staff@example.com"
                  autocomplete="email"
                  v-bind="componentField"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          </FormField>

          <FormField v-slot="{ componentField }" name="password">
            <FormItem>
              <FormLabel>Password</FormLabel>
              <FormControl>
                <Input
                  type="password"
                  autocomplete="current-password"
                  v-bind="componentField"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          </FormField>

          <div v-if="errorMessage" class="text-sm text-destructive">
            {{ errorMessage }}
          </div>

          <Button type="submit" class="w-full" :disabled="isLoading">
            {{ isLoading ? 'Signing in...' : 'Sign In' }}
          </Button>
        </form>

        <div class="mt-4 text-center">
          <NuxtLink to="/forgot-password" class="text-sm text-muted-foreground hover:underline">
            Forgot your password?
          </NuxtLink>
        </div>
      </CardContent>
    </Card>
  </div>
</template>
```

3. Create forgot password page at pages/forgot-password.vue:
```vue
<script setup lang="ts">
import { toTypedSchema } from '@vee-validate/zod'
import * as z from 'zod'
import { useForm } from 'vee-validate'

definePageMeta({
  layout: 'auth',
  middleware: 'auth'
})

const supabase = useSupabaseClient()
const config = useRuntimeConfig()

const formSchema = toTypedSchema(z.object({
  email: z.string().email('Please enter a valid email address')
}))

const form = useForm({ validationSchema: formSchema })
const isLoading = ref(false)
const isSubmitted = ref(false)
const errorMessage = ref('')

const onSubmit = form.handleSubmit(async (values) => {
  isLoading.value = true
  errorMessage.value = ''

  // Must use absolute URL for redirect
  const redirectUrl = `${window.location.origin}/password/update`

  const { error } = await supabase.auth.resetPasswordForEmail(values.email, {
    redirectTo: redirectUrl
  })

  isLoading.value = false

  if (error) {
    errorMessage.value = 'Failed to send reset email. Please try again.'
    return
  }

  isSubmitted.value = true
})
</script>

<template>
  <div class="flex min-h-screen items-center justify-center p-4">
    <Card class="w-full max-w-md">
      <CardHeader class="space-y-1">
        <CardTitle class="text-2xl font-bold">Reset Password</CardTitle>
        <CardDescription>Enter your email to receive a password reset link</CardDescription>
      </CardHeader>
      <CardContent>
        <div v-if="isSubmitted" class="text-center space-y-4">
          <p class="text-muted-foreground">
            If an account exists with that email, you will receive a password reset link shortly.
          </p>
          <NuxtLink to="/login" class="text-primary hover:underline">
            Return to login
          </NuxtLink>
        </div>

        <form v-else @submit="onSubmit" class="space-y-4">
          <FormField v-slot="{ componentField }" name="email">
            <FormItem>
              <FormLabel>Email</FormLabel>
              <FormControl>
                <Input
                  type="email"
                  placeholder="staff@example.com"
                  autocomplete="email"
                  v-bind="componentField"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          </FormField>

          <div v-if="errorMessage" class="text-sm text-destructive">
            {{ errorMessage }}
          </div>

          <Button type="submit" class="w-full" :disabled="isLoading">
            {{ isLoading ? 'Sending...' : 'Send Reset Link' }}
          </Button>
        </form>

        <div class="mt-4 text-center">
          <NuxtLink to="/login" class="text-sm text-muted-foreground hover:underline">
            Back to login
          </NuxtLink>
        </div>
      </CardContent>
    </Card>
  </div>
</template>
```
  </action>
  <verify>
    1. Run `cd app && pnpm dev`
    2. Visit http://localhost:3000/login - login form renders
    3. Visit http://localhost:3000/forgot-password - forgot password form renders
    4. Verify form validation shows errors for empty/invalid inputs
  </verify>
  <done>
    Login page shows email/password form with validation, forgot password page shows email form with success message after submission, both use auth layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Create password update, confirm, settings, and dashboard pages</name>
  <files>
    app/pages/password/update.vue
    app/pages/confirm.vue
    app/pages/settings.vue
    app/pages/index.vue
    app/components/PasswordChangeForm.vue
  </files>
  <action>
1. Create password update page at pages/password/update.vue (for reset flow):
```vue
<script setup lang="ts">
import { toTypedSchema } from '@vee-validate/zod'
import * as z from 'zod'
import { useForm } from 'vee-validate'

definePageMeta({
  layout: 'auth',
  middleware: 'auth'
})

const supabase = useSupabaseClient()

const formSchema = toTypedSchema(z.object({
  password: z.string().min(8, 'Password must be at least 8 characters'),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword']
}))

const form = useForm({ validationSchema: formSchema })
const isLoading = ref(false)
const isSuccess = ref(false)
const errorMessage = ref('')

const onSubmit = form.handleSubmit(async (values) => {
  isLoading.value = true
  errorMessage.value = ''

  const { error } = await supabase.auth.updateUser({
    password: values.password
  })

  isLoading.value = false

  if (error) {
    errorMessage.value = 'Failed to update password. Please try again or request a new reset link.'
    return
  }

  isSuccess.value = true
})
</script>

<template>
  <div class="flex min-h-screen items-center justify-center p-4">
    <Card class="w-full max-w-md">
      <CardHeader class="space-y-1">
        <CardTitle class="text-2xl font-bold">Set New Password</CardTitle>
        <CardDescription>Enter your new password below</CardDescription>
      </CardHeader>
      <CardContent>
        <div v-if="isSuccess" class="text-center space-y-4">
          <p class="text-muted-foreground">
            Your password has been updated successfully.
          </p>
          <Button @click="navigateTo('/')" class="w-full">
            Go to Dashboard
          </Button>
        </div>

        <form v-else @submit="onSubmit" class="space-y-4">
          <FormField v-slot="{ componentField }" name="password">
            <FormItem>
              <FormLabel>New Password</FormLabel>
              <FormControl>
                <Input
                  type="password"
                  autocomplete="new-password"
                  v-bind="componentField"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          </FormField>

          <FormField v-slot="{ componentField }" name="confirmPassword">
            <FormItem>
              <FormLabel>Confirm Password</FormLabel>
              <FormControl>
                <Input
                  type="password"
                  autocomplete="new-password"
                  v-bind="componentField"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          </FormField>

          <div v-if="errorMessage" class="text-sm text-destructive">
            {{ errorMessage }}
          </div>

          <Button type="submit" class="w-full" :disabled="isLoading">
            {{ isLoading ? 'Updating...' : 'Update Password' }}
          </Button>
        </form>
      </CardContent>
    </Card>
  </div>
</template>
```

2. Create confirm page at pages/confirm.vue (callback handler):
```vue
<script setup lang="ts">
definePageMeta({
  layout: 'auth'
})

const user = useSupabaseUser()
const route = useRoute()

// The @nuxtjs/supabase module automatically handles the token exchange
// from the URL hash. We just need to wait for the user to be set.
onMounted(() => {
  // Check if this is a password recovery redirect
  const hashParams = new URLSearchParams(window.location.hash.substring(1))
  const type = hashParams.get('type')

  if (type === 'recovery') {
    // Redirect to password update page for password reset
    navigateTo('/password/update')
    return
  }
})

watch(user, (value) => {
  if (value) {
    navigateTo('/')
  }
}, { immediate: true })
</script>

<template>
  <div class="flex min-h-screen items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
      <p class="text-muted-foreground">Confirming your session...</p>
    </div>
  </div>
</template>
```

3. Create PasswordChangeForm component at components/PasswordChangeForm.vue:
```vue
<script setup lang="ts">
import { toTypedSchema } from '@vee-validate/zod'
import * as z from 'zod'
import { useForm } from 'vee-validate'

const supabase = useSupabaseClient()

const formSchema = toTypedSchema(z.object({
  newPassword: z.string().min(8, 'Password must be at least 8 characters'),
  confirmPassword: z.string()
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword']
}))

const form = useForm({ validationSchema: formSchema })
const isLoading = ref(false)
const message = ref<{ type: 'success' | 'error', text: string } | null>(null)

const onSubmit = form.handleSubmit(async (values) => {
  isLoading.value = true
  message.value = null

  const { error } = await supabase.auth.updateUser({
    password: values.newPassword
  })

  isLoading.value = false

  if (error) {
    message.value = { type: 'error', text: 'Failed to update password. Please try again.' }
    return
  }

  message.value = { type: 'success', text: 'Password updated successfully!' }
  form.resetForm()
})
</script>

<template>
  <form @submit="onSubmit" class="space-y-4">
    <FormField v-slot="{ componentField }" name="newPassword">
      <FormItem>
        <FormLabel>New Password</FormLabel>
        <FormControl>
          <Input
            type="password"
            autocomplete="new-password"
            v-bind="componentField"
          />
        </FormControl>
        <FormMessage />
      </FormItem>
    </FormField>

    <FormField v-slot="{ componentField }" name="confirmPassword">
      <FormItem>
        <FormLabel>Confirm New Password</FormLabel>
        <FormControl>
          <Input
            type="password"
            autocomplete="new-password"
            v-bind="componentField"
          />
        </FormControl>
        <FormMessage />
      </FormItem>
    </FormField>

    <div
      v-if="message"
      :class="[
        'text-sm',
        message.type === 'success' ? 'text-green-600' : 'text-destructive'
      ]"
    >
      {{ message.text }}
    </div>

    <Button type="submit" :disabled="isLoading">
      {{ isLoading ? 'Updating...' : 'Update Password' }}
    </Button>
  </form>
</template>
```

4. Create settings page at pages/settings.vue:
```vue
<script setup lang="ts">
definePageMeta({
  middleware: 'auth'
})

const user = useSupabaseUser()
</script>

<template>
  <div class="max-w-2xl">
    <h1 class="text-2xl font-bold mb-6">Settings</h1>

    <Card>
      <CardHeader>
        <CardTitle>Account</CardTitle>
        <CardDescription>Manage your account settings</CardDescription>
      </CardHeader>
      <CardContent class="space-y-6">
        <div>
          <Label class="text-muted-foreground">Email</Label>
          <p class="mt-1">{{ user?.email }}</p>
        </div>

        <div class="border-t pt-6">
          <h3 class="font-medium mb-4">Change Password</h3>
          <PasswordChangeForm />
        </div>
      </CardContent>
    </Card>
  </div>
</template>
```

5. Create protected dashboard page at pages/index.vue:
```vue
<script setup lang="ts">
definePageMeta({
  middleware: 'auth'
})

const user = useSupabaseUser()
</script>

<template>
  <div>
    <h1 class="text-2xl font-bold mb-4">Dashboard</h1>
    <Card>
      <CardContent class="pt-6">
        <p class="text-muted-foreground">
          Welcome, {{ user?.email }}
        </p>
        <p class="text-muted-foreground mt-2">
          The pickup queue dashboard will be built in Phase 4.
        </p>
        <div class="mt-4">
          <NuxtLink to="/settings" class="text-primary hover:underline">
            Go to Settings
          </NuxtLink>
        </div>
      </CardContent>
    </Card>
  </div>
</template>
```

6. Update default layout to include Settings link:
In layouts/default.vue, add a Settings link next to the Logout button in the header:
```vue
<header class="border-b">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="text-lg font-semibold">Warehouse Pickup Queue</h1>
    <div class="flex items-center gap-4">
      <NuxtLink to="/settings" class="text-sm text-muted-foreground hover:underline">
        Settings
      </NuxtLink>
      <Button variant="ghost" size="sm" @click="logout">
        Logout
      </Button>
    </div>
  </div>
</header>
```
  </action>
  <verify>
    1. Run `cd app && pnpm dev`
    2. Visit http://localhost:3000/ - should redirect to /login (no auth)
    3. Visit http://localhost:3000/password/update - form renders
    4. Visit http://localhost:3000/settings - should redirect to /login (no auth)
  </verify>
  <done>
    All auth pages created: password update with validation, confirm callback handler, settings page with embedded password change form, protected dashboard with welcome message and settings link
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete staff authentication flow with login, logout, password reset, and password change</what-built>
  <how-to-verify>
IMPORTANT: You must first configure Supabase credentials for auth to work.

1. Set up Supabase (if not done):
   - Go to your Supabase project dashboard
   - Get SUPABASE_URL and SUPABASE_KEY from Settings > API
   - Create app/.env with these values (copy from app/.env.example)
   - In Supabase Dashboard > Authentication > Providers > Email:
     - Toggle OFF "Confirm email" (allows admin-created users to login)
   - In Supabase Dashboard > Authentication > URL Configuration:
     - Add http://localhost:3000/password/update to Redirect URLs

2. Create a test user:
   - Supabase Dashboard > Authentication > Users > Add user
   - Enter email and password (e.g., test@example.com / testpass123)

3. Test the flow:
   a. Run `cd app && pnpm dev`
   b. Visit http://localhost:3000 - should redirect to /login
   c. Enter invalid credentials - should show "Invalid email or password"
   d. Enter valid credentials - should redirect to dashboard
   e. Verify user email is shown on dashboard
   f. Click "Settings" link - should go to settings page
   g. Change password (enter new password twice) - should show success
   h. Click "Logout" - should redirect to /login
   i. Login with NEW password - should work
   j. Refresh page while logged in - should stay logged in (session persistence)
   k. Visit http://localhost:3000/forgot-password
   l. Enter email and submit - should show "check your email" message

4. Verify protected routes:
   - While logged out, try visiting http://localhost:3000/settings
   - Should redirect to /login
  </how-to-verify>
  <resume-signal>Type "approved" to confirm auth flow works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. All auth pages exist and render correctly
2. Login with valid credentials redirects to protected dashboard
3. Invalid credentials show error message
4. Logout clears session and redirects to login
5. Protected routes (/settings, /) redirect to /login when unauthenticated
6. Password change form on settings page works
7. Session persists across browser refresh
8. Forgot password flow sends reset email
</verification>

<success_criteria>
- Staff can log in with email/password (STAFF-01)
- Staff can log out from dashboard or settings page
- Unauthenticated users are redirected to login (success criteria #4)
- Staff can change their password via settings page
- Staff can reset forgotten password via email
- Session persists across browser refresh (success criteria #2)
- Only authenticated users access dashboard routes (success criteria #5)
</success_criteria>

<output>
After completion, create `.planning/phases/03-staff-authentication/03-02-SUMMARY.md`
</output>
