---
phase: 24-unified-queue-table
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - staff/app/components/dashboard/QueueTable.vue
  - staff/app/composables/useKeyboardReorder.ts
autonomous: true

must_haves:
  truths:
    - "User can press Space to grab a focused row in drag mode"
    - "Arrow keys move grabbed row up/down in the list"
    - "Cmd/Ctrl+Arrow jumps row to top/bottom"
    - "Screen readers announce grab, move, and drop actions"
  artifacts:
    - path: "staff/app/composables/useKeyboardReorder.ts"
      provides: "Keyboard reorder state machine and handlers"
      min_lines: 50
      exports: ["useKeyboardReorder"]
    - path: "staff/app/components/dashboard/QueueTable.vue"
      provides: "Keyboard accessible drag mode"
      contains: "aria-live"
  key_links:
    - from: "staff/app/components/dashboard/QueueTable.vue"
      to: "staff/app/composables/useKeyboardReorder.ts"
      via: "composable import"
      pattern: "useKeyboardReorder"
    - from: "staff/app/components/dashboard/QueueTable.vue"
      to: "aria-live region"
      via: "screen reader announcements"
      pattern: 'aria-live="assertive"'
---

<objective>
Add keyboard accessibility to QueueTable drag mode, allowing users to reorder items using arrow keys instead of mouse drag.

Purpose: Meet TBL-04 accessibility requirement. SortableJS lacks keyboard support, so we implement a custom layer.

Output: useKeyboardReorder composable and updated QueueTable with keyboard navigation in drag mode.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-unified-queue-table/24-CONTEXT.md
@.planning/phases/24-unified-queue-table/24-RESEARCH.md
@.planning/phases/24-unified-queue-table/24-01-SUMMARY.md

@staff/app/components/dashboard/QueueTable.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useKeyboardReorder composable</name>
  <files>staff/app/composables/useKeyboardReorder.ts</files>
  <action>
Create composable implementing keyboard reorder state machine per RESEARCH.md:

```typescript
import { ref, type Ref } from 'vue'

type ReorderState = 'idle' | 'grabbed'

interface UseKeyboardReorderOptions<T extends { id: string }> {
  items: Ref<T[]>
  onReorder: (newOrder: string[]) => void
}

export function useKeyboardReorder<T extends { id: string }>(options: UseKeyboardReorderOptions<T>) {
  const reorderState = ref<ReorderState>('idle')
  const grabbedIndex = ref<number | null>(null)
  const announcement = ref('')

  function announceGrab(index: number) {
    const item = options.items.value[index]
    announcement.value = `${item.sales_order_number || 'Item'} grabbed. Position ${index + 1} of ${options.items.value.length}. Use arrow keys to move, Space to drop, Escape to cancel.`
  }

  function announceMove(newIndex: number) {
    announcement.value = `Moved to position ${newIndex + 1} of ${options.items.value.length}`
  }

  function announceDrop(index: number) {
    announcement.value = `Dropped at position ${index + 1}`
    // Emit the new order
    options.onReorder(options.items.value.map(i => i.id))
  }

  function announceCancel() {
    announcement.value = 'Reorder cancelled'
  }

  function moveItem(fromIndex: number, toIndex: number) {
    const items = [...options.items.value]
    const [moved] = items.splice(fromIndex, 1)
    items.splice(toIndex, 0, moved)
    options.items.value = items
    return toIndex
  }

  function handleKeydown(e: KeyboardEvent, index: number): number | null {
    const items = options.items.value
    const isMeta = e.metaKey || e.ctrlKey

    if (reorderState.value === 'idle') {
      if (e.key === ' ') {
        e.preventDefault()
        reorderState.value = 'grabbed'
        grabbedIndex.value = index
        announceGrab(index)
        return index
      }
    } else if (reorderState.value === 'grabbed' && grabbedIndex.value !== null) {
      const currentIndex = grabbedIndex.value

      if (e.key === 'ArrowUp') {
        e.preventDefault()
        const newIndex = isMeta ? 0 : Math.max(0, currentIndex - 1)
        if (newIndex !== currentIndex) {
          moveItem(currentIndex, newIndex)
          grabbedIndex.value = newIndex
          announceMove(newIndex)
        }
        return newIndex
      }

      if (e.key === 'ArrowDown') {
        e.preventDefault()
        const newIndex = isMeta ? items.length - 1 : Math.min(items.length - 1, currentIndex + 1)
        if (newIndex !== currentIndex) {
          moveItem(currentIndex, newIndex)
          grabbedIndex.value = newIndex
          announceMove(newIndex)
        }
        return newIndex
      }

      if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault()
        const finalIndex = grabbedIndex.value
        reorderState.value = 'idle'
        announceDrop(finalIndex)
        grabbedIndex.value = null
        return finalIndex
      }

      if (e.key === 'Escape') {
        e.preventDefault()
        reorderState.value = 'idle'
        grabbedIndex.value = null
        announceCancel()
        // Note: caller should restore original order on Escape
        return null
      }
    }
    return null
  }

  return {
    reorderState,
    grabbedIndex,
    announcement,
    handleKeydown,
  }
}
```

Key behaviors (from CONTEXT.md):
- Space to enter grabbed state, Space/Enter to drop
- Arrow keys move single step
- Cmd/Ctrl+Up jumps to top, Cmd/Ctrl+Down jumps to bottom
- Escape cancels (caller must handle reverting)
- Announcements for screen readers
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npm run typecheck
```
  </verify>
  <done>
useKeyboardReorder.ts exists with state machine, keyboard handlers, and announcement refs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate keyboard accessibility into QueueTable drag mode</name>
  <files>staff/app/components/dashboard/QueueTable.vue</files>
  <action>
Update QueueTable.vue to use useKeyboardReorder in drag mode:

1. Import the composable:
```typescript
import { useKeyboardReorder } from '@/composables/useKeyboardReorder'
```

2. Set up keyboard reorder (only in drag mode):
```typescript
// Store original order for Escape cancellation
const originalOrder = ref<string[]>([])

const { reorderState, grabbedIndex, announcement, handleKeydown: keyboardHandler } = useKeyboardReorder({
  items: localItems,
  onReorder: (newOrder) => emit('reorder', newOrder)
})
```

3. Add aria-live region to template (always present, only used in drag mode):
```vue
<div
  aria-live="assertive"
  aria-atomic="true"
  class="sr-only"
>
  {{ announcement }}
</div>
```

4. Make drag mode rows focusable and handle keyboard:
```vue
<div
  v-for="(item, index) in localItems"
  :key="item.id"
  tabindex="0"
  role="option"
  :aria-selected="grabbedIndex === index"
  :class="[
    'flex items-center gap-3 p-3 border-b focus:outline-none focus:ring-2 focus:ring-ring',
    grabbedIndex === index ? 'bg-accent' : 'hover:bg-muted/50'
  ]"
  @keydown="(e) => handleRowKeydown(e, index)"
  @focus="() => handleRowFocus(index)"
>
```

5. Add row keyboard handler:
```typescript
function handleRowKeydown(e: KeyboardEvent, index: number) {
  if (props.mode !== 'drag') return

  // Capture original order when starting keyboard reorder
  if (reorderState.value === 'idle' && e.key === ' ') {
    originalOrder.value = localItems.value.map(i => i.id)
  }

  const newIndex = keyboardHandler(e, index)

  // Handle Escape - restore original order
  if (e.key === 'Escape' && originalOrder.value.length > 0) {
    // Restore original order by matching IDs
    localItems.value = originalOrder.value.map(id =>
      localItems.value.find(item => item.id === id)!
    )
    originalOrder.value = []
  }

  // Refocus moved row
  if (newIndex !== null && newIndex !== index) {
    nextTick(() => {
      const rows = listRef.value?.querySelectorAll('[tabindex="0"]')
      if (rows && rows[newIndex]) {
        (rows[newIndex] as HTMLElement).focus()
      }
    })
  }
}
```

6. Add container role for accessibility:
```vue
<div
  v-else
  ref="listRef"
  role="listbox"
  aria-label="Reorderable queue"
>
```

7. Visual feedback for grabbed state - the row with grabbedIndex should have distinct styling (already done via :class binding above with bg-accent).
  </action>
  <verify>
Manual verification:
1. Open dashboard, go to a gate tab
2. Tab to focus a queue row
3. Press Space - row should highlight, announcement should read
4. Press Arrow Down - row should move down
5. Press Cmd+Up (Mac) or Ctrl+Up (Win) - row should jump to top
6. Press Space to drop or Escape to cancel
7. `npm run typecheck` passes
  </verify>
  <done>
QueueTable drag mode supports keyboard reordering with Space to grab, arrows to move, Cmd/Ctrl+arrows for jump, Space/Enter to drop, Escape to cancel. Screen reader announcements work via aria-live region.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npm run typecheck` passes
2. Keyboard flow works: Tab to row -> Space -> Arrow -> Space
3. Cmd/Ctrl modifiers jump to top/bottom
4. Escape reverts to original order
5. aria-live region announces actions
6. Focus follows moved row
</verification>

<success_criteria>
- useKeyboardReorder.ts composable exists and exports properly
- QueueTable drag mode rows are focusable (tabindex="0")
- Space key enters grabbed state with visual feedback
- Arrow keys move row, Cmd/Ctrl+arrows jump to ends
- Space/Enter drops row and emits reorder
- Escape cancels and reverts
- aria-live region announces all state changes
- Focus management keeps focus on moved row
</success_criteria>

<output>
After completion, create `.planning/phases/24-unified-queue-table/24-02-SUMMARY.md`
</output>
