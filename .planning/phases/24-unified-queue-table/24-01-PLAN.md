---
phase: 24-unified-queue-table
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/components/dashboard/QueueTable.vue
  - staff/app/components/dashboard/queueTableColumns.ts
autonomous: true

must_haves:
  truths:
    - "QueueTable renders sortable headers in sort mode"
    - "QueueTable renders drag handles in drag mode"
    - "Drag-and-drop reorders rows with optimistic update"
    - "Sort mode allows clicking headers to sort"
  artifacts:
    - path: "staff/app/components/dashboard/QueueTable.vue"
      provides: "Unified table component with mode prop"
      min_lines: 100
    - path: "staff/app/components/dashboard/queueTableColumns.ts"
      provides: "Column definitions with sortable headers"
      contains: "createSortableColumns"
  key_links:
    - from: "staff/app/components/dashboard/QueueTable.vue"
      to: "@tanstack/vue-table"
      via: "useVueTable for sort mode"
      pattern: "useVueTable"
    - from: "staff/app/components/dashboard/QueueTable.vue"
      to: "@vueuse/integrations/useSortable"
      via: "useSortable for drag mode"
      pattern: "useSortable"
---

<objective>
Create the unified QueueTable component that supports both sort mode (for All Requests tab) and drag mode (for gate-specific tabs).

Purpose: Replace two separate table implementations (RequestsTable, GateQueueList) with a single component that switches behavior based on mode prop.

Output: QueueTable.vue component with mode='sort' and mode='drag' support, plus updated column definitions file.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-unified-queue-table/24-CONTEXT.md
@.planning/phases/24-unified-queue-table/24-RESEARCH.md

# Existing patterns to merge
@staff/app/components/dashboard/RequestsTable.vue
@staff/app/components/dashboard/GateQueueList.vue
@staff/app/components/dashboard/requestsTableColumns.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QueueTable component with dual mode support</name>
  <files>staff/app/components/dashboard/QueueTable.vue</files>
  <action>
Create QueueTable.vue combining RequestsTable (sort) and GateQueueList (drag) patterns:

Props interface:
- `mode: 'sort' | 'drag'` - determines behavior
- `columns: ColumnDef<TData, TValue>[]` - for TanStack table
- `data: TData[]` - table rows
- `gateId?: string` - required for drag mode (used in reorder emit)

Emits:
- `row-click: [row: TData]` - when row clicked (exclude button/handle clicks)
- `reorder: [requestIds: string[]]` - after drag completes (drag mode only)

Sort mode implementation (from RequestsTable):
- Use `useVueTable` with `getCoreRowModel`, `getSortedRowModel`
- Column headers render via FlexRender with sorting callbacks
- Track `sorting` ref as `SortingState`
- Rows are clickable, emit row-click

Drag mode implementation (from GateQueueList):
- Use `useSortable` from @vueuse/integrations
- `localItems = shallowRef([...props.data])` for optimistic updates
- Watch props.data to sync external changes
- Handle option: `.drag-handle` class
- ghostClass: 'opacity-50', dragClass: 'bg-accent'
- On drag complete: `moveArrayElement`, then emit reorder with new ID order

Template structure:
```vue
<template>
  <div class="rounded-md border">
    <!-- Sort mode: standard table with TanStack -->
    <Table v-if="mode === 'sort'">
      <TableHeader>...</TableHeader>
      <TableBody>
        <TableRow v-for="row" @click="emit('row-click', row.original)">
          <TableCell v-for="cell">
            <FlexRender :render="cell.column.columnDef.cell" />
          </TableCell>
        </TableRow>
      </TableBody>
    </Table>

    <!-- Drag mode: card-style rows with handles -->
    <div v-else ref="listRef">
      <div v-for="item in localItems" class="flex items-center gap-3 p-3 border-b">
        <div class="drag-handle cursor-grab">
          <GripVertical />
        </div>
        <!-- Render cells using FlexRender for consistency -->
        <div class="flex-1 grid grid-cols-[1fr_auto_auto] gap-4 items-center">
          <!-- Order # and Company -->
          <div class="min-w-0">
            <div class="font-medium">{{ item.sales_order_number }}</div>
            <div class="text-sm text-muted-foreground">{{ item.company_name || 'N/A' }}</div>
          </div>
          <!-- Status badge -->
          <StatusBadge :status="item.status" />
          <!-- Actions slot or default actions -->
        </div>
      </div>
    </div>
  </div>
</template>
```

Key decisions (from CONTEXT.md):
- Drag handle on far left edge (grip icon before content)
- Column headers visible in both modes but NOT clickable in drag mode
- Ghost row follows cursor (opacity-50)
- Same column structure in both modes for consistency

Do NOT include keyboard accessibility yet - that's Plan 02.
  </action>
  <verify>
Create test file or manually verify:
1. Import QueueTable in a scratch page
2. Pass mode='sort' with columns/data - headers should be sortable
3. Pass mode='drag' with data - rows should have grip handles and be draggable
4. `npm run typecheck` passes
  </verify>
  <done>
QueueTable.vue exists with working sort and drag modes. Both modes render data correctly, sort mode allows header clicks, drag mode shows handles and supports reordering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor column definitions for unified component</name>
  <files>staff/app/components/dashboard/queueTableColumns.ts</files>
  <action>
Rename `requestsTableColumns.ts` to `queueTableColumns.ts` and refactor for unified use:

1. Keep existing `createColumns()` function for full table view (All Requests)
2. Add `createDragModeColumns()` function for simplified drag mode view:
   - Only needs: Order #, Company, Status columns
   - NO sortable headers (not clickable in drag mode)
   - Status uses StatusBadge component

```typescript
export function createDragModeColumns(): ColumnDef<QueueItem>[] {
  return [
    {
      accessorKey: 'sales_order_number',
      header: 'Order #',
      // Simple header, no onClick
    },
    {
      accessorKey: 'company_name',
      header: 'Company',
      cell: ({ row }) => row.getValue('company_name') || 'N/A',
    },
    {
      accessorKey: 'status',
      header: 'Status',
      cell: ({ row }) => h(StatusBadge, { status: row.getValue('status') }),
    },
  ]
}
```

3. Update re-exports comment to note this is now queueTableColumns
4. Export new QueueItem type for drag mode (subset of PickupRequest):
```typescript
export interface QueueItem {
  id: string
  sales_order_number: string
  company_name: string | null
  status: PickupStatus
  queue_position: number
  is_priority: boolean
}
```

Keep backward-compat re-exports for now (CLN-02 is separate cleanup).
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npm run typecheck
```
Verify file renamed and both column factories work.
  </verify>
  <done>
queueTableColumns.ts exists with createColumns() for sort mode and createDragModeColumns() for drag mode. Both export correctly typed column definitions.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. QueueTable.vue imports from queueTableColumns.ts without errors
2. `npm run typecheck` passes in staff/
3. Component can switch between modes via prop
4. Sort mode: clicking headers changes sort order
5. Drag mode: dragging rows updates localItems and emits reorder
</verification>

<success_criteria>
- QueueTable.vue exists with mode prop ('sort' | 'drag')
- Sort mode uses TanStack table with sortable headers
- Drag mode uses useSortable with drag handles
- Column definitions refactored to queueTableColumns.ts
- Both createColumns() and createDragModeColumns() exported
- Type check passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-unified-queue-table/24-01-SUMMARY.md`
</output>
