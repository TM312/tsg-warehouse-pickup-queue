---
phase: 24-unified-queue-table
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/components/dashboard/QueueTable.vue
  - staff/app/components/dashboard/queueTableColumns.ts
autonomous: true

must_haves:
  truths:
    - "QueueTable renders sortable headers with direction arrows in sort mode"
    - "QueueTable renders drag handles in drag mode"
    - "QueueTable uses same columns in both modes"
    - "Default sort is created_at descending (newest first)"
    - "Drag mode includes action buttons (Priority, Complete)"
  artifacts:
    - path: "staff/app/components/dashboard/QueueTable.vue"
      provides: "Unified table component with mode prop"
      min_lines: 100
    - path: "staff/app/components/dashboard/queueTableColumns.ts"
      provides: "Column definitions with sortable headers and direction indicators"
      contains: "ArrowUp"
  key_links:
    - from: "staff/app/components/dashboard/QueueTable.vue"
      to: "@tanstack/vue-table"
      via: "useVueTable for sort mode"
      pattern: "useVueTable"
    - from: "staff/app/components/dashboard/QueueTable.vue"
      to: "@vueuse/integrations/useSortable"
      via: "useSortable for drag mode"
      pattern: "useSortable"
---

<objective>
Create the unified QueueTable component that supports both sort mode (for All Requests tab) and drag mode (for gate-specific tabs).

Purpose: Replace two separate table implementations (RequestsTable, GateQueueList) with a single component that switches behavior based on mode prop.

Output: QueueTable.vue component with mode='sort' and mode='drag' support, plus updated column definitions file.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-unified-queue-table/24-CONTEXT.md
@.planning/phases/24-unified-queue-table/24-RESEARCH.md

# Existing patterns to merge
@staff/app/components/dashboard/RequestsTable.vue
@staff/app/components/dashboard/GateQueueList.vue
@staff/app/components/dashboard/requestsTableColumns.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QueueTable component with dual mode support</name>
  <files>staff/app/components/dashboard/QueueTable.vue</files>
  <action>
Create QueueTable.vue combining RequestsTable (sort) and GateQueueList (drag) patterns:

Props interface:
- `mode: 'sort' | 'drag'` - determines behavior
- `columns: ColumnDef<TData, TValue>[]` - for TanStack table
- `data: TData[]` - table rows
- `gateId?: string` - required for drag mode (used in reorder emit)

Emits (ALL modes):
- `row-click: [row: TData]` - when row clicked (exclude button/handle clicks)

Emits (drag mode only):
- `reorder: [requestIds: string[]]` - after drag completes
- `set-priority: [requestId: string]` - when priority button clicked
- `clear-priority: [requestId: string]` - when priority badge X clicked
- `complete: [requestId: string]` - when complete button clicked

Sort mode implementation (from RequestsTable):
- Use `useVueTable` with `getCoreRowModel`, `getSortedRowModel`
- **Initialize sorting state with `created_at` descending (newest first) per CONTEXT.md decision**
- Column headers render via FlexRender with sorting callbacks
- **Sort direction indicated by arrow icons (ArrowUp when ascending, ArrowDown when descending, ArrowUpDown when unsorted)**
- Track `sorting` ref as `SortingState`
- Rows are clickable, emit row-click

Drag mode implementation (from GateQueueList):
- Use `useSortable` from @vueuse/integrations
- `localItems = shallowRef([...props.data])` for optimistic updates
- Watch props.data to sync external changes
- Handle option: `.drag-handle` class
- ghostClass: 'opacity-50', dragClass: 'bg-accent'
- On drag complete: `moveArrayElement`, then emit reorder with new ID order
- **Render same columns as sort mode** (per CONTEXT.md "Same columns in both modes for consistency")
- **Column headers visible but NOT clickable in drag mode**
- **Include inline action buttons from GateQueueList: PriorityButton and Complete button**

Template structure:
```vue
<template>
  <div class="rounded-md border">
    <!-- Sort mode: standard table with TanStack -->
    <Table v-if="mode === 'sort'">
      <TableHeader>
        <TableRow>
          <TableHead v-for="header in table.getHeaderGroups()[0].headers" :key="header.id">
            <FlexRender :render="header.column.columnDef.header" :props="header.getContext()" />
          </TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        <TableRow v-for="row" @click="emit('row-click', row.original)">
          <TableCell v-for="cell">
            <FlexRender :render="cell.column.columnDef.cell" :props="cell.getContext()" />
          </TableCell>
        </TableRow>
      </TableBody>
    </Table>

    <!-- Drag mode: table structure with drag handles and action buttons -->
    <div v-else ref="listRef">
      <!-- Column headers (visible but not clickable in drag mode) -->
      <div class="flex items-center gap-3 px-3 py-2 border-b bg-muted/50 text-sm font-medium text-muted-foreground">
        <div class="w-6"></div> <!-- Space for drag handle -->
        <div class="flex-1 grid grid-cols-[minmax(100px,1fr)_minmax(100px,1fr)_80px_60px_80px_120px_100px] gap-4 items-center">
          <!-- Same column headers as sort mode, but static text -->
          <div>Order #</div>
          <div>Company</div>
          <div>Status</div>
          <div>Flag</div>
          <div>Gate</div>
          <div>Position</div>
          <div>Created</div>
        </div>
        <div class="w-[180px]">Actions</div>
      </div>

      <!-- Rows with drag handles -->
      <div
        v-for="item in localItems"
        :key="item.id"
        class="flex items-center gap-3 p-3 border-b hover:bg-muted/50 cursor-pointer transition-colors"
        @click="(e) => handleRowClick(e, item)"
      >
        <div class="drag-handle cursor-grab active:cursor-grabbing">
          <GripVertical class="h-5 w-5 text-muted-foreground" />
        </div>
        <div class="flex-1 grid grid-cols-[minmax(100px,1fr)_minmax(100px,1fr)_80px_60px_80px_120px_100px] gap-4 items-center">
          <!-- Render same data as columns -->
          <div class="font-medium truncate">{{ item.sales_order_number }}</div>
          <div class="text-sm text-muted-foreground truncate">{{ item.company_name || 'N/A' }}</div>
          <StatusBadge :status="item.status" :processing-started-at="item.processing_started_at" />
          <Flag v-if="item.email_flagged" class="h-4 w-4 text-destructive" />
          <div v-else>-</div>
          <div>Gate {{ gateNumber }}</div>
          <div>#{{ item.queue_position }}</div>
          <div class="text-sm">{{ formatDate(item.created_at) }}</div>
        </div>
        <!-- Action buttons (from GateQueueList) -->
        <div class="flex items-center gap-2 w-[180px] justify-end">
          <Badge
            v-if="item.is_priority"
            variant="destructive"
            class="shrink-0 cursor-pointer hover:bg-destructive/80"
            title="Click to remove priority"
            @click.stop="emit('clear-priority', item.id)"
          >
            Priority
            <X class="h-3 w-3 ml-1" />
          </Badge>
          <PriorityButton
            v-if="!item.is_priority"
            @click.stop="emit('set-priority', item.id)"
          />
          <Button
            variant="outline"
            size="sm"
            title="Mark complete"
            @click.stop="emit('complete', item.id)"
          >
            <Check class="h-4 w-4 mr-1" />
            Complete
          </Button>
        </div>
      </div>
    </div>
  </div>
</template>
```

Key decisions (from CONTEXT.md):
- Drag handle on far left edge (grip icon before content)
- Column headers visible in both modes but NOT clickable in drag mode
- Ghost row follows cursor (opacity-50)
- **Same columns in both modes for consistency**
- **Default sort: created time, newest first (initialized in sorting ref)**
- **Sort direction indicated by arrow in column header (ArrowUp/ArrowDown)**

Do NOT include keyboard accessibility yet - that's Plan 02.
  </action>
  <verify>
Create test file or manually verify:
1. Import QueueTable in a scratch page
2. Pass mode='sort' with columns/data - headers should be sortable with direction arrows
3. Pass mode='drag' with data - rows should have grip handles, same columns, and action buttons
4. Sort mode should default to created_at descending
5. `npm run typecheck` passes
  </verify>
  <done>
QueueTable.vue exists with working sort and drag modes. Both modes render same columns, sort mode shows direction arrows and defaults to created_at descending, drag mode shows handles and action buttons (Priority, Complete) with corresponding emits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update column definitions with sort direction indicators</name>
  <files>staff/app/components/dashboard/queueTableColumns.ts</files>
  <action>
Rename `requestsTableColumns.ts` to `queueTableColumns.ts` and update column headers to show sort direction:

1. Update sortable column headers to show direction-specific arrows:

```typescript
import { ArrowUp, ArrowDown, ArrowUpDown } from 'lucide-vue-next'

// Helper to render sort header with direction indicator
function createSortableHeader(label: string) {
  return ({ column }) => {
    const isSorted = column.getIsSorted()
    return h(Button, {
      variant: 'ghost',
      onClick: () => column.toggleSorting(column.getIsSorted() === 'asc'),
    }, () => [
      label,
      isSorted === 'asc'
        ? h(ArrowUp, { class: 'ml-2 h-4 w-4' })
        : isSorted === 'desc'
          ? h(ArrowDown, { class: 'ml-2 h-4 w-4' })
          : h(ArrowUpDown, { class: 'ml-2 h-4 w-4' })
    ])
  }
}
```

2. Update createColumns() to use the new helper:

```typescript
export function createColumns(callbacks: ColumnCallbacks): ColumnDef<PickupRequest>[] {
  return [
    {
      accessorKey: 'sales_order_number',
      header: createSortableHeader('Order #'),
    },
    // ... company_name (not sortable, static header)
    // ... status (not sortable, static header)
    // ... email_flagged (not sortable, static header)
    // ... gate (not sortable, static header)
    // ... position (not sortable, static header)
    {
      accessorKey: 'created_at',
      header: createSortableHeader('Created'),
      cell: ({ row }) => {
        const date = new Date(row.getValue('created_at'))
        return date.toLocaleString()
      },
    },
    // ... actions
  ]
}
```

3. Keep existing `createColumns()` function - it provides ALL columns for both modes
4. Do NOT create `createDragModeColumns()` - per CONTEXT.md decision "Same columns in both modes for consistency"
5. Update re-exports comment to note this is now queueTableColumns
6. Export QueueItem type (subset of PickupRequest for drag mode interface):

```typescript
export interface QueueItem {
  id: string
  sales_order_number: string
  company_name: string | null
  status: PickupStatus
  queue_position: number
  is_priority: boolean
  email_flagged: boolean
  created_at: string
  processing_started_at: string | null
}
```

Keep backward-compat re-exports for now (CLN-02 is separate cleanup).
  </action>
  <verify>
```bash
cd /Users/thomas/Projects/tsg/warehouse-pickup-queue/staff && npm run typecheck
```
Verify:
1. File renamed to queueTableColumns.ts
2. Sort headers show ArrowUp when ascending, ArrowDown when descending, ArrowUpDown when unsorted
3. No createDragModeColumns() function exists (same columns used in both modes)
  </verify>
  <done>
queueTableColumns.ts exists with createColumns() using direction-specific sort arrows (ArrowUp/ArrowDown/ArrowUpDown). Same columns used for both modes per user decision.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. QueueTable.vue imports from queueTableColumns.ts without errors
2. `npm run typecheck` passes in staff/
3. Component can switch between modes via prop
4. Sort mode: clicking headers changes sort order with direction arrow feedback
5. Sort mode: defaults to created_at descending (newest first)
6. Drag mode: same columns visible, headers not clickable
7. Drag mode: dragging rows updates localItems and emits reorder
8. Drag mode: Priority and Complete buttons work, emit set-priority/clear-priority/complete
</verification>

<success_criteria>
- QueueTable.vue exists with mode prop ('sort' | 'drag')
- Sort mode uses TanStack table with sortable headers showing direction arrows
- Sort mode initializes with created_at descending
- Drag mode uses useSortable with drag handles
- Drag mode renders same columns as sort mode (headers visible but not clickable)
- Drag mode includes action buttons (Priority, Complete) with proper emits
- Column definitions refactored to queueTableColumns.ts
- createColumns() exported with direction-aware sort headers
- NO createDragModeColumns() - same columns used in both modes
- Type check passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-unified-queue-table/24-01-SUMMARY.md`
</output>
