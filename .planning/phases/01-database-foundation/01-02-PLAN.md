---
phase: 01-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/migrations/20260128000004_enable_rls.sql
  - supabase/migrations/20260128000005_create_rls_policies.sql
  - supabase/migrations/20260128000006_create_triggers.sql
  - supabase/seed.sql
autonomous: true

must_haves:
  truths:
    - "RLS is enabled on all three tables"
    - "Staff (authenticated) can read and write all data"
    - "Customers (anon) can read business_hours"
    - "Customers (anon) can read their own pickup request"
    - "updated_at is automatically set on row updates"
  artifacts:
    - path: "supabase/migrations/20260128000004_enable_rls.sql"
      provides: "RLS enablement for all tables"
      contains: "ENABLE ROW LEVEL SECURITY"
    - path: "supabase/migrations/20260128000005_create_rls_policies.sql"
      provides: "Access control policies"
      contains: "CREATE POLICY"
    - path: "supabase/migrations/20260128000006_create_triggers.sql"
      provides: "Automatic timestamp triggers"
      contains: "moddatetime"
    - path: "supabase/seed.sql"
      provides: "Test data for local development"
      contains: "INSERT INTO gates"
  key_links:
    - from: "supabase/migrations/20260128000005_create_rls_policies.sql"
      to: "supabase/migrations/20260128000001_create_gates_table.sql"
      via: "RLS policy on table"
      pattern: "ON gates"
    - from: "supabase/migrations/20260128000005_create_rls_policies.sql"
      to: "supabase/migrations/20260128000002_create_pickup_requests_table.sql"
      via: "RLS policy on table"
      pattern: "ON pickup_requests"
    - from: "supabase/migrations/20260128000006_create_triggers.sql"
      to: "supabase/migrations/20260128000000_create_extensions.sql"
      via: "uses moddatetime extension"
      pattern: "moddatetime"
---

<objective>
Add Row-Level Security policies and automatic timestamp triggers to all database tables.

Purpose: Enforce data access rules at the database level (not application level) and ensure audit timestamps are always accurate. This is critical security infrastructure - 83% of exposed Supabase databases involve RLS misconfigurations.

Output: 3 migration files (RLS enablement, RLS policies, triggers) and seed data for local development.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable RLS and create policies</name>
  <files>
supabase/migrations/20260128000004_enable_rls.sql
supabase/migrations/20260128000005_create_rls_policies.sql
  </files>
  <action>
Create 2 migration files for Row-Level Security:

**20260128000004_enable_rls.sql:**
Enable RLS on all three tables:
```sql
ALTER TABLE gates ENABLE ROW LEVEL SECURITY;
ALTER TABLE pickup_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_hours ENABLE ROW LEVEL SECURITY;
```

**20260128000005_create_rls_policies.sql:**
Create policies following research patterns. ALWAYS specify target role (TO authenticated/anon) for performance.

**Gates policies:**
- "Anyone can view active gates" - SELECT TO anon, authenticated WHERE is_active = true
- "Staff can view all gates" - SELECT TO authenticated (USING true)
- "Staff can manage gates" - ALL TO authenticated (USING true, WITH CHECK true)

**Pickup_requests policies:**
- "Staff can view all requests" - SELECT TO authenticated (USING true)
- "Staff can manage requests" - ALL TO authenticated (USING true, WITH CHECK true)
- "Customers can view limited request data" - SELECT TO anon (USING true) - Note: In v1, customer view will be scoped by session token in application layer; RLS allows read but limits columns via view/function in later phase

**Business_hours policies:**
- "Anyone can view business hours" - SELECT TO anon, authenticated (USING true)
- "Staff can manage business hours" - ALL TO authenticated (USING true, WITH CHECK true)

IMPORTANT per research:
- Always use `TO authenticated` or `TO anon` in policies (not raw USING clauses)
- This allows PostgreSQL to skip policy evaluation for irrelevant roles
- Use `(SELECT auth.uid())` pattern for functions to enable caching (if used later)
  </action>
  <verify>
- Both migration files exist
- `grep -c "ENABLE ROW LEVEL SECURITY" supabase/migrations/*enable_rls*.sql` returns 3
- `grep -c "CREATE POLICY" supabase/migrations/*policies*.sql` returns at least 8 policies
- `grep "TO authenticated" supabase/migrations/*policies*.sql` confirms role specification
  </verify>
  <done>
RLS enabled on all tables with proper access policies:
- Gates: public read (active only), staff full access
- Pickup_requests: staff full access, anon read-only
- Business_hours: public read, staff full access
  </done>
</task>

<task type="auto">
  <name>Task 2: Create timestamp triggers and seed data</name>
  <files>
supabase/migrations/20260128000006_create_triggers.sql
supabase/seed.sql
  </files>
  <action>
**20260128000006_create_triggers.sql:**
Create triggers for automatic updated_at using moddatetime extension:

```sql
-- Gates updated_at trigger
CREATE TRIGGER handle_gates_updated_at
  BEFORE UPDATE ON gates
  FOR EACH ROW
  EXECUTE PROCEDURE moddatetime(updated_at);

-- Pickup_requests updated_at trigger
CREATE TRIGGER handle_pickup_requests_updated_at
  BEFORE UPDATE ON pickup_requests
  FOR EACH ROW
  EXECUTE PROCEDURE moddatetime(updated_at);

-- Business_hours updated_at trigger
CREATE TRIGGER handle_business_hours_updated_at
  BEFORE UPDATE ON business_hours
  FOR EACH ROW
  EXECUTE PROCEDURE moddatetime(updated_at);
```

**supabase/seed.sql:**
Create test data for local development:

1. Insert 4 gates (Gate 1-4, all active)
2. Insert business hours for Monday-Friday 7:00-17:00, Saturday-Sunday closed
3. Insert 2-3 sample pickup requests in different states (pending, approved, in_queue)

This data helps verify the schema works and provides realistic data for development.
  </action>
  <verify>
- `grep -c "CREATE TRIGGER" supabase/migrations/*triggers*.sql` returns 3
- `grep "moddatetime" supabase/migrations/*triggers*.sql` confirms extension usage
- `grep "INSERT INTO gates" supabase/seed.sql` confirms seed data
- `grep "INSERT INTO business_hours" supabase/seed.sql` confirms business hours seeded
  </verify>
  <done>
Triggers and seed data created:
- updated_at automatically maintained on all tables
- 4 gates seeded for local development
- Business hours for standard warehouse schedule
- Sample pickup requests in various states
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate complete schema</name>
  <files>(none - validation only)</files>
  <action>
Run schema validation to ensure all migrations are syntactically correct and properly ordered:

1. List all migrations in order: `ls -la supabase/migrations/`
2. Check that timestamps are sequential (000000 through 000006)
3. Verify no syntax errors by checking file contents
4. Confirm the dependency order is correct:
   - Extensions first (000000)
   - Tables that have no dependencies (gates: 000001)
   - Tables that reference other tables (pickup_requests: 000002 references gates)
   - Independent tables (business_hours: 000003)
   - RLS enablement (000004)
   - RLS policies (000005)
   - Triggers (000006)

Document any issues found for correction.
  </action>
  <verify>
- 7 migration files exist (000000 through 000006)
- Files are properly sequenced by timestamp
- Each file has valid SQL syntax (no obvious typos)
- Foreign key in pickup_requests references gates (which is created earlier)
  </verify>
  <done>
Schema validation complete:
- All 7 migrations in correct dependency order
- Foreign key constraints properly sequenced
- RLS enabled before policies created
- Extensions available for triggers
  </done>
</task>

</tasks>

<verification>
1. `ls supabase/migrations/ | wc -l` returns 7 (or more if additional files created)
2. `grep -r "ENABLE ROW LEVEL SECURITY" supabase/migrations/` shows all 3 tables
3. `grep -r "CREATE POLICY" supabase/migrations/` shows all expected policies
4. `grep -r "CREATE TRIGGER" supabase/migrations/` shows 3 triggers
5. `cat supabase/seed.sql` shows reasonable test data
6. All migration filenames follow YYYYMMDDHHMMSS_description.sql pattern
</verification>

<success_criteria>
- RLS enabled on gates, pickup_requests, and business_hours tables
- Gates: anon can view active, authenticated has full access
- Pickup_requests: authenticated has full access, anon has read access
- Business_hours: public read, authenticated full access
- All policies specify target role (TO authenticated/anon)
- updated_at triggers fire on all three tables
- Seed data provides realistic local development environment
- All migrations follow correct dependency ordering
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-02-SUMMARY.md`
</output>
