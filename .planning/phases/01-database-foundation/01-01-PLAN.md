---
phase: 01-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/config.toml
  - supabase/migrations/20260128000000_create_extensions.sql
  - supabase/migrations/20260128000001_create_gates_table.sql
  - supabase/migrations/20260128000002_create_pickup_requests_table.sql
  - supabase/migrations/20260128000003_create_business_hours_table.sql
autonomous: true

must_haves:
  truths:
    - "Supabase project is initialized with config.toml"
    - "Gates table exists with id, gate_number, is_active columns"
    - "Pickup_requests table exists with all required fields and status CHECK constraint"
    - "Business_hours table exists with day_of_week, open_time, close_time, is_closed"
    - "All tables have created_at and updated_at timestamp columns"
  artifacts:
    - path: "supabase/config.toml"
      provides: "Supabase project configuration"
      contains: "project_id"
    - path: "supabase/migrations/20260128000000_create_extensions.sql"
      provides: "Required PostgreSQL extensions"
      contains: "moddatetime"
    - path: "supabase/migrations/20260128000001_create_gates_table.sql"
      provides: "Gates table definition"
      contains: "CREATE TABLE gates"
    - path: "supabase/migrations/20260128000002_create_pickup_requests_table.sql"
      provides: "Pickup requests table definition"
      contains: "CHECK (status IN"
    - path: "supabase/migrations/20260128000003_create_business_hours_table.sql"
      provides: "Business hours table definition"
      contains: "CREATE TABLE business_hours"
  key_links:
    - from: "supabase/migrations/20260128000002_create_pickup_requests_table.sql"
      to: "supabase/migrations/20260128000001_create_gates_table.sql"
      via: "foreign key reference"
      pattern: "REFERENCES gates"
---

<objective>
Initialize Supabase project and create all core database tables for the warehouse pickup queue system.

Purpose: Establish the foundational data structures that all queue operations depend on. Without these tables, no other functionality can be built.

Output: Supabase project configuration and 4 migration files defining the core schema (extensions, gates, pickup_requests, business_hours).
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase project</name>
  <files>supabase/config.toml</files>
  <action>
Run `npx supabase init` in the project root to create the supabase/ directory structure.

This creates:
- supabase/config.toml (project configuration)
- supabase/migrations/ directory
- supabase/seed.sql (empty, for test data)

Leave config.toml with default settings - we will configure project_id when linking to Supabase Cloud later.
  </action>
  <verify>
- `ls supabase/` shows config.toml and migrations/ directory
- `cat supabase/config.toml` shows valid TOML configuration
  </verify>
  <done>supabase/ directory exists with config.toml and migrations/ subdirectory</done>
</task>

<task type="auto">
  <name>Task 2: Create extensions and core tables migrations</name>
  <files>
supabase/migrations/20260128000000_create_extensions.sql
supabase/migrations/20260128000001_create_gates_table.sql
supabase/migrations/20260128000002_create_pickup_requests_table.sql
supabase/migrations/20260128000003_create_business_hours_table.sql
  </files>
  <action>
Create 4 migration files following the research patterns:

**20260128000000_create_extensions.sql:**
- Enable `moddatetime` extension in `extensions` schema (for automatic updated_at)
- Enable `uuid-ossp` if not already enabled (for gen_random_uuid fallback)

**20260128000001_create_gates_table.sql:**
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- gate_number: integer NOT NULL UNIQUE
- is_active: boolean NOT NULL DEFAULT true
- created_at: timestamptz NOT NULL DEFAULT now()
- updated_at: timestamptz

**20260128000002_create_pickup_requests_table.sql:**
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- sales_order_number: text NOT NULL
- customer_email: text NOT NULL
- customer_phone: text (nullable, optional)
- company_name: text (nullable, populated from NetSuite)
- item_count: integer (nullable, from NetSuite)
- po_number: text (nullable, from NetSuite)
- email_verified: boolean NOT NULL DEFAULT false
- email_flagged: boolean NOT NULL DEFAULT false
- status: text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'in_queue', 'completed', 'cancelled'))
- assigned_gate_id: uuid REFERENCES gates(id)
- queue_position: integer (nullable, only set when in_queue)
- is_priority: boolean NOT NULL DEFAULT false
- created_at: timestamptz NOT NULL DEFAULT now()
- updated_at: timestamptz
- completed_at: timestamptz
- CONSTRAINT unique_queue_position UNIQUE (assigned_gate_id, queue_position)
- Indexes: status, assigned_gate_id, composite (gate_id, queue_position) WHERE status='in_queue'

**20260128000003_create_business_hours_table.sql:**
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- day_of_week: integer NOT NULL CHECK (day_of_week BETWEEN 0 AND 6)
- open_time: time NOT NULL
- close_time: time NOT NULL
- is_closed: boolean NOT NULL DEFAULT false
- created_at: timestamptz NOT NULL DEFAULT now()
- updated_at: timestamptz
- CONSTRAINT unique_day UNIQUE (day_of_week)
- CONSTRAINT valid_hours CHECK (open_time < close_time OR is_closed = true)

IMPORTANT: Use CHECK constraints (not ENUMs) for status field as per research. This allows easier schema evolution without table locks.
  </action>
  <verify>
- All 4 migration files exist in supabase/migrations/
- Files are in timestamp order (000000, 000001, 000002, 000003)
- pickup_requests has CHECK constraint for status, not ENUM
- pickup_requests has foreign key to gates
- All tables have created_at and updated_at columns
  </verify>
  <done>
Four migration files created:
- Extensions enabled (moddatetime)
- Gates table with gate_number and is_active
- Pickup_requests table with all fields, status CHECK constraint, and gate foreign key
- Business_hours table with day_of_week validation
  </done>
</task>

</tasks>

<verification>
1. `ls -la supabase/migrations/` shows 4 SQL files in correct order
2. `grep -l "CREATE TABLE" supabase/migrations/*.sql` returns 3 files (gates, pickup_requests, business_hours)
3. `grep "CHECK.*status" supabase/migrations/*pickup*.sql` confirms CHECK constraint usage
4. `grep "REFERENCES gates" supabase/migrations/*pickup*.sql` confirms foreign key
5. All tables have `created_at timestamptz` and `updated_at timestamptz` columns
</verification>

<success_criteria>
- Supabase project initialized with valid config.toml
- 4 migration files created in correct timestamp order
- Gates table supports active/inactive state
- Pickup_requests table has all required fields including NetSuite cache fields
- Pickup_requests status uses CHECK constraint with all 5 states
- Business_hours table supports weekly schedule configuration
- All foreign keys are properly defined
- All tables have timestamp columns for audit
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-01-SUMMARY.md`
</output>
