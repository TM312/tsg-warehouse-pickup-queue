---
phase: 08-real-time-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260130100000_enable_realtime_pickup_requests.sql
  - staff/app/composables/useRealtimeQueue.ts
  - staff/app/components/ConnectionStatus.vue
autonomous: true

must_haves:
  truths:
    - "pickup_requests table broadcasts INSERT/UPDATE/DELETE events to subscribers"
    - "Staff dashboard can subscribe to all pickup_requests changes"
    - "Staff sees connection status when WebSocket disconnects"
    - "Channel cleanup occurs on component unmount"
  artifacts:
    - path: "supabase/migrations/20260130100000_enable_realtime_pickup_requests.sql"
      provides: "Realtime publication for pickup_requests"
      contains: "ALTER PUBLICATION supabase_realtime ADD TABLE pickup_requests"
    - path: "staff/app/composables/useRealtimeQueue.ts"
      provides: "Staff realtime subscription composable"
      exports: ["useRealtimeQueue"]
    - path: "staff/app/components/ConnectionStatus.vue"
      provides: "Visual feedback for connection state"
  key_links:
    - from: "staff/app/composables/useRealtimeQueue.ts"
      to: "useSupabaseClient"
      via: "Nuxt Supabase module"
      pattern: "useSupabaseClient\\(\\)"
    - from: "staff/app/composables/useRealtimeQueue.ts"
      to: "pickup_requests table"
      via: "postgres_changes subscription"
      pattern: "table:\\s*['\"]pickup_requests['\"]"
---

<objective>
Enable Supabase Realtime for pickup_requests and create staff dashboard subscription composable.

Purpose: This is the foundational infrastructure for real-time updates. Without the publication, no realtime events are broadcast. The staff composable enables the dashboard to receive live updates when any request changes.

Output: Migration file enabling realtime, useRealtimeQueue composable with connection state handling, and ConnectionStatus UI component.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-infrastructure/08-RESEARCH.md
@staff/app/composables/useQueueActions.ts
@supabase/config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration to enable realtime for pickup_requests</name>
  <files>supabase/migrations/20260130100000_enable_realtime_pickup_requests.sql</files>
  <action>
Create a SQL migration that adds the pickup_requests table to the supabase_realtime publication.

The migration should contain:
```sql
-- Enable realtime for pickup_requests table
-- This allows INSERT, UPDATE, DELETE events to be broadcast to subscribed clients
ALTER PUBLICATION supabase_realtime ADD TABLE pickup_requests;
```

Note: supabase/config.toml already has `[realtime] enabled = true`, so we only need to add the table to the publication.
  </action>
  <verify>
Run `supabase db reset` and check for errors. The migration should apply cleanly.
Verify with: `supabase db query "SELECT tablename FROM pg_publication_tables WHERE pubname = 'supabase_realtime';"` - should include pickup_requests.
  </verify>
  <done>Migration file exists and pickup_requests is in supabase_realtime publication after reset.</done>
</task>

<task type="auto">
  <name>Task 2: Create useRealtimeQueue composable for staff dashboard</name>
  <files>staff/app/composables/useRealtimeQueue.ts</files>
  <action>
Create a composable that handles realtime subscription to all pickup_requests changes.

Requirements:
1. Use `useSupabaseClient()` from @nuxtjs/supabase
2. Track connection status: 'connecting' | 'connected' | 'disconnected' | 'error'
3. Subscribe in `onMounted`, unsubscribe in `onUnmounted`
4. Channel name: 'pickup-requests-staff' (human-readable for debugging)
5. Listen for all events (INSERT, UPDATE, DELETE) on pickup_requests table
6. Accept an `onEvent` callback that caller uses to trigger data refresh
7. Include visibility-based reconnection using `useDocumentVisibility` from @vueuse/core
8. Return `{ status, subscribe, unsubscribe }` where status is a readonly ref

Implementation pattern from research:
```typescript
import type { RealtimeChannel } from '@supabase/supabase-js'
import { useDocumentVisibility } from '@vueuse/core'

export type SubscriptionStatus = 'connecting' | 'connected' | 'disconnected' | 'error'

export function useRealtimeQueue() {
  const client = useSupabaseClient()
  const visibility = useDocumentVisibility()

  const status = ref<SubscriptionStatus>('connecting')
  let channel: RealtimeChannel | null = null
  let eventCallback: (() => void) | null = null

  const subscribe = (onEvent: () => void) => {
    eventCallback = onEvent
    channel = client
      .channel('pickup-requests-staff')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'pickup_requests' },
        () => onEvent()
      )
      .subscribe((subscribeStatus) => {
        if (subscribeStatus === 'SUBSCRIBED') {
          status.value = 'connected'
        } else if (subscribeStatus === 'CLOSED' || subscribeStatus === 'TIMED_OUT') {
          status.value = 'disconnected'
        } else if (subscribeStatus === 'CHANNEL_ERROR') {
          status.value = 'error'
        }
      })
  }

  const unsubscribe = () => {
    if (channel) {
      client.removeChannel(channel)
      channel = null
    }
  }

  // Auto-reconnect and refresh on tab visibility change
  watch(visibility, async (current, previous) => {
    if (current === 'visible' && previous === 'hidden') {
      // Refresh data regardless of connection status (may have missed events)
      eventCallback?.()
      // Reconnect if needed
      if (status.value !== 'connected' && eventCallback) {
        unsubscribe()
        subscribe(eventCallback)
      }
    }
  })

  return {
    status: readonly(status),
    subscribe,
    unsubscribe
  }
}
```

Key points:
- Do NOT subscribe during setup() - only in onMounted (SSR safety)
- Always cleanup with removeChannel in onUnmounted
- Full data refresh on visibility change (events during hidden are lost)
  </action>
  <verify>
TypeScript compilation: `cd staff && pnpm typecheck` passes without errors related to useRealtimeQueue.
  </verify>
  <done>Composable exports useRealtimeQueue with status ref, subscribe(), and unsubscribe() functions.</done>
</task>

<task type="auto">
  <name>Task 3: Create ConnectionStatus component for staff dashboard</name>
  <files>staff/app/components/ConnectionStatus.vue</files>
  <action>
Create a Vue component that displays connection status when not connected.

Requirements:
1. Accept `status` prop of type SubscriptionStatus
2. Only show when status !== 'connected' (hidden when working normally)
3. Fixed position bottom-right corner
4. Visual styles:
   - connecting: yellow background (bg-yellow-100 text-yellow-800)
   - disconnected: red background (bg-red-100 text-red-800)
   - error: red background (bg-red-100 text-red-800)
5. Messages:
   - connecting: "Connecting..."
   - disconnected: "Reconnecting..."
   - error: "Connection lost. Retrying..."

Implementation:
```vue
<template>
  <div
    v-if="status !== 'connected'"
    class="fixed bottom-4 right-4 px-4 py-2 rounded-lg text-sm font-medium shadow-lg z-50"
    :class="{
      'bg-yellow-100 text-yellow-800': status === 'connecting',
      'bg-red-100 text-red-800': status === 'disconnected' || status === 'error'
    }"
  >
    <span v-if="status === 'connecting'">Connecting...</span>
    <span v-else-if="status === 'disconnected'">Reconnecting...</span>
    <span v-else-if="status === 'error'">Connection lost. Retrying...</span>
  </div>
</template>

<script setup lang="ts">
import type { SubscriptionStatus } from '~/composables/useRealtimeQueue'

defineProps<{
  status: SubscriptionStatus
}>()
</script>
```

Note: Import the SubscriptionStatus type from the composable for type safety.
  </action>
  <verify>
Component renders correctly with different status values. Manual test: import in a page, pass different status values, observe correct styling.
  </verify>
  <done>ConnectionStatus.vue exists, accepts status prop, shows appropriate message/styling for each state.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Database verification:
   ```bash
   supabase db reset
   supabase db query "SELECT tablename FROM pg_publication_tables WHERE pubname = 'supabase_realtime';"
   ```
   Expected: pickup_requests in results

2. TypeScript verification:
   ```bash
   cd staff && pnpm typecheck
   ```
   Expected: No errors

3. Files exist:
   - supabase/migrations/20260130100000_enable_realtime_pickup_requests.sql
   - staff/app/composables/useRealtimeQueue.ts
   - staff/app/components/ConnectionStatus.vue
</verification>

<success_criteria>
1. Migration adds pickup_requests to supabase_realtime publication
2. useRealtimeQueue composable provides status, subscribe, unsubscribe
3. ConnectionStatus component shows visual feedback for non-connected states
4. All files pass TypeScript compilation
5. No runtime errors during migration apply
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-infrastructure/08-01-SUMMARY.md`
</output>
