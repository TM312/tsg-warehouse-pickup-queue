---
phase: 02-netsuite-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/main.tf
  - infra/variables.tf
  - infra/outputs.tf
  - infra/lambda.tf
  - infra/api_gateway.tf
  - infra/api_key.tf
autonomous: true

must_haves:
  truths:
    - "OpenTofu can initialize without errors"
    - "All NetSuite credential variables are defined as sensitive"
    - "Supabase URL and service role key variables are defined for caching"
    - "Lambda function resource is configured with Python 3.12 runtime"
    - "API Gateway REST API is configured with API key requirement"
  artifacts:
    - path: "infra/main.tf"
      provides: "Provider configuration and OpenTofu settings"
      contains: "required_providers"
    - path: "infra/variables.tf"
      provides: "Input variables for credentials and configuration"
      contains: "netsuite_account_id"
    - path: "infra/variables.tf"
      provides: "Supabase variables for caching"
      contains: "supabase_url"
    - path: "infra/lambda.tf"
      provides: "Lambda function and IAM role resources"
      contains: "aws_lambda_function"
    - path: "infra/api_gateway.tf"
      provides: "REST API with POST /validate-order endpoint"
      contains: "aws_api_gateway_rest_api"
    - path: "infra/api_key.tf"
      provides: "API key and usage plan for frontend authentication"
      contains: "aws_api_gateway_api_key"
    - path: "infra/outputs.tf"
      provides: "Exposed values for integration"
      contains: "api_endpoint"
  key_links:
    - from: "infra/lambda.tf"
      to: "infra/variables.tf"
      via: "var.netsuite_* and var.supabase_* references"
      pattern: "var\\.(netsuite_|supabase_)"
    - from: "infra/api_gateway.tf"
      to: "infra/lambda.tf"
      via: "Lambda proxy integration"
      pattern: "aws_lambda_function\\.netsuite"
---

<objective>
Create OpenTofu infrastructure configuration for AWS Lambda and API Gateway.

Purpose: Establish the AWS infrastructure foundation that hosts the NetSuite integration Lambda function with secure API key authentication and Supabase connectivity for order caching.

Output: Complete OpenTofu configuration files ready for deployment in `infra/` directory.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-netsuite-integration/02-CONTEXT.md
@.planning/phases/02-netsuite-integration/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenTofu provider and variables configuration</name>
  <files>infra/main.tf, infra/variables.tf</files>
  <action>
Create the foundation OpenTofu files:

**infra/main.tf:**
- Required providers block with `hashicorp/aws` ~> 5.0 and `hashicorp/archive` ~> 2.0
- AWS provider configuration using `var.aws_region` (default us-east-1)
- Backend configuration (local state for now - can migrate to S3 later)

**infra/variables.tf:**
- `aws_region` (string, default "us-east-1")
- `environment` (string, default "production")
- NetSuite credentials (all sensitive, no defaults - REQUIRED):
  - `netsuite_account_id` (string, sensitive)
  - `netsuite_consumer_key` (string, sensitive)
  - `netsuite_consumer_secret` (string, sensitive)
  - `netsuite_token_id` (string, sensitive)
  - `netsuite_token_secret` (string, sensitive)
- Supabase credentials for caching (sensitive, no defaults - REQUIRED):
  - `supabase_url` (string, sensitive, description: "Supabase project URL for order caching")
  - `supabase_service_role_key` (string, sensitive, description: "Supabase service role key - bypasses RLS for cache operations")
- `allowed_origins` (string, default "*" - will be restricted in production)

All credential variables must be marked `sensitive = true` to prevent logging.
Do NOT provide default values for credentials - they must be provided via tfvars or environment.
  </action>
  <verify>
Run `cd infra && tofu init` - should succeed with no errors
Run `tofu validate` - should show "Success! The configuration is valid"
Verify variables.tf contains both netsuite_* and supabase_* variables
  </verify>
  <done>
OpenTofu initializes successfully and validates with all variables defined including Supabase credentials.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Lambda and API Gateway resources</name>
  <files>infra/lambda.tf, infra/api_gateway.tf, infra/api_key.tf, infra/outputs.tf</files>
  <action>
Create the AWS resources for Lambda + API Gateway integration:

**infra/lambda.tf:**
- IAM role `aws_iam_role.lambda_exec` with assume role policy for lambda.amazonaws.com
- IAM role policy attachment for AWSLambdaBasicExecutionRole (CloudWatch logs)
- Lambda layer `aws_lambda_layer_version.dependencies` for Python packages
  - Layer built from `lambda/layer/python.zip` (created by build script)
  - Compatible runtimes: python3.12
- Lambda function `aws_lambda_function.netsuite_integration`:
  - function_name: "warehouse-netsuite-${var.environment}"
  - handler: "handler.lambda_handler"
  - runtime: "python3.12"
  - timeout: 30 seconds
  - memory_size: 256 MB
  - Source from `data.archive_file.lambda_code` (archives lambda/ directory)
  - Attach the dependencies layer
  - Environment variables:
    - All 5 NetSuite credentials from variables
    - SUPABASE_URL from var.supabase_url
    - SUPABASE_SERVICE_ROLE_KEY from var.supabase_service_role_key
    - ALLOWED_ORIGINS from var.allowed_origins

**infra/api_gateway.tf:**
- REST API `aws_api_gateway_rest_api.main`:
  - name: "warehouse-netsuite-api-${var.environment}"
  - api_key_source: "HEADER"
- Resource `aws_api_gateway_resource.validate_order` for path "/validate-order"
- Method `aws_api_gateway_method.validate_order_post` for POST:
  - authorization: "NONE"
  - api_key_required: true
- Method `aws_api_gateway_method.validate_order_options` for OPTIONS (CORS preflight):
  - authorization: "NONE"
  - api_key_required: false
- Lambda integration `aws_api_gateway_integration.lambda`:
  - type: "AWS_PROXY"
  - integration_http_method: "POST"
  - uri: Lambda invoke ARN
- Mock integration for OPTIONS with CORS headers
- Method responses and integration responses for both POST and OPTIONS
- Deployment `aws_api_gateway_deployment.main` with depends_on for methods
- Stage `aws_api_gateway_stage.prod` with stage_name "prod"
- Lambda permission `aws_lambda_permission.api_gateway` allowing API Gateway to invoke Lambda

**infra/api_key.tf:**
- API key `aws_api_gateway_api_key.frontend`:
  - name: "warehouse-frontend-key-${var.environment}"
  - enabled: true
- Usage plan `aws_api_gateway_usage_plan.main`:
  - name: "warehouse-usage-plan-${var.environment}"
  - api_stages referencing the prod stage
  - throttle_settings: rate_limit 100, burst_limit 200
- Usage plan key `aws_api_gateway_usage_plan_key.main`:
  - key_id from the API key
  - key_type: "API_KEY"
  - usage_plan_id from usage plan
  - CRITICAL: deployment must depend_on this resource to avoid API key bypass bug

**infra/outputs.tf:**
- `api_endpoint` - Full URL to POST /validate-order
- `api_key_id` - API key ID (for retrieval via AWS CLI)
- `api_key_value` - API key value (marked sensitive)
- `lambda_function_name` - For logs/debugging

**Important considerations:**
- Add explicit depends_on from api_gateway_deployment to usage_plan_key (Pitfall 3 from research)
- CORS headers must be returned by Lambda too, not just API Gateway mock
- Use data.archive_file for Lambda code packaging
- Lambda environment must include SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY for caching
  </action>
  <verify>
Run `tofu validate` - should succeed
Run `tofu plan` - should show ~15-20 resources to create (no errors)
Verify lambda.tf references all 5 netsuite_* variables AND both supabase_* variables
Verify api_gateway.tf has depends_on chain to usage_plan_key
  </verify>
  <done>
All OpenTofu files are syntactically valid and plan shows expected resources.
Lambda function configured with Python 3.12, 30s timeout, 256MB memory.
Lambda environment includes both NetSuite and Supabase credentials.
API Gateway configured with POST /validate-order requiring API key.
Deployment dependency chain prevents API key bypass.
  </done>
</task>

</tasks>

<verification>
1. `cd infra && tofu init` completes without errors
2. `tofu validate` returns success
3. `tofu plan` shows planned resources without errors (will fail on apply until Lambda code exists)
4. Lambda environment variables include SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY
5. All files follow research patterns (SuiteQL, async handler, CORS headers)
</verification>

<success_criteria>
- infra/main.tf exists with AWS provider configuration
- infra/variables.tf defines all required variables including Supabase credentials
- infra/lambda.tf defines Lambda function with Python 3.12, layer support, and Supabase env vars
- infra/api_gateway.tf defines REST API with /validate-order POST endpoint
- infra/api_key.tf defines API key with usage plan and proper dependency chain
- infra/outputs.tf exposes API endpoint and key values
- `tofu init && tofu validate` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-netsuite-integration/02-01-SUMMARY.md`
</output>
