---
phase: 04-staff-dashboard-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/package.json
  - staff/app/lib/utils.ts
  - staff/app/components/ui/table/Table.vue
  - staff/app/components/ui/table/TableBody.vue
  - staff/app/components/ui/table/TableCell.vue
  - staff/app/components/ui/table/TableHead.vue
  - staff/app/components/ui/table/TableHeader.vue
  - staff/app/components/ui/table/TableRow.vue
  - staff/app/components/ui/table/index.ts
  - staff/app/components/ui/badge/Badge.vue
  - staff/app/components/ui/badge/index.ts
  - staff/app/components/dashboard/DataTable.vue
  - staff/app/components/dashboard/columns.ts
  - staff/app/components/dashboard/StatusBadge.vue
  - staff/app/pages/index.vue
autonomous: true

must_haves:
  truths:
    - "Staff sees table of all pickup requests with order number, company, status, gate columns"
    - "Pending requests are visually distinct (destructive badge variant)"
    - "Email-mismatched requests show a flag icon"
    - "Staff can click refresh button to reload data"
    - "Empty state shows 'No pickup requests' message"
  artifacts:
    - path: "staff/app/components/ui/table/Table.vue"
      provides: "shadcn-vue Table component"
    - path: "staff/app/components/ui/badge/Badge.vue"
      provides: "shadcn-vue Badge component"
    - path: "staff/app/components/dashboard/DataTable.vue"
      provides: "Generic TanStack Table wrapper with sorting"
      min_lines: 50
    - path: "staff/app/components/dashboard/columns.ts"
      provides: "Column definitions for pickup requests"
      exports: ["columns"]
    - path: "staff/app/components/dashboard/StatusBadge.vue"
      provides: "Status indicator with variant mapping"
    - path: "staff/app/pages/index.vue"
      provides: "Dashboard page with data table"
      min_lines: 40
  key_links:
    - from: "staff/app/pages/index.vue"
      to: "useSupabaseClient"
      via: "useAsyncData fetch"
      pattern: "useAsyncData.*pickup-requests"
    - from: "staff/app/pages/index.vue"
      to: "staff/app/components/dashboard/DataTable.vue"
      via: "component import"
      pattern: "DataTable.*:data.*:columns"
    - from: "staff/app/components/dashboard/DataTable.vue"
      to: "@tanstack/vue-table"
      via: "useVueTable"
      pattern: "useVueTable"
    - from: "staff/app/components/dashboard/columns.ts"
      to: "staff/app/components/dashboard/StatusBadge.vue"
      via: "h() render function"
      pattern: "h\\(StatusBadge"
---

<objective>
Build the staff dashboard data table showing all pickup requests with visual indicators for items needing attention.

Purpose: Staff need to see all pickup requests at a glance and quickly identify which ones need action (pending status or email-flagged). This is the core view that all queue management operations will build upon.

Output:
- TanStack Table integration with shadcn-vue components
- DataTable component with sorting capability
- Column definitions for pickup requests
- StatusBadge component for consistent status display
- Dashboard page with data fetching and refresh
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-staff-dashboard-core/04-RESEARCH.md
@staff/app/lib/utils.ts
@staff/app/pages/index.vue
@staff/nuxt.config.ts
@supabase/migrations/20260128000002_create_pickup_requests_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TanStack Table and add shadcn-vue components</name>
  <files>
    staff/package.json
    staff/app/lib/utils.ts
    staff/app/components/ui/table/Table.vue
    staff/app/components/ui/table/TableBody.vue
    staff/app/components/ui/table/TableCell.vue
    staff/app/components/ui/table/TableHead.vue
    staff/app/components/ui/table/TableHeader.vue
    staff/app/components/ui/table/TableRow.vue
    staff/app/components/ui/table/index.ts
    staff/app/components/ui/badge/Badge.vue
    staff/app/components/ui/badge/index.ts
  </files>
  <action>
    1. Install @tanstack/vue-table:
       ```bash
       cd staff && pnpm add @tanstack/vue-table
       ```

    2. Add shadcn-vue Table and Badge components:
       ```bash
       cd staff && pnpm dlx shadcn-vue@latest add table badge
       ```
       When prompted, accept defaults.

    3. Add valueUpdater function to lib/utils.ts (CRITICAL - required for TanStack Table state management):
       ```typescript
       import type { Updater } from '@tanstack/vue-table'
       import type { Ref } from 'vue'

       export function valueUpdater<T extends Updater<any>>(updaterOrValue: T, ref: Ref) {
         ref.value = typeof updaterOrValue === 'function'
           ? updaterOrValue(ref.value)
           : updaterOrValue
       }
       ```
       Add this function AFTER the existing cn() function. Keep both imports and functions.
  </action>
  <verify>
    - `grep -q "tanstack/vue-table" staff/package.json` returns 0
    - `ls staff/app/components/ui/table/Table.vue` exists
    - `ls staff/app/components/ui/badge/Badge.vue` exists
    - `grep -q "valueUpdater" staff/app/lib/utils.ts` returns 0
  </verify>
  <done>
    - @tanstack/vue-table installed in package.json
    - Table component directory exists with Table, TableBody, TableCell, TableHead, TableHeader, TableRow
    - Badge component directory exists with Badge
    - valueUpdater function added to lib/utils.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DataTable component, column definitions, and StatusBadge</name>
  <files>
    staff/app/components/dashboard/DataTable.vue
    staff/app/components/dashboard/columns.ts
    staff/app/components/dashboard/StatusBadge.vue
  </files>
  <action>
    1. Create staff/app/components/dashboard/ directory

    2. Create StatusBadge.vue - reusable status indicator:
       ```vue
       <script setup lang="ts">
       import { Badge } from '@/components/ui/badge'

       const props = defineProps<{
         status: 'pending' | 'approved' | 'in_queue' | 'completed' | 'cancelled'
       }>()

       const variantMap: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {
         pending: 'destructive',
         approved: 'default',
         in_queue: 'default',
         completed: 'secondary',
         cancelled: 'outline',
       }

       const labelMap: Record<string, string> = {
         pending: 'Pending',
         approved: 'Approved',
         in_queue: 'In Queue',
         completed: 'Completed',
         cancelled: 'Cancelled',
       }
       </script>

       <template>
         <Badge :variant="variantMap[status]">
           {{ labelMap[status] }}
         </Badge>
       </template>
       ```

    3. Create columns.ts - column definitions for pickup requests:
       ```typescript
       import type { ColumnDef } from '@tanstack/vue-table'
       import { h } from 'vue'
       import { ArrowUpDown, Flag } from 'lucide-vue-next'
       import { Button } from '@/components/ui/button'
       import StatusBadge from './StatusBadge.vue'

       export interface PickupRequest {
         id: string
         sales_order_number: string
         company_name: string | null
         customer_email: string
         status: 'pending' | 'approved' | 'in_queue' | 'completed' | 'cancelled'
         email_flagged: boolean
         assigned_gate_id: string | null
         queue_position: number | null
         created_at: string
       }

       export const columns: ColumnDef<PickupRequest>[] = [
         {
           accessorKey: 'sales_order_number',
           header: ({ column }) => {
             return h(Button, {
               variant: 'ghost',
               onClick: () => column.toggleSorting(column.getIsSorted() === 'asc'),
             }, () => ['Order #', h(ArrowUpDown, { class: 'ml-2 h-4 w-4' })])
           },
         },
         {
           accessorKey: 'company_name',
           header: 'Company',
           cell: ({ row }) => row.getValue('company_name') || 'N/A',
         },
         {
           accessorKey: 'status',
           header: 'Status',
           cell: ({ row }) => {
             const status = row.getValue('status') as PickupRequest['status']
             return h(StatusBadge, { status })
           },
         },
         {
           accessorKey: 'email_flagged',
           header: 'Flag',
           cell: ({ row }) => {
             if (row.getValue('email_flagged')) {
               return h(Flag, { class: 'h-4 w-4 text-destructive' })
             }
             return null
           },
         },
         {
           id: 'gate',
           header: 'Gate',
           cell: ({ row }) => {
             // Gate info will be joined in query; for now show position if in queue
             const position = row.original.queue_position
             if (position !== null) {
               return `#${position}`
             }
             return '-'
           },
         },
         {
           accessorKey: 'created_at',
           header: ({ column }) => {
             return h(Button, {
               variant: 'ghost',
               onClick: () => column.toggleSorting(column.getIsSorted() === 'asc'),
             }, () => ['Created', h(ArrowUpDown, { class: 'ml-2 h-4 w-4' })])
           },
           cell: ({ row }) => {
             const date = new Date(row.getValue('created_at'))
             return date.toLocaleString()
           },
         },
       ]
       ```

    4. Create DataTable.vue - generic table wrapper with TanStack Table:
       ```vue
       <script setup lang="ts" generic="TData, TValue">
       import type { ColumnDef, SortingState } from '@tanstack/vue-table'
       import {
         FlexRender,
         getCoreRowModel,
         getSortedRowModel,
         useVueTable,
       } from '@tanstack/vue-table'
       import { ref } from 'vue'
       import { valueUpdater } from '@/lib/utils'
       import {
         Table,
         TableBody,
         TableCell,
         TableHead,
         TableHeader,
         TableRow,
       } from '@/components/ui/table'

       const props = defineProps<{
         columns: ColumnDef<TData, TValue>[]
         data: TData[]
       }>()

       const sorting = ref<SortingState>([])

       const table = useVueTable({
         get data() { return props.data },
         get columns() { return props.columns },
         getCoreRowModel: getCoreRowModel(),
         getSortedRowModel: getSortedRowModel(),
         onSortingChange: updaterOrValue => valueUpdater(updaterOrValue, sorting),
         state: {
           get sorting() { return sorting.value },
         },
       })
       </script>

       <template>
         <div class="rounded-md border">
           <Table>
             <TableHeader>
               <TableRow v-for="headerGroup in table.getHeaderGroups()" :key="headerGroup.id">
                 <TableHead v-for="header in headerGroup.headers" :key="header.id">
                   <FlexRender
                     v-if="!header.isPlaceholder"
                     :render="header.column.columnDef.header"
                     :props="header.getContext()"
                   />
                 </TableHead>
               </TableRow>
             </TableHeader>
             <TableBody>
               <template v-if="table.getRowModel().rows?.length">
                 <TableRow
                   v-for="row in table.getRowModel().rows"
                   :key="row.id"
                   :class="{
                     'bg-destructive/10': row.original.status === 'pending' || row.original.email_flagged,
                   }"
                 >
                   <TableCell v-for="cell in row.getVisibleCells()" :key="cell.id">
                     <FlexRender
                       :render="cell.column.columnDef.cell"
                       :props="cell.getContext()"
                     />
                   </TableCell>
                 </TableRow>
               </template>
               <TableRow v-else>
                 <TableCell :colspan="columns.length" class="h-24 text-center">
                   No pickup requests.
                 </TableCell>
               </TableRow>
             </TableBody>
           </Table>
         </div>
       </template>
       ```

    Note: The conditional row styling (`bg-destructive/10`) highlights rows needing attention (pending OR email_flagged). This satisfies STAFF-03 requirement.
  </action>
  <verify>
    - `ls staff/app/components/dashboard/DataTable.vue` exists
    - `ls staff/app/components/dashboard/columns.ts` exists
    - `ls staff/app/components/dashboard/StatusBadge.vue` exists
    - `grep -q "useVueTable" staff/app/components/dashboard/DataTable.vue` returns 0
    - `grep -q "export const columns" staff/app/components/dashboard/columns.ts` returns 0
  </verify>
  <done>
    - DataTable.vue created with TanStack Table integration and sorting
    - columns.ts exports PickupRequest interface and column definitions
    - StatusBadge.vue provides consistent status display with variant mapping
    - Row highlighting implemented for pending/flagged requests
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire dashboard page with Supabase data fetching</name>
  <files>
    staff/app/pages/index.vue
  </files>
  <action>
    Replace the existing placeholder dashboard page with a full implementation:

    ```vue
    <script setup lang="ts">
    import { RefreshCw } from 'lucide-vue-next'
    import DataTable from '@/components/dashboard/DataTable.vue'
    import { columns, type PickupRequest } from '@/components/dashboard/columns'

    definePageMeta({
      middleware: 'auth'
    })

    const client = useSupabaseClient()

    const { data: requests, refresh, status } = await useAsyncData<PickupRequest[]>(
      'pickup-requests-list',
      async () => {
        const { data, error } = await client
          .from('pickup_requests')
          .select('id, sales_order_number, company_name, customer_email, status, email_flagged, assigned_gate_id, queue_position, created_at')
          .order('created_at', { ascending: false })

        if (error) throw error
        return data as PickupRequest[]
      }
    )

    const pending = computed(() => status.value === 'pending')
    </script>

    <template>
      <div>
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">Pickup Queue</h1>
          <Button variant="outline" size="sm" :disabled="pending" @click="refresh()">
            <RefreshCw :class="['h-4 w-4 mr-2', { 'animate-spin': pending }]" />
            Refresh
          </Button>
        </div>

        <DataTable
          :columns="columns"
          :data="requests ?? []"
        />
      </div>
    </template>
    ```

    Key implementation notes:
    - useAsyncData key 'pickup-requests-list' is unique to avoid cache collisions
    - Fetches all pickup_requests ordered by created_at descending (newest first)
    - Refresh button shows spinning icon while loading
    - Passes empty array if requests is null (during initial load)
    - Page protected by auth middleware (already defined)
  </action>
  <verify>
    1. Start local Supabase if not running: `supabase start`
    2. Start dev server: `cd staff && pnpm dev`
    3. Navigate to http://localhost:3000 (login if needed)
    4. Dashboard should show "Pickup Queue" header with Refresh button
    5. Table should show "No pickup requests." (empty state)
    6. No console errors related to data fetching or component rendering
  </verify>
  <done>
    - Dashboard page fetches pickup requests from Supabase
    - DataTable renders with column definitions
    - Refresh button reloads data with visual feedback
    - Empty state displays when no requests exist
    - Page is protected by auth middleware
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Component structure:**
   ```bash
   ls staff/app/components/ui/table/
   # Should show: Table.vue, TableBody.vue, TableCell.vue, TableHead.vue, TableHeader.vue, TableRow.vue, index.ts

   ls staff/app/components/ui/badge/
   # Should show: Badge.vue, index.ts

   ls staff/app/components/dashboard/
   # Should show: DataTable.vue, columns.ts, StatusBadge.vue
   ```

2. **Dependencies installed:**
   ```bash
   grep "@tanstack/vue-table" staff/package.json
   # Should show the dependency
   ```

3. **Manual verification:**
   - Start local Supabase: `supabase start`
   - Start dev server: `cd staff && pnpm dev`
   - Login at http://localhost:3000/login (staff@example.com / password123)
   - Dashboard shows table with columns: Order #, Company, Status, Flag, Gate, Created
   - Refresh button works (spins while loading)
   - Empty state shows "No pickup requests."

4. **Optional - test with seed data:**
   ```sql
   -- Run in Supabase Studio SQL editor (http://127.0.0.1:54323)
   INSERT INTO pickup_requests (sales_order_number, customer_email, company_name, status, email_flagged)
   VALUES
     ('SO-001', 'test@example.com', 'Test Company', 'pending', false),
     ('SO-002', 'flagged@wrong.com', 'Another Corp', 'pending', true),
     ('SO-003', 'approved@example.com', 'Good Inc', 'approved', false);
   ```
   After inserting, click Refresh - table should show 3 rows with:
   - Pending rows highlighted with light red background
   - Flagged row shows Flag icon
   - Status badges with appropriate colors
</verification>

<success_criteria>
- [ ] @tanstack/vue-table installed in staff/package.json
- [ ] shadcn-vue Table component added to staff/app/components/ui/table/
- [ ] shadcn-vue Badge component added to staff/app/components/ui/badge/
- [ ] valueUpdater function added to staff/app/lib/utils.ts
- [ ] DataTable.vue renders TanStack Table with sorting support
- [ ] columns.ts defines pickup request columns with proper types
- [ ] StatusBadge.vue maps status to badge variants
- [ ] Dashboard page fetches data from Supabase pickup_requests table
- [ ] Refresh button reloads data with spinner animation
- [ ] Empty state displays "No pickup requests."
- [ ] Pending/flagged rows have visual highlight (bg-destructive/10)
- [ ] No TypeScript or runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-staff-dashboard-core/04-01-SUMMARY.md`
</output>
