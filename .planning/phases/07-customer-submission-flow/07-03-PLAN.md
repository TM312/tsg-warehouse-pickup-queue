---
phase: 07-customer-submission-flow
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - customer/server/api/business-hours.get.ts
  - customer/server/api/submit.post.ts
  - customer/server/utils/validateOrder.ts
  - customer/app/composables/useBusinessHours.ts
  - customer/app/components/PickupRequestForm.vue
  - customer/app/components/ClosedMessage.vue
  - customer/app/pages/index.vue
autonomous: true

must_haves:
  truths:
    - "Customer sees closed message when warehouse is not open"
    - "Customer can submit pickup request during open hours"
    - "Invalid sales order shows error message"
    - "Repeated failed attempts are rate-limited"
    - "Valid submission creates pickup request in database"
  artifacts:
    - path: "customer/server/api/business-hours.get.ts"
      provides: "Business hours check endpoint"
      exports: ["default"]
    - path: "customer/server/api/submit.post.ts"
      provides: "Pickup request submission endpoint"
      exports: ["default"]
    - path: "customer/app/composables/useBusinessHours.ts"
      provides: "Business hours reactive state"
      exports: ["useBusinessHours"]
    - path: "customer/app/components/PickupRequestForm.vue"
      provides: "Submission form with validation"
      min_lines: 50
  key_links:
    - from: "customer/app/pages/index.vue"
      to: "useBusinessHours"
      via: "composable import"
      pattern: "useBusinessHours"
    - from: "customer/app/components/PickupRequestForm.vue"
      to: "/api/submit"
      via: "useFetch POST"
      pattern: "useFetch.*api/submit"
    - from: "customer/server/api/submit.post.ts"
      to: "pickup_requests"
      via: "Supabase insert"
      pattern: "from.*pickup_requests.*insert"
---

<objective>
Implement the complete customer submission flow including business hours checking, form with validation, and rate-limited submission.

Purpose: Enable customers to submit pickup requests via mobile device after scanning QR code. The flow checks business hours, validates input, verifies the order against NetSuite (via Lambda or cache), and creates the pickup request.

Output: Working submission flow with business hours gate, validated form, rate-limited server endpoint, and database insert.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-customer-submission-flow/07-RESEARCH.md
@.planning/phases/07-customer-submission-flow/07-01-SUMMARY.md
@.planning/phases/07-customer-submission-flow/07-02-SUMMARY.md

# Reference for form patterns
@staff/app/pages/login.vue

# Database schema for insert
@supabase/migrations/20260128000002_create_pickup_requests_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create business hours server route and composable</name>
  <files>
    customer/server/api/business-hours.get.ts
    customer/app/composables/useBusinessHours.ts
  </files>
  <action>
1. Create `customer/server/api/business-hours.get.ts`:
   - Use serverSupabaseClient to query business_hours table
   - Get current time in warehouse timezone using TZDate from @date-fns/tz
   - Hardcode 'America/Los_Angeles' timezone (per research recommendation)
   - Find today's hours using getDay() (0=Sunday, 6=Saturday)
   - Check if current time is within open_time and close_time using date-fns isWithinInterval
   - Return { isOpen: boolean, message: string | null, openTime?: string, closeTime?: string }
   - Handle is_closed flag for days warehouse doesn't operate

```typescript
// Pattern from research
import { format, getDay, parse, isWithinInterval } from 'date-fns'
import { TZDate } from '@date-fns/tz'

export default defineEventHandler(async (event) => {
  const client = await serverSupabaseClient(event)
  const { data: hours } = await client.from('business_hours').select('*')

  const warehouseNow = new TZDate(new Date(), 'America/Los_Angeles')
  const dayOfWeek = getDay(warehouseNow)
  // ... (see research for full pattern)
})
```

2. Create `customer/app/composables/useBusinessHours.ts`:
   - Use useFetch to call /api/business-hours
   - Return reactive isOpen, closedMessage, isLoading, refresh
   - Handle error state gracefully (assume closed if error)
  </action>
  <verify>
    cd customer && pnpm dev &
    sleep 5
    curl http://localhost:3001/api/business-hours
    # Should return JSON with isOpen and message
  </verify>
  <done>
    /api/business-hours returns correct open/closed status based on current time and business_hours table
  </done>
</task>

<task type="auto">
  <name>Task 2: Create submission server route with order validation</name>
  <files>
    customer/server/api/submit.post.ts
    customer/server/utils/validateOrder.ts
  </files>
  <action>
1. Create `customer/server/utils/validateOrder.ts`:
   - Helper function to validate order against NetSuite Lambda
   - Read NETSUITE_VALIDATION_URL from runtime config
   - If URL not set, skip validation (dev mode) and return mock success
   - Call Lambda with sales_order_number and email
   - Return { success: boolean, order?: {...}, error?: string }
   - Handle timeout gracefully (10s timeout per research pitfall)

2. Create `customer/server/api/submit.post.ts`:
   - Parse body with Zod schema:
     - salesOrderNumber: string, min 1, max 50, regex for valid format
     - email: string, email format
     - phone: string, optional, regex for phone format
   - Check if order already has pending/approved/in_queue request (duplicate check)
   - Call validateOrder helper
   - If validation fails, return 400 with user-friendly error
   - If validation succeeds, insert into pickup_requests:
     - sales_order_number, customer_email, customer_phone
     - company_name, item_count, po_number (from validation)
     - email_flagged (true if email doesn't match NetSuite)
     - status: 'pending'
   - Return { success: true, requestId: string }

Note: nuxt-api-shield handles rate limiting automatically based on nuxt.config.ts configuration.
  </action>
  <verify>
    # Test with curl (rate limiting should kick in after 5 attempts)
    curl -X POST http://localhost:3001/api/submit \
      -H "Content-Type: application/json" \
      -d '{"salesOrderNumber":"SO-12345","email":"test@example.com"}'
    # Should return success or validation error

    # Test rate limiting
    for i in {1..6}; do
      curl -X POST http://localhost:3001/api/submit \
        -H "Content-Type: application/json" \
        -d '{"salesOrderNumber":"INVALID","email":"test@example.com"}'
    done
    # 6th request should return 429 Too Many Requests
  </verify>
  <done>
    /api/submit validates input, checks duplicates, calls order validation, creates pickup request
  </done>
</task>

<task type="auto">
  <name>Task 3: Create submission form and wire to main page</name>
  <files>
    customer/app/components/PickupRequestForm.vue
    customer/app/components/ClosedMessage.vue
    customer/app/pages/index.vue
  </files>
  <action>
1. Create `customer/app/components/ClosedMessage.vue`:
   - Simple Card component showing warehouse is closed
   - Display message from useBusinessHours (includes hours when open)
   - Mobile-friendly styling with centered text
   - Optional: Show business hours schedule

2. Create `customer/app/components/PickupRequestForm.vue`:
   - Form with vee-validate and Zod schema (matching server validation)
   - Three fields:
     - Sales Order Number (required): Input with placeholder "SO-12345", h-12 for touch
     - Email (required): Input type="email", h-12
     - Phone (optional): Input type="tel", h-12, placeholder "(555) 123-4567"
   - Submit button: Full width, h-12, disabled during loading
   - Error display for form-level errors (validation failure, rate limit)
   - Success state: Show confirmation message with order details
   - Use useFetch to POST to /api/submit

Pattern from staff/app/pages/login.vue:
```vue
<script setup lang="ts">
import { toTypedSchema } from '@vee-validate/zod'
import * as z from 'zod'
import { useForm } from 'vee-validate'

const formSchema = toTypedSchema(z.object({
  salesOrderNumber: z.string().min(1).max(50),
  email: z.string().email(),
  phone: z.string().optional()
}))

const form = useForm({ validationSchema: formSchema })
// ... (see login.vue for full pattern)
</script>
```

3. Update `customer/app/pages/index.vue`:
   - Use useBusinessHours composable
   - Show loading state while checking hours
   - If closed: show ClosedMessage component
   - If open: show PickupRequestForm component
   - After successful submission, show confirmation (no navigation needed)
  </action>
  <verify>
    cd customer && pnpm dev
    # Visit http://localhost:3001
    # If during business hours: form should display
    # Fill form and submit - should see success or error message

    # Test with dev tools mobile viewport (375x667)
    # Inputs and buttons should be touch-friendly
  </verify>
  <done>
    Customer can access form during open hours, submit request, and see confirmation or error
  </done>
</task>

</tasks>

<verification>
```bash
# Full flow verification
cd customer && pnpm dev &
sleep 5

# 1. Check business hours endpoint
curl -s http://localhost:3001/api/business-hours | jq .

# 2. Test valid submission (if business hours allow)
curl -X POST http://localhost:3001/api/submit \
  -H "Content-Type: application/json" \
  -d '{"salesOrderNumber":"SO-TEST","email":"customer@example.com","phone":"555-1234"}'

# 3. Verify request was created in database
supabase db shell << 'EOF'
SELECT id, sales_order_number, customer_email, status
FROM pickup_requests
WHERE sales_order_number = 'SO-TEST';
EOF

# 4. Test rate limiting (should block after 5 attempts in 60s)
for i in {1..6}; do
  echo "Attempt $i:"
  curl -s -w "\nHTTP Status: %{http_code}\n" \
    -X POST http://localhost:3001/api/submit \
    -H "Content-Type: application/json" \
    -d '{"salesOrderNumber":"RATE-LIMIT-TEST","email":"test@example.com"}'
done
```
</verification>

<success_criteria>
1. Business hours endpoint returns correct status based on current time
2. Submission form renders with all three fields
3. Form validation shows errors for invalid input
4. Valid submission creates pickup_request in database with status='pending'
5. Duplicate order submission is rejected
6. Rate limiting blocks after 5 failed attempts in 60 seconds
7. Closed hours shows informational message instead of form
8. Mobile viewport shows touch-friendly UI (h-12 inputs/buttons)
</success_criteria>

<output>
After completion, create `.planning/phases/07-customer-submission-flow/07-03-SUMMARY.md`
</output>
