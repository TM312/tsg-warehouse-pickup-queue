---
phase: 07-customer-submission-flow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260130000000_add_anon_insert_policy.sql
autonomous: true

must_haves:
  truths:
    - "Anonymous users can insert pickup requests with pending status"
    - "Anonymous users cannot set staff-only fields (gate, queue_position, is_priority)"
    - "Anonymous users cannot insert with non-pending status"
  artifacts:
    - path: "supabase/migrations/20260130000000_add_anon_insert_policy.sql"
      provides: "RLS policy for anonymous INSERT on pickup_requests"
      contains: "CREATE POLICY"
  key_links:
    - from: "supabase/migrations/20260130000000_add_anon_insert_policy.sql"
      to: "pickup_requests"
      via: "RLS policy FOR INSERT TO anon"
      pattern: "FOR INSERT.*TO anon"
---

<objective>
Add Row Level Security policy allowing anonymous customers to insert pickup requests.

Purpose: Enable the customer submission flow by allowing unauthenticated users to create pickup requests via the Supabase client. The policy must constrain what fields anonymous users can set to prevent privilege escalation.

Output: Database migration adding anon INSERT policy with security constraints.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-customer-submission-flow/07-RESEARCH.md

# Reference existing RLS policies
@supabase/migrations/20260128000005_create_rls_policies.sql
@supabase/migrations/20260128000002_create_pickup_requests_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create anonymous INSERT policy migration</name>
  <files>
    supabase/migrations/20260130000000_add_anon_insert_policy.sql
  </files>
  <action>
Create a new migration file that adds an INSERT policy for the `anon` role on `pickup_requests`:

```sql
-- Allow anonymous customers to submit pickup requests
-- Constrains insertable fields to prevent privilege escalation

-- Grant INSERT permission to anon role
GRANT INSERT ON pickup_requests TO anon;

-- Policy: Customers can submit pickup requests with constraints
CREATE POLICY "Customers can submit pickup requests"
  ON pickup_requests
  FOR INSERT
  TO anon
  WITH CHECK (
    -- Must be pending status (cannot skip approval process)
    status = 'pending'
    -- Cannot assign themselves to a gate
    AND assigned_gate_id IS NULL
    -- Cannot set queue position
    AND queue_position IS NULL
    -- Cannot mark as priority
    AND is_priority = false
    -- Email should not be pre-verified
    AND email_verified = false
    -- completed_at should not be set
    AND completed_at IS NULL
  );
```

The policy ensures:
1. New requests always start as 'pending' (staff must approve)
2. Staff-controlled fields (gate, queue_position, priority) cannot be manipulated
3. Verification fields cannot be bypassed

Note: The existing "Customers can view requests" SELECT policy (TO anon) already exists, which is needed for the `.insert().select()` pattern to return the created row.
  </action>
  <verify>
    # Apply migration locally
    cd /Users/thomas/Projects/tsg/warehouse-pickup-queue
    supabase db reset

    # Test anon INSERT via psql
    supabase db shell
    # Run as anon role:
    # SET ROLE anon;
    # INSERT INTO pickup_requests (sales_order_number, customer_email, status)
    #   VALUES ('SO-TEST', 'test@example.com', 'pending');
    # Should succeed

    # Test constraint violation:
    # INSERT INTO pickup_requests (sales_order_number, customer_email, status, is_priority)
    #   VALUES ('SO-TEST2', 'test@example.com', 'pending', true);
    # Should fail with RLS policy violation
  </verify>
  <done>
    Migration exists, anon can INSERT with valid fields, anon cannot INSERT with restricted fields
  </done>
</task>

</tasks>

<verification>
```bash
# Verify migration file exists
cat supabase/migrations/20260130000000_add_anon_insert_policy.sql

# Reset and verify schema
supabase db reset

# Test the policy
supabase db shell << 'EOF'
SET ROLE anon;

-- Should succeed: valid insert
INSERT INTO pickup_requests (sales_order_number, customer_email, status)
VALUES ('SO-VERIFY', 'verify@test.com', 'pending')
RETURNING id;

-- Should fail: trying to set priority
INSERT INTO pickup_requests (sales_order_number, customer_email, status, is_priority)
VALUES ('SO-FAIL1', 'fail@test.com', 'pending', true);

-- Should fail: wrong status
INSERT INTO pickup_requests (sales_order_number, customer_email, status)
VALUES ('SO-FAIL2', 'fail@test.com', 'approved');
EOF
```
</verification>

<success_criteria>
1. Migration file exists at correct path
2. `supabase db reset` applies without errors
3. Anonymous INSERT with valid fields succeeds
4. Anonymous INSERT attempting to set is_priority=true fails
5. Anonymous INSERT with non-pending status fails
6. Anonymous INSERT attempting to set assigned_gate_id fails
</success_criteria>

<output>
After completion, create `.planning/phases/07-customer-submission-flow/07-02-SUMMARY.md`
</output>
