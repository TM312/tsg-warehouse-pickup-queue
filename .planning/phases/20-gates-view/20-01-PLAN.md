---
phase: 20-gates-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staff/app/pages/gates.vue
  - staff/app/components/gates/GatesTable.vue
  - staff/app/composables/useGateManagement.ts
autonomous: true

must_haves:
  truths:
    - "Staff can access /gates route from sidebar"
    - "Staff can see all gates in a table with status, queue count, and processing order"
    - "Staff can create a new gate from the /gates page"
    - "Staff can enable/disable gates using toggle switch"
    - "Staff cannot disable a gate that has queued or processing orders"
    - "Staff can navigate to gate operator view via Open link"
  artifacts:
    - path: "staff/app/pages/gates.vue"
      provides: "Gates management page"
      contains: "GatesTable"
    - path: "staff/app/components/gates/GatesTable.vue"
      provides: "Table component with gate rows"
      contains: "TableHeader"
    - path: "staff/app/composables/useGateManagement.ts"
      provides: "Gate operations with proper status checks"
      contains: "PICKUP_STATUS.PROCESSING"
  key_links:
    - from: "staff/app/pages/gates.vue"
      to: "useGatesStore"
      via: "storeToRefs for gates data"
      pattern: "useGatesStore"
    - from: "staff/app/components/gates/GatesTable.vue"
      to: "/gate/[id]"
      via: "NuxtLink in Open button"
      pattern: "NuxtLink.*gate/"
    - from: "staff/app/composables/useGateManagement.ts"
      to: "pickup_requests table"
      via: "checking both IN_QUEUE and PROCESSING status"
      pattern: "\\.in\\(.*status.*PROCESSING"
---

<objective>
Create a dedicated /gates page where staff can view all gates in a table and manage them (create, enable/disable, navigate to gate operator view).

Purpose: Move gate management functionality from dashboard tabs to a dedicated page, providing better information density with table layout and clearer navigation structure.

Output: Working /gates route with table showing gate status, queue count, processing order, toggle switch, and Open link.
</objective>

<execution_context>
@/Users/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-gates-view/20-CONTEXT.md
@.planning/phases/20-gates-view/20-RESEARCH.md

# Existing components to reference
@staff/app/components/gates/GateManagement.vue
@staff/app/components/gates/CreateGateDialog.vue
@staff/app/composables/useGateManagement.ts
@staff/app/stores/gates.ts
@staff/app/stores/queue.ts
@staff/shared/types/gate.ts
@staff/shared/types/pickup-request.ts

# UI patterns
@staff/app/components/ui/table/index.ts
@staff/app/pages/index.vue
@staff/app/pages/settings/business-hours.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GatesTable component</name>
  <files>staff/app/components/gates/GatesTable.vue</files>
  <action>
Create a new GatesTable.vue component that displays gates in a table format.

**Structure:**
- Use shadcn Table/TableHeader/TableBody/TableRow/TableCell/TableHead components
- Props: gates (GateWithCount[]), processingOrders (PickupRequest[])
- Emits: toggle-active (gateId, isActive)

**Columns (in order):**
1. Gate - "Gate {gate_number}" as font-medium text
2. Status - Badge with conditional styling:
   - Active: `bg-green-500 text-white` with text "Active"
   - Inactive: `bg-gray-400 text-white` with text "Inactive"
3. Queue - Plain number showing queue_count
4. Processing - Show sales_order_number if gate has processing order, otherwise em dash "—"
5. Actions - Two elements side by side:
   - Switch for enable/disable (checked = is_active)
   - Button variant="outline" size="sm" with NuxtLink to `/gate/${gate.id}` text "Open"

**Processing order lookup:**
- Receive processingOrders as prop (filtered from parent)
- Use computed to create Map<gateId, PickupRequest> for O(1) lookup
- Display request.sales_order_number or "—"

**Switch behavior:**
- Emit toggle-active event on @update:checked
- Do NOT disable the switch in the component (parent handles validation)

**Sorting:**
- Use computed to sort gates by gate_number ascending

**Empty state:**
- If no gates, show TableRow with single TableCell spanning all columns
- Text: "No gates configured" with text-muted-foreground and py-8 text-center

**Pattern reference:** Follow structure from DataTable.vue but simpler (no TanStack, no column definitions)
  </action>
  <verify>
- File exists at staff/app/components/gates/GatesTable.vue
- Component uses Table components from @/components/ui/table
- Has props for gates and processingOrders
- Has emit for toggle-active
- Contains NuxtLink to /gate/ path
  </verify>
  <done>
GatesTable component renders gates in table format with all 5 columns, proper badge styling, processing order display, toggle switch, and Open link.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useGateManagement to check PROCESSING status</name>
  <files>staff/app/composables/useGateManagement.ts</files>
  <action>
Modify the toggleGateActive function to check for both IN_QUEUE and PROCESSING orders before allowing disable.

**Current code (line ~45-55):**
```typescript
if (!isActive) {
  const { count } = await client
    .from('pickup_requests')
    .select('id', { count: 'exact', head: true })
    .eq('assigned_gate_id', gateId)
    .eq('status', PICKUP_STATUS.IN_QUEUE)
```

**Updated code:**
```typescript
if (!isActive) {
  const { count } = await client
    .from('pickup_requests')
    .select('id', { count: 'exact', head: true })
    .eq('assigned_gate_id', gateId)
    .in('status', [PICKUP_STATUS.IN_QUEUE, PICKUP_STATUS.PROCESSING])
```

**Also update the error message** to be more informative (per CONTEXT.md requirement for "specific count and clear action guidance"):
```typescript
if (count && count > 0) {
  toast.error(`Cannot disable gate with ${count} active order${count > 1 ? 's' : ''}. Reassign or complete them first.`)
  return false
}
```

This ensures:
1. Gates with processing orders cannot be disabled
2. Error message includes count and action guidance
  </action>
  <verify>
- grep for ".in('status'" in useGateManagement.ts shows the updated query
- grep for "PROCESSING" in useGateManagement.ts confirms the status is checked
- Error message includes count variable
  </verify>
  <done>
useGateManagement.toggleGateActive checks both IN_QUEUE and PROCESSING statuses before allowing disable, with informative error message.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create gates.vue page</name>
  <files>staff/app/pages/gates.vue</files>
  <action>
Create the /gates page that displays the GatesTable and provides gate management functionality.

**Page structure:**
```vue
<script setup lang="ts">
definePageMeta({
  middleware: 'auth'
})

// Stores
const gatesStore = useGatesStore()
const queueStore = useQueueStore()
const { gates } = storeToRefs(gatesStore)
const { processingItems } = storeToRefs(queueStore)

// Gate management
const { createGate, toggleGateActive, pending } = useGateManagement()

// Handler for create - CreateGateDialog emits gate number
async function handleCreate(gateNumber: number) {
  await createGate(gateNumber)
}

// Handler for toggle - GatesTable emits gateId and desired state
async function handleToggleActive(gateId: string, isActive: boolean) {
  await toggleGateActive(gateId, isActive)
}
</script>
```

**Template structure:**
```vue
<template>
  <div>
    <!-- Header matching dashboard pattern -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Gates</h1>
      <CreateGateDialog @create="handleCreate" />
    </div>

    <!-- Table -->
    <GatesTable
      :gates="gates"
      :processing-orders="processingItems"
      @toggle-active="handleToggleActive"
    />
  </div>
</template>
```

**Key points:**
- Uses auth middleware (matches other pages)
- Accesses both gates and queue stores
- processingItems from queue store provides processing orders
- CreateGateDialog is reused as-is
- GatesTable handles display, page handles actions
- No extra loading states needed - stores are populated by app.vue on mount
  </action>
  <verify>
- File exists at staff/app/pages/gates.vue
- Has definePageMeta with auth middleware
- Uses useGatesStore and useQueueStore
- Has CreateGateDialog in header
- Has GatesTable with props and event handler
- Visit http://localhost:3000/gates shows the page (when running)
  </verify>
  <done>
/gates page renders with header, create gate button, and table of all gates with management functionality.
  </done>
</task>

</tasks>

<verification>
Run the following to verify the implementation:

1. **Type check:**
   ```bash
   cd staff && npm run typecheck
   ```
   Should pass with no new errors (pre-existing errors in native-select are known).

2. **Dev server test (manual):**
   - Start dev server: `cd staff && npm run dev`
   - Navigate to http://localhost:3000/gates
   - Verify table shows with correct columns
   - Verify gates display with status badges (green/gray)
   - Verify queue count shows correctly
   - Verify processing column shows order ID or "—"
   - Verify "Open" link navigates to /gate/[id]
   - Verify toggle switch works for enable/disable
   - Test disabling gate with orders shows error toast

3. **Component check:**
   ```bash
   ls -la staff/app/components/gates/GatesTable.vue
   ls -la staff/app/pages/gates.vue
   ```
</verification>

<success_criteria>
1. /gates route is accessible and renders correctly
2. All gates appear in table with correct columns
3. Status badges show correct colors (green=active, gray=inactive)
4. Processing column shows sales_order_number or em dash
5. Open link navigates to gate operator view
6. Toggle switch enables/disables gates
7. Cannot disable gate with queued or processing orders (error toast shown)
8. Create gate dialog works from the page
9. Type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-gates-view/20-01-SUMMARY.md`
</output>
